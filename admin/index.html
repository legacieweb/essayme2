<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tutor Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <style>
    .status-pending { background-color: #fef3c7; color: #92400e; }
    .status-under-review { background-color: #dbeafe; color: #1e40af; }
    .status-checking-balance { background-color: #fecaca; color: #991b1b; }
    .status-assigned { background-color: #d1fae5; color: #065f46; }
    .status-in-progress { background-color: #e0e7ff; color: #3730a3; }
    .status-completed { background-color: #dcfce7; color: #166534; }
    .status-cancelled { background-color: #f3f4f6; color: #6b7280; }
    
    .sidebar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    /* Modal Animations */
    @keyframes modal-pop {
      0% { transform: scale(0.9) opacity(0); }
      100% { transform: scale(1) opacity(1); }
    }
    .modal-content {
      animation: modal-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-backdrop {
      transition: opacity 0.3s ease;
    }

    /* Cool Toast/Notification */
    .cool-toast {
      animation: toast-slide 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    @keyframes toast-slide {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .toast-exit {
      animation: toast-exit 0.5s forwards;
    }
    @keyframes toast-exit {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }

    /* Bottom nav for mobile like student.html */
    .tutor-bottom-nav { display: none; }
    @media (max-width: 1023px) {
      .tutor-bottom-nav { display: flex; }
    }
  </style>
</head>

<body class="bg-gray-100 font-sans">

<!-- Bottom Navigation for small screens -->
<nav class="tutor-bottom-nav fixed bottom-0 left-0 right-0 bg-gray-800 text-white justify-around items-center p-2 lg:hidden z-20">
  <button onclick="showSection('overview', event)" class="flex flex-col items-center">
    <i class="fas fa-home text-xl"></i>
  </button>
  <button onclick="showSection('assignments', event)" class="flex flex-col items-center">
    <i class="fas fa-tasks text-xl"></i>
  </button>
  <button onclick="showSection('students', event)" class="flex flex-col items-center">
    <i class="fas fa-users text-xl"></i>
  </button>
  <button onclick="showSection('payments', event)" class="flex flex-col items-center">
    <i class="fas fa-credit-card text-xl"></i>
  </button>
  <button onclick="showSection('chat', event)" class="flex flex-col items-center relative">
    <i class="fas fa-comments text-xl"></i>
    <span id="tutor-chat-badge-mobile" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
  </button>
</nav>
  
  <!-- Sidebar -->
  <!-- <audio id="tutor-update-audio" src="audio/notify.mp3" preload="auto"></audio> -->

  <div class="sidebar hidden lg:block fixed left-0 top-0 h-full w-64 text-white p-6 shadow-lg">
    <div class="mb-8">
      <h1 class="text-2xl font-bold">Tutor Dashboard</h1>
      <p class="text-blue-200 text-sm">Manage assignments & students</p>
    </div>
    
    <nav class="space-y-2" id="tutor-sidebar-nav">
      <a href="#" onclick="showSection('overview', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link active">
        <i class="fas fa-home"></i>
        <span>Overview</span>
      </a>
      <a href="#" onclick="showSection('assignments', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link">
        <i class="fas fa-tasks"></i>
        <span>Assignments</span>
        <span id="tutor-assignments-badge" class="ml-auto bg-gradient-to-r from-orange-400 via-orange-500 to-rose-500 text-white text-xs font-semibold rounded-full px-2 py-0.5 shadow hidden">0</span>
      </a>
      <a href="#" onclick="showSection('students', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link">
        <i class="fas fa-users"></i>
        <span>Students</span>
        <span id="tutor-students-badge" class="ml-auto bg-gradient-to-r from-emerald-400 via-green-500 to-teal-500 text-white text-xs font-semibold rounded-full px-2 py-0.5 shadow hidden">0</span>
      </a>
      <a href="#" onclick="showSection('payments', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link">
        <i class="fas fa-credit-card"></i>
        <span>Payment Approvals</span>
        <span id="tutor-payments-badge" class="ml-auto bg-gradient-to-r from-purple-400 via-purple-500 to-fuchsia-500 text-white text-xs font-semibold rounded-full px-2 py-0.5 shadow hidden">0</span>
      </a>
      <a href="#" onclick="showSection('coupons', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link">
        <i class="fas fa-ticket-alt"></i>
        <span>Coupons & Discounts</span>
      </a>
      <a href="#" onclick="showSection('chat', event)" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-white hover:bg-opacity-20 transition duration-200 nav-link relative" id="tutor-chat-nav">
        <i class="fas fa-comments"></i>
        <span>Chat</span>
        <span id="tutor-chat-badge" class="ml-auto bg-red-600 text-white text-xs rounded-full px-2 py-0.5 hidden">0</span>
      </a>
    </nav>
    
    <div class="hidden lg:block absolute bottom-6 left-6 right-6">
      <div class="bg-white bg-opacity-20 rounded-lg p-4">
        <div class="flex items-center space-x-3">
          <div id="adminProfileAvatar" class="w-10 h-10 bg-white bg-opacity-30 rounded-full flex items-center justify-center overflow-hidden">
            <i class="fas fa-user text-white"></i>
          </div>
          <div>
            <p class="font-semibold" id="tutorName">Tutor</p>
            <p class="text-blue-200 text-sm">Administrator</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="p-4 pt-6 pb-24 lg:pt-8 lg:pb-8 lg:ml-64 lg:p-8">
    
    <!-- Overview Section -->
    <section id="overview" class="space-y-6">
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">Dashboard Overview</h2>
        <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200">
          <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
      </div>
      
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
        <!-- Chat Summary Card (optional) -->
        <div class="bg-white p-6 rounded-lg shadow card-hover transition duration-300 col-span-1 md:col-span-2">
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-semibold text-gray-800">Student Chats</h3>
            <button onclick="showSection('chat')" class="px-3 py-2 bg-blue-600 text-white rounded">Open Chat</button>
          </div>
          <p class="text-sm text-gray-600 mt-2">View and reply to messages in the dedicated Chat section.</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow card-hover transition duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Total Assignments</p>
              <p class="text-2xl font-bold text-gray-800" id="totalAssignments">0</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-tasks text-blue-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow card-hover transition duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Pending Review</p>
              <p class="text-2xl font-bold text-orange-600" id="pendingReview">0</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-full">
              <i class="fas fa-clock text-orange-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow card-hover transition duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Active Students</p>
              <p class="text-2xl font-bold text-green-600" id="activeStudents">0</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <i class="fas fa-users text-green-600 text-xl"></i>
            </div>
          </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow card-hover transition duration-300">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">Pending Payments</p>
              <p class="text-2xl font-bold text-purple-600" id="pendingPayments">0</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
              <i class="fas fa-credit-card text-purple-600 text-xl"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Recent Activity -->
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Activity</h3>
        <div id="recentActivity" class="space-y-3">
          <!-- Activity items will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Assignments Section -->
    <section id="assignments" class="space-y-6 hidden">
      <!-- Mobile filter placement -->
      <div class="lg:hidden">
        <label class="block text-sm text-gray-600 mb-1">Filter status</label>
        <select id="statusFilterMobile" class="w-full border rounded-lg px-3 py-2">
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="under-review">Under Review</option>
          <option value="checking-balance">Checking Balance</option>
          <option value="assigned">Assigned</option>
          <option value="in-progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">Assignments Management</h2>
        <div class="flex space-x-2">
          <select id="statusFilter" onchange="filterAssignments()" class="border rounded-lg px-3 py-2">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="under-review">Under Review</option>
            <option value="checking-balance">Checking Balance</option>
            <option value="assigned">Assigned</option>
            <option value="in-progress">In Progress</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>
      
      <div id="assignmentsList" class="space-y-4">
        <!-- Assignments will be loaded here -->
      </div>
    </section>

    <!-- Students Section -->
    <section id="students" class="space-y-6 hidden">
      <!-- Mobile helper text -->
      <p class="lg:hidden text-sm text-gray-500">Scroll horizontally to see more cards.</p>
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">Students Management</h2>
      </div>
      
      <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Students will be loaded here -->
      </div>
    </section>

    <!-- Payments Section -->
    <section id="payments" class="space-y-6 hidden">
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">Payment Approvals</h2>
      </div>
      
      <div id="paymentsList" class="space-y-4">
        <!-- Pending payments will be loaded here -->
      </div>
    </section>

    <!-- Coupons Section -->
    <section id="coupons" class="space-y-6 hidden">
      <div class="flex justify-between items-center">
        <h2 class="text-3xl font-bold text-gray-800">Coupons & Discounts</h2>
        <button onclick="openCouponModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200">
          <i class="fas fa-plus mr-2"></i>Create Coupon
        </button>
      </div>
      
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-gray-800">Active Coupons</h3>
          <div class="flex space-x-2">
            <input type="text" id="couponSearch" placeholder="Search coupons..." 
                   class="border rounded-lg px-3 py-2 w-64" oninput="searchCoupons()">
            <select id="couponStatusFilter" onchange="filterCoupons()" class="border rounded-lg px-3 py-2">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </div>
        
        <div id="couponsList" class="space-y-4">
          <!-- Coupons will be loaded here -->
        </div>
      </div>
    </section>

    <!-- Chat Section -->
    <section id="chat" class="space-y-6 hidden">
      <h2 class="text-3xl font-bold text-gray-800">Student Chats</h2>
      
      <!-- Step 1: Students (avatars) -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Students</div>
          <div class="text-xs text-gray-500" id="tutor-chat-selected-student-label">Select a student</div>
        </div>
        <div id="tutor-chat-students" class="flex gap-4 overflow-x-auto pb-2">
          <!-- Avatars inserted here -->
        </div>
      </div>

      <!-- Step 2: Assignments for selected student -->
      <div id="tutor-chat-assignments-wrap" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-medium">Assignments for <span id="tutor-chat-student-name" class="font-semibold">-</span></div>
          <button class="text-xs text-blue-600 hover:underline" onclick="resetChatSteps()">Change student</button>
        </div>
        <div id="tutor-chat-assignments-for-student" class="flex gap-2 overflow-x-auto pb-2"></div>
        <div class="text-xs text-gray-500">Tap an assignment to open chat</div>
      </div>

      <!-- Desktop helper (optional) -->
      <div class="hidden lg:block text-sm text-gray-500">Tip: Use the flow above to open chat in a popup.</div>

      <!-- <audio id="tutor-new-message-audio" src="audio/receive.mp3" preload="auto"></audio>
      <audio id="tutor-send-audio" src="audio/send.mp3" preload="auto"></audio> -->
    </section>
  </div>

  <!-- Tutor Chat Modal (popup when assignment clicked) -->
  <div id="tutorChatModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300">
    <div class="bg-white rounded-2xl w-full max-w-2xl mx-4 shadow-2xl modal-content">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <div>
          <div class="text-sm text-gray-500">Chatting about</div>
          <div id="tutor-chat-modal-title" class="font-semibold">-</div>
        </div>
        <button onclick="closeTutorChatModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-4">
        <div id="tutor-chat-history-modal" class="bg-gray-50 border rounded p-3 h-96 overflow-y-auto space-y-2"></div>
        <div class="mt-2 flex items-center">
          <input id="tutor-chat-input-modal" class="flex-1 border rounded p-2" placeholder="Type a message..." />
          <button id="tutor-send-modal" class="ml-2 px-3 py-2 bg-blue-600 text-white rounded">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Details Modal -->
  <div id="assignmentModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300">
    <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">Assignment Details</h3>
        <button onclick="closeAssignmentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="assignmentDetails">
        <!-- Assignment details will be loaded here -->
      </div>
    </div>
  </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300">
      <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl modal-content">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800" id="couponModalTitle">Create Coupon</h3>
          <button onclick="closeCouponModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <form id="couponForm" onsubmit="saveCoupon(event)">
          <input type="hidden" id="couponId">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code *</label>
              <input type="text" id="couponCode" required class="w-full border rounded-lg px-3 py-2" 
                     placeholder="e.g., SUMMER2024">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Discount Type *</label>
              <select id="couponDiscountType" required class="w-full border rounded-lg px-3 py-2">
                <option value="percentage">Percentage (%)</option>
                <option value="fixed">Fixed Amount ($)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Discount Value *</label>
              <input type="number" id="couponDiscountValue" required min="0" step="0.01" 
                     class="w-full border rounded-lg px-3 py-2" placeholder="10">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Minimum Order Value</label>
              <input type="number" id="couponMinOrder" min="0" step="0.01" 
                     class="w-full border rounded-lg px-3 py-2" placeholder="0">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Usage</label>
              <input type="number" id="couponMaxUsage" min="1" 
                     class="w-full border rounded-lg px-3 py-2" placeholder="Unlimited">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
              <select id="couponIsActive" class="w-full border rounded-lg px-3 py-2">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Onsite Discount (Auto-apply)</label>
              <select id="couponIsAuto" class="w-full border rounded-lg px-3 py-2">
                <option value="false">Manual Code</option>
                <option value="true">Auto-apply (Onsite)</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
              <input type="datetime-local" id="couponStartDate" 
                     class="w-full border rounded-lg px-3 py-2">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
              <input type="datetime-local" id="couponEndDate" 
                     class="w-full border rounded-lg px-3 py-2">
            </div>
          </div>
          
          <div class="flex space-x-3 mt-6">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
              <i class="fas fa-save mr-2"></i>Save Coupon
            </button>
            <button type="button" onclick="closeCouponModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

   <!-- File Upload Modal -->
   <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800">Upload Completed Files</h3>
        <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="hidden" id="uploadAssignmentId" name="assignmentId">
        <input type="hidden" id="uploadTutorId" name="tutorId" value="">
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select Files</label>
          <input type="file" id="completedFiles" name="files" multiple accept=".pdf,.doc,.docx,.txt,.zip,.rar" 
                 class="w-full border border-gray-300 rounded-lg p-2">
          <p class="text-xs text-gray-500 mt-1">Supported formats: PDF, DOC, DOCX, TXT, ZIP, RAR</p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Comments (Optional)</label>
          <textarea id="tutorComments" name="comments" rows="3" 
                    class="w-full border border-gray-300 rounded-lg p-2" 
                    placeholder="Add any comments for the student..."></textarea>
        </div>
        
        <div class="flex space-x-3">
          <button type="submit" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
            <i class="fas fa-upload mr-2"></i>Upload & Complete
          </button>
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  </div>

  <!-- Student Details Modal -->
  <div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden transition-all duration-300">
    <div class="bg-white rounded-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto shadow-2xl modal-content">
      <div class="flex items-center justify-between px-6 py-4 border-b sticky top-0 bg-white">
        <h3 class="text-xl font-bold text-gray-800">Student Details</h3>
        <button onclick="closeStudentDetailsModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-6">
        <div id="studentDetailContent" class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Profile info -->
          <div class="md:col-span-1 space-y-6">
            <div class="flex flex-col items-center">
              <div id="studentDetailAvatar" class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-user text-blue-600 text-4xl"></i>
              </div>
              <h4 id="studentDetailName" class="text-xl font-bold text-gray-800">Name</h4>
              <p id="studentDetailEmail" class="text-gray-500">Email</p>
              <div id="studentSuspendedBadge" class="mt-2 hidden">
                <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase">Suspended</span>
              </div>
            </div>
            
            <div class="space-y-3 pt-4 border-t">
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Wallet Balance:</span>
                <span id="studentDetailBalance" class="font-bold text-green-600">$0.00</span>
              </div>
              
              <!-- Adjust Balance UI -->
              <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 space-y-2">
                <p class="text-[10px] font-bold text-blue-800 uppercase tracking-wider">Adjust Balance (Recover Money)</p>
                <div class="flex gap-2">
                  <input type="number" id="adjustBalanceAmount" placeholder="New amount" class="w-full px-2 py-1 text-sm border rounded">
                  <button onclick="adjustBalance(event)" class="px-3 py-1 bg-blue-600 text-white text-xs rounded font-bold hover:bg-blue-700">Set</button>
                </div>
                <input type="text" id="adjustBalanceReason" placeholder="Reason (optional)" class="w-full px-2 py-1 text-[10px] border rounded">
              </div>

              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Member Since:</span>
                <span id="studentDetailJoined" class="font-medium text-gray-700">-</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Last Login:</span>
                <span id="studentDetailLastLogin" class="font-medium text-gray-700">-</span>
              </div>
            </div>
            
            <div class="pt-4 border-t space-y-2">
              <button id="suspendBtn" onclick="toggleStudentSuspension()" class="w-full px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition">
                Suspend Account
              </button>
              <button onclick="confirmDeleteStudent()" class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">
                Delete Account
              </button>
            </div>
          </div>
          
          <!-- Assignments list -->
          <div class="md:col-span-2">
            <h5 class="font-bold text-gray-800 mb-4 flex items-center">
              <i class="fas fa-book mr-2"></i>Assignments
            </h5>
            <div id="studentDetailAssignments" class="space-y-4">
              <!-- Assignments will be loaded here -->
              <p class="text-gray-500 text-sm">Loading assignments...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3002';

    // Helper for authenticated fetches
    async function fetchWithAuth(url, options = {}) {
      const email = localStorage.getItem('userEmail');
      if (!email) {
        console.warn('No user email found in localStorage, redirecting to login');
        window.location.href = '../index.html?auth=login';
        return new Promise(() => {}); // Stop execution
      }
      const headers = {
        ...options.headers,
        'X-User-Email': email
      };
      if (options.body && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
      }
      const response = await fetch(url, { ...options, headers });
      
      // Handle suspension or account deletion
      if (response.status === 401 || response.status === 403 || response.status === 404) {
          const data = await response.clone().json().catch(() => ({}));
          if (data.error && (data.error.includes('suspended') || data.error.includes('found'))) {
              localStorage.clear();
              window.location.href = '../index.html?error=' + encodeURIComponent(data.error);
              return new Promise(() => {}); // Stop further execution
          }
      }
      return response;
    }

    function getImageUrl(path) {
      if (!path) return null;
      if (path.startsWith('data:image')) return path; // Base64 direct support
      if (path.startsWith('http')) return path;
      if (path.startsWith('/uploads/')) return `${API_BASE}${path}`;
      if (path.startsWith('uploads/')) return `${API_BASE}/${path}`;
      return `${API_BASE}/uploads/${path}`;
    }

    let currentAssignments = [];
    let currentStudents = [];
    let currentPayments = [];
    const sidebarBadgeData = { assignments: [], students: [], payments: [] };
    const sidebarBadgeKeys = { assignments: 'tutorSeenAssignmentsIds', students: 'tutorSeenStudentsIds', payments: 'tutorSeenPaymentsIds' };
    const sidebarBadgePreviousCounts = { assignments: 0, students: 0, payments: 0 };
    let sidebarBadgesInitialized = false;

    function getSeenIds(section){
      const key = sidebarBadgeKeys[section];
      if(!key) return new Set();
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return new Set();
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed)) return new Set(parsed.map(String));
      }catch(_){ }
      return new Set();
    }

    function setSeenIds(section, ids){
      const key = sidebarBadgeKeys[section];
      if(!key) return;
      try{
        const unique = Array.from(new Set((ids||[]).map(String)));
        localStorage.setItem(key, JSON.stringify(unique));
      }catch(_){ }
    }

    function computeNewCount(section){
      const seen = getSeenIds(section);
      const ids = sidebarBadgeData[section] || [];
      let count = 0;
      ids.forEach(id => { if(id && !seen.has(id)) count += 1; });
      return count;
    }

    function applyBadge(badgeEl, count){
      if(!badgeEl) return;
      if(count>0){
        badgeEl.textContent = count>99 ? '99+' : String(count);
        badgeEl.classList.remove('hidden');
      } else {
        badgeEl.classList.add('hidden');
      }
    }

    function refreshSidebarBadges(options = {}){
      const playSound = options.playSound !== false;
      const sections = ['assignments', 'students', 'payments'];
      const shouldSound = sidebarBadgesInitialized && playSound;
      sections.forEach(section => {
        const count = computeNewCount(section);
        const badgeEl = document.getElementById(`tutor-${section}-badge`);
        applyBadge(badgeEl, count);
        if (shouldSound && count > (sidebarBadgePreviousCounts[section] || 0) && count > 0) {
          const audio = document.getElementById('tutor-update-audio');
          audio?.play?.().catch(()=>{});
        }
        sidebarBadgePreviousCounts[section] = count;
      });
      sidebarBadgesInitialized = true;
    }

    function markSidebarSectionSeen(section){
      setSeenIds(section, sidebarBadgeData[section] || []);
      sidebarBadgePreviousCounts[section] = 0;
      refreshSidebarBadges({ playSound: false });
    }

    // Coupon Management Functions
    async function loadCoupons() {
      try {
        const response = await fetchWithAuth(`${API_BASE}/api/admin/coupons`);
        const data = await response.json();
        
        if (data.coupons) {
          displayCoupons(data.coupons);
        }
      } catch (error) {
        console.error('Error loading coupons:', error);
        showMessage('Failed to load coupons. Please try again.', 'error');
      }
    }
    
    function displayCoupons(coupons) {
      const container = document.getElementById('couponsList');
      
      if (coupons.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <i class="fas fa-ticket-alt text-4xl mb-4"></i>
            <p>No coupons created yet. Create your first coupon to get started.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = coupons.map(coupon => `
        <div class="border rounded-lg p-4 hover:shadow-md transition">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center space-x-4 mb-2">
                <span class="font-bold text-lg">${coupon.code}</span>
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-sm">
                  ${coupon.discount_type === 'percentage' ? coupon.discount_value + '%' : '$' + coupon.discount_value}
                </span>
                <span class="px-2 py-1 rounded-full text-sm ${
                  coupon.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                }">
                  ${coupon.is_active ? 'Active' : 'Inactive'}
                </span>
                ${coupon.is_auto ? `
                  <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-sm">
                    <i class="fas fa-magic mr-1"></i>Auto-apply (Onsite)
                  </span>
                ` : ''}
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <p class="text-sm text-gray-600">Minimum Order:</p>
                  <p class="font-medium">$${Number(coupon.minimum_order_value || 0).toFixed(2)}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Usage:</p>
                  <p class="font-medium">${coupon.used_count} / ${coupon.max_usage || 'Unlimited'}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">Start Date:</p>
                  <p class="font-medium">${formatDate(coupon.start_date)}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-600">End Date:</p>
                  <p class="font-medium">${coupon.end_date ? formatDate(coupon.end_date) : 'Never'}</p>
                </div>
              </div>
            </div>
            
            <div class="flex space-x-2">
              <button onclick="editCoupon(${coupon.id})" class="p-2 text-blue-600 hover:bg-blue-100 rounded">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteCoupon(${coupon.id})" class="p-2 text-red-600 hover:bg-red-100 rounded">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function openCouponModal() {
      document.getElementById('couponModalTitle').textContent = 'Create Coupon';
      document.getElementById('couponForm').reset();
      document.getElementById('couponId').value = '';
      document.getElementById('couponIsActive').value = 'true';
      document.getElementById('couponModal').classList.remove('hidden');
    }
    
    function closeCouponModal() {
      document.getElementById('couponModal').classList.add('hidden');
    }
    
    async function saveCoupon(event) {
      event.preventDefault();
      
      const couponId = document.getElementById('couponId').value;
      const data = {
        code: document.getElementById('couponCode').value,
        discountType: document.getElementById('couponDiscountType').value,
        discountValue: parseFloat(document.getElementById('couponDiscountValue').value),
        minimumOrderValue: parseFloat(document.getElementById('couponMinOrder').value || 0),
        maxUsage: document.getElementById('couponMaxUsage').value ? parseInt(document.getElementById('couponMaxUsage').value) : null,
        isActive: document.getElementById('couponIsActive').value === 'true',
        isAuto: document.getElementById('couponIsAuto').value === 'true',
        startDate: document.getElementById('couponStartDate').value,
        endDate: document.getElementById('couponEndDate').value
      };
      
      try {
        const method = couponId ? 'PUT' : 'POST';
        const url = couponId ? `${API_BASE}/api/admin/coupons/${couponId}` : `${API_BASE}/api/admin/coupons`;
        
        const response = await fetchWithAuth(url, {
          method,
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeCouponModal();
          loadCoupons();
          showMessage(couponId ? 'Coupon updated successfully!' : 'Coupon created successfully!', 'success');
        } else {
          showMessage(result.error || 'Failed to save coupon.', 'error');
        }
      } catch (error) {
        console.error('Error saving coupon:', error);
        showMessage('Failed to save coupon. Please try again.', 'error');
      }
    }
    
    async function editCoupon(id) {
      try {
        const response = await fetchWithAuth(`${API_BASE}/api/admin/coupons`);
        const data = await response.json();
        const coupon = data.coupons.find(c => c.id === id);
        
        if (coupon) {
          document.getElementById('couponModalTitle').textContent = 'Edit Coupon';
          document.getElementById('couponId').value = coupon.id;
          document.getElementById('couponCode').value = coupon.code;
          document.getElementById('couponDiscountType').value = coupon.discount_type;
          document.getElementById('couponDiscountValue').value = coupon.discount_value;
          document.getElementById('couponMinOrder').value = coupon.minimum_order_value;
          document.getElementById('couponMaxUsage').value = coupon.max_usage || '';
          document.getElementById('couponIsActive').value = coupon.is_active ? 'true' : 'false';
          document.getElementById('couponIsAuto').value = coupon.is_auto ? 'true' : 'false';
          document.getElementById('couponStartDate').value = formatDateTimeLocal(coupon.start_date);
          document.getElementById('couponEndDate').value = coupon.end_date ? formatDateTimeLocal(coupon.end_date) : '';
          document.getElementById('couponModal').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading coupon:', error);
        showMessage('Failed to load coupon details.', 'error');
      }
    }
    
    async function deleteCoupon(id) {
      const confirmed = await showConfirm(
        'Delete Coupon',
        'Are you sure you want to delete this coupon? This action cannot be undone.',
        { type: 'danger', confirmText: 'Delete' }
      );
      if (!confirmed) return;
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/api/admin/coupons/${id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          loadCoupons();
          showMessage('Coupon deleted successfully!', 'success');
        } else {
          showMessage(result.error || 'Failed to delete coupon.', 'error');
        }
      } catch (error) {
        console.error('Error deleting coupon:', error);
        showMessage('Failed to delete coupon. Please try again.', 'error');
      }
    }
    
    function searchCoupons() {
      const searchTerm = document.getElementById('couponSearch').value.toLowerCase();
      filterCoupons(searchTerm);
    }
    
    function filterCoupons(searchTerm = '') {
      const statusFilter = document.getElementById('couponStatusFilter').value;
      
      fetchWithAuth(`${API_BASE}/api/admin/coupons`)
        .then(response => response.json())
        .then(data => {
          let filtered = data.coupons;
          
          if (statusFilter !== 'all') {
            filtered = filtered.filter(coupon => 
              statusFilter === 'active' ? coupon.is_active : !coupon.is_active
            );
          }
          
          if (searchTerm) {
            filtered = filtered.filter(coupon => 
              coupon.code.toLowerCase().includes(searchTerm)
            );
          }
          
          displayCoupons(filtered);
        });
    }
    
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function formatDateTimeLocal(dateString) {
      const date = new Date(dateString);
      return date.toISOString().slice(0, 16);
    }
    
    function showConfirm(title, message, options = {}) {
      const { 
        confirmText = 'Confirm', 
        cancelText = 'Cancel', 
        type = 'warning',
        showInput = false,
        placeholder = '',
        inputValue = ''
      } = options;

      return new Promise((resolve) => {
        const modalId = 'confirm-modal-' + Date.now();
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in';
        
        const colors = {
          warning: 'text-yellow-500 bg-yellow-50',
          danger: 'text-red-500 bg-red-50',
          info: 'text-blue-500 bg-blue-50'
        };

        const icons = {
          warning: 'fa-exclamation-triangle',
          danger: 'fa-trash-alt',
          info: 'fa-info-circle'
        };

        const colorClass = colors[type] || colors.warning;
        const iconClass = icons[type] || icons.warning;

        modal.innerHTML = `
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
            <div class="p-6 text-center">
              <div class="w-16 h-16 ${colorClass} rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas ${iconClass} text-2xl"></i>
              </div>
              <h3 class="text-xl font-bold text-gray-900 mb-2">${title}</h3>
              <p class="text-gray-600 mb-6">${message}</p>
              
              ${showInput ? `
                <div class="mb-6">
                  <input type="text" id="${modalId}-input" 
                    class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                    placeholder="${placeholder}" value="${inputValue}">
                </div>
              ` : ''}
              
              <div class="flex space-x-3">
                <button id="${modalId}-cancel" class="flex-1 px-4 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors">
                  ${cancelText}
                </button>
                <button id="${modalId}-confirm" class="flex-1 px-4 py-3 rounded-xl ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-semibold transition-colors shadow-lg shadow-blue-500/30">
                  ${confirmText}
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        const input = modal.querySelector('input');
        if (input) {
          setTimeout(() => input.focus(), 100);
          input.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') confirmBtn.click();
          });
        }

        const confirmBtn = document.getElementById(`${modalId}-confirm`);
        const cancelBtn = document.getElementById(`${modalId}-cancel`);

        confirmBtn.onclick = () => {
          const value = input ? input.value : true;
          modal.classList.add('animate-fade-out');
          setTimeout(() => {
            modal.remove();
            resolve(value);
          }, 300);
        };

        cancelBtn.onclick = () => {
          modal.classList.add('animate-fade-out');
          setTimeout(() => {
            modal.remove();
            resolve(null);
          }, 300);
        };

        modal.onclick = (e) => {
          if (e.target === modal) cancelBtn.click();
        };
      });
    }

    function showMessage(message, type = 'info') {
      // Remove existing toast
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.classList.add('toast-exit');
        setTimeout(() => existingToast.remove(), 500);
      }
      
      // Create new toast
      const toast = document.createElement('div');
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
      };
      const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-blue-600',
        warning: 'bg-yellow-600'
      };

      toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-xl shadow-2xl z-[100] cool-toast flex items-center space-x-3 text-white font-medium ${colors[type] || colors.info} toast`;
      
      toast.innerHTML = `
        <i class="fas ${icons[type] || icons.info} text-xl"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Remove toast after 4 seconds
      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.add('toast-exit');
          setTimeout(() => toast.remove(), 500);
        }
      }, 4000);
    }

     // Initialize dashboard
     document.addEventListener('DOMContentLoaded', function() {
      loadTutorProfile();
      loadOverviewData();
      loadAssignments();
      loadStudents();
      loadPendingPayments();
      
      // init unread map
      window.tutorUnread = new Map(); // assignmentId -> count

      // Set up periodic refresh for real-time updates
      setInterval(() => {
        loadOverviewData();
        loadAssignments();
        loadPendingPayments();
        loadTutorChatStudents();
        refreshTutorUnreadCounts();
        if(tutorActiveAssignment) loadTutorMessages();
      }, 15000); // Refresh every 15 seconds

      // Chat modal init
      document.getElementById('tutor-send-modal').addEventListener('click', tutorSendMessageModal);
      document.getElementById('tutor-chat-input-modal').addEventListener('input', toggleTutorSendButtonModal);
      toggleTutorSendButtonModal();

      // Load chat students first step
      loadTutorChatStudents();
      // Prime unread counts immediately on load
      refreshTutorUnreadCounts();
    });

    // Unread helpers for Tutor
    async function updateTutorSidebarBadge(){
      const total = Array.from(window.tutorUnread?.values()||[]).reduce((a,b)=>a+b,0);
      const el = document.getElementById('tutor-chat-badge');
      const elMobile = document.getElementById('tutor-chat-badge-mobile');
      if(el){
        if(total>0){ el.textContent = String(total); el.classList.remove('hidden'); }
        else { el.classList.add('hidden'); }
      }
      if(elMobile){
        if(total>0){ elMobile.textContent = String(total); elMobile.classList.remove('hidden'); }
        else { elMobile.classList.add('hidden'); }
      }
      // Also update per-student badges by aggregating assignment-level unread counts
      try {
        const container = document.getElementById('tutor-chat-students');
        if (!container) return;
        const studentButtons = Array.from(container.querySelectorAll('button[data-stu-id]'));
        // Build a map studentId -> unreadCount
        const assignments = Array.from(window.tutorUnread?.keys()||[]);
        const studentUnreadMap = new Map();
        // We need the mapping of assignment -> student. Fetch quickly if we have none loaded
        // Use cached assignments from the assignments section if available
        const cached = window.currentAssignments || [];
        const mapAssignToStudent = new Map();
        cached.forEach(a => {
          const sid = a && a.userId ? (a.userId.id || a.userId._id || a.userId) : null;
          if (a && a.id && sid) mapAssignToStudent.set(String(a.id), String(sid));
        });
        // If no assignments cached yet, fetch once to build the map
        if (mapAssignToStudent.size === 0) {
          try {
            const res = await fetchWithAuth(`${API_BASE}/tutor/assignments`);
            const data = await res.json();
            const arr = Array.isArray(data.assignments) ? data.assignments : [];
            arr.forEach(a => {
              const sid = a && a.userId ? (a.userId.id || a.userId._id || a.userId) : null;
              if (a && a.id && sid) mapAssignToStudent.set(String(a.id), String(sid));
            });
          } catch(_) { /* ignore */ }
        }
        assignments.forEach(aid => {
          const count = window.tutorUnread.get(aid) || 0;
          const sid = mapAssignToStudent.get(String(aid));
          if (!sid || count<=0) return;
          studentUnreadMap.set(sid, (studentUnreadMap.get(sid)||0) + count);
        });
        studentButtons.forEach(btn => {
          const sid = String(btn.dataset.stuId);
          const count = studentUnreadMap.get(sid) || 0;
          const badge = btn.querySelector('.student-unread-badge');
          if (!badge) return;
          if (count>0) { badge.textContent = String(count); badge.classList.remove('hidden'); }
          else { badge.classList.add('hidden'); }
        });
      } catch(_) { /* ignore */ }
    }
    function updateTutorListBadge(assignmentId){
      const selectorId = String(assignmentId).replace(/"/g,'\\"');
      // Update badges in the per-student assignment list (current chat flow)
      const buttons = document.querySelectorAll(`#tutor-chat-assignments-for-student button[data-id="${selectorId}"]`);
      const count = window.tutorUnread?.get(String(assignmentId))||0;
      buttons.forEach((button) => {
        if(!button) return;
        const badge = button.querySelector('.assignment-unread-badge');
        if(!badge) return;
        if(count>0){ badge.textContent = String(count); badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
      });
    }

    // LocalStorage helpers for last-read timestamps per assignment (tutor side)
    function getTutorLastReadMap(){
      try{ return JSON.parse(localStorage.getItem('tutorLastRead')||'{}')||{}; }catch(_){ return {}; }
    }
    function setTutorLastRead(assignmentId, ts){
      const map = getTutorLastReadMap();
      map[String(assignmentId)] = ts || Date.now();
      localStorage.setItem('tutorLastRead', JSON.stringify(map));
    }
    function getTutorLastRead(assignmentId){
      const map = getTutorLastReadMap();
      const v = map[String(assignmentId)];
      return typeof v === 'number' ? v : 0;
    }

    function incrementTutorUnread(assignmentId){
      const id = String(assignmentId);
      // If chat section is visible and this assignment is active, do not count as unread
      const chatVisible = !document.getElementById('chat').classList.contains('hidden');
      if(chatVisible && tutorActiveAssignment && String(tutorActiveAssignment.id)===id) return;
      const current = window.tutorUnread.get(id)||0;
      window.tutorUnread.set(id, current+1);
      updateTutorListBadge(id);
      updateTutorSidebarBadge();
    }
    function clearTutorUnread(assignmentId){
      if(!assignmentId) return;
      const id = String(assignmentId);
      // Update last read timestamp
      setTutorLastRead(id, Date.now());
      if(window.tutorUnread.has(id)) window.tutorUnread.set(id,0);
      updateTutorListBadge(id);
      updateTutorSidebarBadge();
    }

    // Poll to compute unread counts using last-read timestamps
    async function refreshTutorUnreadCounts(){
      try{
        let assignments = window.currentAssignments || [];
        // If we have no cached assignments yet, fetch them once so badges can compute
        if(assignments.length===0){
          try{
            const res = await fetchWithAuth(`${API_BASE}/tutor/assignments`);
            const data = await res.json();
            assignments = Array.isArray(data.assignments) ? data.assignments : [];
            if(assignments.length>0){ window.currentAssignments = assignments; }
          }catch(_){ /* ignore fetch error; proceed with empty */ }
        }
        if(assignments.length===0) { updateTutorSidebarBadge(); return; }
        await Promise.all(assignments.map(async (a)=>{
          const id = String(a.id || a._id);
          if(!id) return;
          try{
            const res = await fetchWithAuth(`${API_BASE}/messages?assignmentId=${encodeURIComponent(id)}`);
            const data = await res.json();
            if(!data.success) return;
            const lastRead = getTutorLastRead(id);
            const count = (data.messages||[]).filter(m=> m.sender==='student' && new Date(m.createdAt).getTime() > lastRead).length;
            window.tutorUnread.set(id, count);
            updateTutorListBadge(id);
          }catch(_){ /* ignore per-assignment error */ }
        }));
        updateTutorSidebarBadge();
      }catch(_){ /* ignore */ }
    }

    let tutorActiveAssignment = null; // { id, title, studentId, tutorId }
    let sseEventSource = null;
    let tutorSeenMessageIds = new Set();

    // Removed Socket.IO implementation to prevent duplicate messages
    // Using SSE only for real-time messaging

    function startTutorSSE(){
      if (sseEventSource) { try { sseEventSource.close(); } catch(_){} sseEventSource = null; }
      if (!tutorActiveAssignment) return;
      // Don't reset tutorSeenMessageIds here - it's reset when switching assignments and populated by loadTutorMessages
      const url = `${API_BASE}/messages/stream?assignmentId=${encodeURIComponent(tutorActiveAssignment.id)}`;
      sseEventSource = new EventSource(url);
      sseEventSource.onmessage = (evt) => {
        try {
          const data = JSON.parse(evt.data);
          if (data?.type === 'message' && data.message) {
            const m = data.message;
            if (String(m.assignmentId) !== String(tutorActiveAssignment.id)) return;
            // Deduplicate by message id
            if (m._id && tutorSeenMessageIds.has(m._id)) return;
            if (m._id) tutorSeenMessageIds.add(m._id);
            const me = m.sender === 'tutor';
            const align = me ? 'text-right' : 'text-left';
            const bubble = me ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-200 text-black';
            const append = (history)=>{ if(!history) return; history.innerHTML += `<div class="${align}"><div class="inline-block ${bubble} p-2 rounded max-w-[80%]">${m.content}<div class="text-xs opacity-70 mt-1">${new Date(m.createdAt).toLocaleString()}</div></div></div>`; history.scrollTop = history.scrollHeight; };
            append(document.getElementById('tutor-chat-history'));
            append(document.getElementById('tutor-chat-history-mobile'));
            append(document.getElementById('tutor-chat-history-modal'));
            if (!me) {
              const chatVisible = !document.getElementById('chat').classList.contains('hidden');
              if(chatVisible && tutorActiveAssignment && String(tutorActiveAssignment.id)===String(m.assignmentId)){
                // mark as read immediately
                setTutorLastRead(m.assignmentId, new Date(m.createdAt).getTime() || Date.now());
                clearTutorUnread(m.assignmentId);
              } else {
                // increment unread for this assignment when tutor is not currently viewing this chat
                incrementTutorUnread(m.assignmentId);
                document.getElementById('tutor-new-message-audio')?.play().catch(()=>{});
              }
            }
          }
        } catch (_){ }
      };
    }

    // Step 1: load students as avatars for chat flow
    async function loadTutorChatStudents(){
      try{
        const res = await fetchWithAuth(`${API_BASE}/tutor/students`);
        const data = await res.json();
        const row = document.getElementById('tutor-chat-students');
        if(!data.success){ if(row) row.innerHTML = '<div class="text-sm text-red-600">Failed to load students</div>'; return; }
        const students = data.students||[];
        row.innerHTML = students.map(s=>{
          const initials = (s.name||'S').split(' ').map(x=>x[0]).slice(0,2).join('').toUpperCase();
          const avatar = s.profileImage ? `<img src="${getImageUrl(s.profileImage)}" class="w-12 h-12 rounded-full object-cover"/>` : `<div class="w-12 h-12 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-semibold">${initials}</div>`;
          return `<button class="flex flex-col items-center shrink-0 relative" data-stu-id="${s.id}" data-stu-name="${s.name}">
            <div class="relative">
              ${avatar}
              <span class="student-unread-badge absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
            </div>
            <span class="text-xs mt-1 max-w-[5rem] truncate">${s.name}</span>
          </button>`;
        }).join('');
        row.querySelectorAll('button[data-stu-id]').forEach(btn=>{
          btn.addEventListener('click', ()=> selectChatStudent(btn.dataset.stuId, btn.dataset.stuName));
        });
        // After rendering students, update their unread badges using current counts
        updateTutorSidebarBadge();
      }catch(e){ const row = document.getElementById('tutor-chat-students'); if(row) row.innerHTML = '<div class="text-sm text-red-600">Network error</div>'; }
    }

    function resetChatSteps(){
      document.getElementById('tutor-chat-assignments-wrap').classList.add('hidden');
      document.getElementById('tutor-chat-selected-student-label').textContent = 'Select a student';
      document.getElementById('tutor-chat-assignments-for-student').innerHTML='';
    }

    async function selectChatStudent(studentId, name){
      document.getElementById('tutor-chat-selected-student-label').textContent = `Selected: ${name}`;
      document.getElementById('tutor-chat-student-name').textContent = name;
      const wrap = document.getElementById('tutor-chat-assignments-wrap');
      wrap.classList.remove('hidden');
      // Load assignments for this student
      try{
        const res = await fetchWithAuth(`${API_BASE}/tutor/assignments`);
        const data = await res.json();
        const list = document.getElementById('tutor-chat-assignments-for-student');
        if(!data.success){ list.innerHTML = '<div class="text-sm text-red-600">Failed to load assignments</div>'; return; }
        const itemsArr = (data.assignments||[])
          .filter(a=> {
            const sid = a && a.userId ? (a.userId.id || a.userId._id || a.userId) : null;
            return String(sid) === String(studentId);
          });
        const items = itemsArr.map(a=>{
            const sid = a && a.userId ? (a.userId.id || a.userId._id || a.userId) : '';
            const tid = a && a.tutorId ? (a.tutorId.id || a.tutorId._id || a.tutorId) : (a.tutorId || '');
            return `<button class="shrink-0 text-left p-2 border rounded hover:bg-gray-50 relative" data-id="${a.id}" data-title="${a.assignmentTitle}" data-student="${sid}" data-tutor="${tid}">
              <span class="assignment-unread-badge absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
              <div class="font-medium truncate max-w-[12rem]">${a.assignmentTitle}</div>
              <div class="text-[10px] text-gray-500">${a.status}</div>
            </button>`;
          }).join('');
        list.innerHTML = items || '<div class="text-sm text-gray-500">No assignments for this student</div>';
        list.querySelectorAll('button[data-id]').forEach(btn=>{
          btn.addEventListener('click', ()=> openTutorChatModal({ id: btn.dataset.id, title: btn.dataset.title, studentId: btn.dataset.student, tutorId: btn.dataset.tutor }));
        });
        // Seed per-assignment badges now based on current unread map
        try{
          itemsArr.forEach(a=>{
            const count = window.tutorUnread?.get(String(a.id))||0;
            const chip = list.querySelector(`button[data-id="${a.id}"] .assignment-unread-badge`);
            if(chip){ if(count>0){ chip.textContent=String(count); chip.classList.remove('hidden'); } else { chip.classList.add('hidden'); } }
          });
        }catch(_){}
      }catch(e){ document.getElementById('tutor-chat-assignments-for-student').innerHTML = '<div class="text-sm text-red-600">Network error</div>'; }
    }

    function openTutorChatModal(assign){
      tutorActiveAssignment = assign;
      tutorSeenMessageIds = new Set();
      document.getElementById('tutor-chat-modal-title').textContent = assign.title;
      document.getElementById('tutorChatModal').classList.remove('hidden');
      clearTutorUnread(assign.id);
      // Also hide the per-assignment unread chip immediately
      const chip = document.querySelector(`#tutor-chat-assignments-for-student button[data-id="${assign.id}"] .assignment-unread-badge`);
      if(chip) chip.classList.add('hidden');
      loadTutorMessages();
      startTutorSSE();
      toggleTutorSendButtonModal();
    }
    function closeTutorChatModal(){
      document.getElementById('tutorChatModal').classList.add('hidden');
      // Mark messages as read when closing the modal for the active assignment
      if (tutorActiveAssignment) {
        clearTutorUnread(tutorActiveAssignment.id);
      }
    }

    function toggleTutorSendButtonModal(){
      const input = document.getElementById('tutor-chat-input-modal');
      const btn = document.getElementById('tutor-send-modal');
      if(!input || !btn) return;
      const canSend = !!input.value.trim() && !!tutorActiveAssignment;
      btn.disabled = !canSend;
      if(canSend){ btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-blue-600'); }
      else { btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-blue-600'); }
    }

    async function tutorSendMessageModal(){
      const input = document.getElementById('tutor-chat-input-modal');
      if(!input) return;
      const content = input.value.trim();
      const tutorId = localStorage.getItem('tutorId') || '';
      if(!content || !tutorActiveAssignment){ return; }
      try{
        const effectiveTutorId = tutorActiveAssignment.tutorId || tutorId || '';
        const res = await fetchWithAuth(`${API_BASE}/messages`, { method:'POST', body: JSON.stringify({ assignmentId: tutorActiveAssignment.id, studentId: tutorActiveAssignment.studentId, tutorId: effectiveTutorId, sender: 'tutor', content }) });
        const data = await res.json();
        if(!data.success){ console.error('Failed to send'); }
        document.getElementById('tutor-send-audio')?.play().catch(()=>{});
      }catch(e){ console.error('Network error'); }
      finally {
        input.value='';
        toggleTutorSendButtonModal();
      }
    }

    // Deprecated direct chat list (kept for compatibility, can be repurposed)
    async function loadTutorChatAssignments(){ /* no-op now that we use student-first flow */ }

    async function loadTutorMessages(){
      const history = document.getElementById('tutor-chat-history');
      const historyMobile = document.getElementById('tutor-chat-history-mobile');
      if(!tutorActiveAssignment){ 
        if(history) history.innerHTML = '<div class="text-sm text-gray-500">Select an assignment</div>'; 
        if(historyMobile) historyMobile.innerHTML = '<div class="text-sm text-gray-500">Select an assignment</div>'; 
        return; 
      }
      if(history) history.innerHTML = '<div class="text-sm text-gray-500">Loading...</div>';
      if(historyMobile) historyMobile.innerHTML = '<div class="text-sm text-gray-500">Loading...</div>';
      try{
        const res = await fetchWithAuth(`${API_BASE}/messages?assignmentId=${encodeURIComponent(tutorActiveAssignment.id)}`);
        const data = await res.json();
        if(!data.success){ 
          if(history) history.innerHTML = '<div class="text-sm text-red-600">Failed to load</div>'; 
          if(historyMobile) historyMobile.innerHTML = '<div class="text-sm text-red-600">Failed to load</div>'; 
          return; 
        }
        const render = (target)=>{
          if(!target) return;
          target.innerHTML = '';
          (data.messages||[]).forEach(m=>{
            if (m._id) tutorSeenMessageIds.add(m._id);
            const me = m.sender === 'tutor';
            const align = me ? 'text-right' : 'text-left';
            const bubble = me ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-200 text-black';
            target.innerHTML += `<div class="${align}"><div class="inline-block ${bubble} p-2 rounded max-w-[80%]">${m.content}<div class="text-xs opacity-70 mt-1">${new Date(m.createdAt).toLocaleString()}</div></div></div>`;
          });
          target.scrollTop = target.scrollHeight;
        };
        render(history);
        render(historyMobile);
        render(document.getElementById('tutor-chat-history-modal'));
        // Opening messages means they are read
        clearTutorUnread(tutorActiveAssignment.id);
      }catch(e){ 
        if(history) history.innerHTML = '<div class="text-sm text-red-600">Network error</div>'; 
        if(historyMobile) historyMobile.innerHTML = '<div class="text-sm text-red-600">Network error</div>'; 
        const hm = document.getElementById('tutor-chat-history-modal'); if(hm) hm.innerHTML = '<div class="text-sm text-red-600">Network error</div>';
      }
    }

    function toggleTutorSendButton(){
      const input = document.getElementById('tutor-chat-input');
      const btn = document.getElementById('tutor-send');
      const canSend = !!input.value.trim() && !!tutorActiveAssignment; // allow send when assignment chosen
      btn.disabled = !canSend;
      if(canSend){ btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-blue-600'); }
      else { btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-blue-600'); }
    }

    function toggleTutorSendButtonMobile(){
      const input = document.getElementById('tutor-chat-input-mobile');
      const btn = document.getElementById('tutor-send-mobile');
      if(!input || !btn) return;
      const canSend = !!input.value.trim() && !!tutorActiveAssignment;
      btn.disabled = !canSend;
      if(canSend){ btn.classList.remove('bg-gray-400','cursor-not-allowed'); btn.classList.add('bg-blue-600'); }
      else { btn.classList.add('bg-gray-400','cursor-not-allowed'); btn.classList.remove('bg-blue-600'); }
    }

    async function tutorSendMessage(){
      const input = document.getElementById('tutor-chat-input');
      const content = input.value.trim();
      const tutorId = localStorage.getItem('tutorId') || '';
      if(!content || !tutorActiveAssignment){ return; }
      try{
        const effectiveTutorId = tutorActiveAssignment.tutorId || tutorId || '';
        const res = await fetchWithAuth(`${API_BASE}/messages`, { method:'POST', body: JSON.stringify({ assignmentId: tutorActiveAssignment.id, studentId: tutorActiveAssignment.studentId, tutorId: effectiveTutorId, sender: 'tutor', content }) });
        const data = await res.json();
        if(!data.success){ console.error('Failed to send'); }
        document.getElementById('tutor-send-audio')?.play().catch(()=>{});
      }catch(e){ console.error('Network error'); }
      finally {
        input.value='';
        toggleTutorSendButton();
        toggleTutorSendButtonMobile();
      }
    }

    async function tutorSendMessageMobile(){
      const input = document.getElementById('tutor-chat-input-mobile');
      if(!input) return;
      const content = input.value.trim();
      const tutorId = localStorage.getItem('tutorId') || '';
      if(!content || !tutorActiveAssignment){ return; }
      try{
        const effectiveTutorId = tutorActiveAssignment.tutorId || tutorId || '';
        const res = await fetchWithAuth(`${API_BASE}/messages`, { method:'POST', body: JSON.stringify({ assignmentId: tutorActiveAssignment.id, studentId: tutorActiveAssignment.studentId, tutorId: effectiveTutorId, sender: 'tutor', content }) });
        const data = await res.json();
        if(!data.success){ console.error('Failed to send'); }
        document.getElementById('tutor-send-audio')?.play().catch(()=>{});
      }catch(e){ console.error('Network error'); }
      finally {
        input.value='';
        toggleTutorSendButtonMobile();
        toggleTutorSendButton();
      }
    }

    // Load tutor profile
    async function loadTutorProfile() {
      try {
        // In a real app, this would get the tutor ID from authentication
        const tutorId = localStorage.getItem('tutorId');
        if (!tutorId || tutorId.length < 1) return;
        const response = await fetchWithAuth(`${API_BASE}/tutor/profile/${tutorId}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();
        
        if (result.success) {
          document.getElementById('tutorName').textContent = result.tutor.name || 'Tutor';
          if (result.tutor.profileImage) {
            document.getElementById('adminProfileAvatar').innerHTML = `<img src="${getImageUrl(result.tutor.profileImage)}" class="w-full h-full object-cover">`;
          }
        }
      } catch (error) {
        console.error('Error loading tutor profile:', error);
      }
    }

    // Navigation
    function showSection(sectionId, event) {
      // Hide all sections
      document.querySelectorAll('section').forEach(section => {
        section.classList.add('hidden');
      });
      
      // Show selected section
      document.getElementById(sectionId).classList.remove('hidden');
      
      // Load section data
      if (sectionId === 'coupons') {
        loadCoupons();
      }
      
      // Update header title
      const titleMap = {
        overview: 'Dashboard Overview',
        assignments: 'Assignments',
        students: 'Students',
        payments: 'Payment Approvals',
        coupons: 'Coupons & Discounts',
        chat: 'Student Chats'
      };
      const header = document.getElementById('tutor-section-title');
      if (header) header.textContent = titleMap[sectionId] || 'Tutor Dashboard';
      
      // Update desktop sidebar active state
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active', 'bg-white', 'bg-opacity-20');
      });
      if(event && event.target){
        const linkEl = event.target.closest('.nav-link');
        if (linkEl) linkEl.classList.add('active', 'bg-white', 'bg-opacity-20');
      }
      
      if(sectionId === 'assignments'){
        markSidebarSectionSeen('assignments');
      } else if(sectionId === 'students'){
        markSidebarSectionSeen('students');
      } else if(sectionId === 'payments'){
        markSidebarSectionSeen('payments');
      }
      if(sectionId === 'chat'){
        clearTutorUnread(tutorActiveAssignment?.id);
      }
    }

    // Load overview data
    async function loadOverviewData() {
      try {
        const [assignmentsRes, studentsRes, paymentsRes] = await Promise.all([
          fetchWithAuth(`${API_BASE}/tutor/assignments`),
          fetchWithAuth(`${API_BASE}/tutor/students`),
          fetchWithAuth(`${API_BASE}/tutor/pending-payments`)
        ]);

        if (!assignmentsRes.ok || !studentsRes.ok || !paymentsRes.ok) {
            throw new Error('One or more stats requests failed');
        }

        const assignmentsData = await assignmentsRes.json();
        const studentsData = await studentsRes.json();
        const paymentsData = await paymentsRes.json();

        if (assignmentsData.success) {
          const assignments = Array.isArray(assignmentsData.assignments) ? assignmentsData.assignments : [];
          document.getElementById('totalAssignments').textContent = assignments.length;
          document.getElementById('pendingReview').textContent = 
            assignments.filter(a => ['pending', 'under-review', 'checking-balance'].includes(a.status)).length;
        }

        if (studentsData.success) {
          const students = Array.isArray(studentsData.students) ? studentsData.students : [];
          document.getElementById('activeStudents').textContent = students.length;
        }

        if (paymentsData.success) {
          const payments = Array.isArray(paymentsData.payments) ? paymentsData.payments : [];
          document.getElementById('pendingPayments').textContent = payments.length;
        }

        // Load recent activity
        loadRecentActivity();

      } catch (error) {
        console.error('Error loading overview data:', error);
      }
    }

    // Load recent activity (compose from assignments + pending payments)
    async function loadRecentActivity() {
      const activityContainer = document.getElementById('recentActivity');
      try {
        const [assignmentsRes, pendingPaymentsRes] = await Promise.all([
          fetchWithAuth(`${API_BASE}/tutor/assignments`),
          fetchWithAuth(`${API_BASE}/tutor/pending-payments`)
        ]);
        const assignmentsData = await assignmentsRes.json();
        const pendingPaymentsData = await pendingPaymentsRes.json();
        const activities = [];

        if (assignmentsData.success) {
          (assignmentsData.assignments||[]).slice(0,50).forEach(a => {
            if (a.createdAt) activities.push({
              ts: new Date(a.createdAt).getTime(),
              icon: 'fas fa-plus-circle text-blue-500',
              text: `New assignment submitted by ${a.studentName||a.userId?.name||'Student'}  ${a.assignmentTitle}`
            });
            if (Array.isArray(a.completedFiles) && a.completedFiles.length>0) {
              const latest = a.completedFiles[a.completedFiles.length-1];
              activities.push({
                ts: new Date(latest.uploadedAt||a.updatedAt||a.createdAt).getTime(),
                icon: 'fas fa-upload text-purple-500',
                text: `Completed work uploaded for ${a.assignmentTitle}`
              });
            }
          });
        }

        if (pendingPaymentsData.success) {
          (pendingPaymentsData.payments||[]).forEach(p => {
            activities.push({
              ts: new Date(p.createdAt).getTime(),
              icon: 'fas fa-credit-card text-yellow-500',
              text: `Payment awaiting approval  ${p.user?.name||'Student'}  $${Number(p.amount||0).toFixed(2)} (${String(p.method||'').toUpperCase()})`
            });
          });
        }

        activities.sort((a,b)=>b.ts-a.ts);
        const top = activities.slice(0,10);
        if (top.length===0) {
          activityContainer.innerHTML = '<div class="text-sm text-gray-500">No recent activity</div>';
          return;
        }
        activityContainer.innerHTML = top.map(ev => `
          <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
            <i class="${ev.icon}"></i>
            <span class="text-sm text-gray-700">${ev.text}</span>
            <span class="text-xs text-gray-400 ml-auto">${new Date(ev.ts).toLocaleString()}</span>
          </div>
        `).join('');
      } catch (e) {
        activityContainer.innerHTML = '<div class="text-sm text-red-600">Failed to load recent activity</div>';
      }
    }

    // Load assignments
    async function loadAssignments() {
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/assignments`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (result.success) {
          const assignments = Array.isArray(result.assignments) ? result.assignments : [];
          currentAssignments = assignments;
          sidebarBadgeData.assignments = assignments.map(a => String(a?.id || a?._id || '')).filter(Boolean);
          const assignmentsSection = document.getElementById('assignments');
          if (assignmentsSection && !assignmentsSection.classList.contains('hidden')) {
            markSidebarSectionSeen('assignments');
          } else {
            refreshSidebarBadges();
          }
          displayAssignments(assignments);
        }
      } catch (error) {
        console.error('Error loading assignments:', error);
      }
    }

    // Display assignments
    function displayAssignments(assignments) {
      const container = document.getElementById('assignmentsList');
      
      const safeAssignments = Array.isArray(assignments) ? assignments : [];
      if (safeAssignments.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-tasks text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">No assignments found</p>
          </div>
        `;
        return;
      }

      container.innerHTML = safeAssignments.map(assignment => `
        <div class="bg-white rounded-lg shadow p-6 card-hover transition duration-300">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-center space-x-3 flex-1">
              <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-100 flex-shrink-0">
                ${assignment.studentProfileImage || assignment.userId?.profile_image ? 
                  `<img src="${getImageUrl(assignment.studentProfileImage || assignment.userId?.profile_image)}" class="w-full h-full object-cover">` : 
                  `<div class="w-full h-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                    ${(assignment.studentName || assignment.userId?.name || '?')[0].toUpperCase()}
                  </div>`
                }
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-800">${assignment.assignmentTitle}</h3>
                <p class="text-sm text-gray-600">Student: ${assignment.studentName || assignment.userId?.name || 'Unknown'}</p>
                <p class="text-sm text-gray-600">Subject: ${assignment.subject} | Type: ${assignment.orderType}</p>
              </div>
            </div>
            <span class="status-${assignment.status} px-3 py-1 rounded-full text-sm font-medium">
              ${getStatusText(assignment.status)}
            </span>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
            <div>
              <span class="text-gray-500">Deadline:</span>
              <p class="font-medium">${new Date(assignment.deadline).toLocaleDateString()}</p>
            </div>
            <div>
              <span class="text-gray-500">Pages:</span>
              <p class="font-medium">${assignment.pages || 'N/A'}</p>
            </div>
            <div>
              <span class="text-gray-500">Cost:</span>
              <p class="font-medium">$${Number(assignment.totalCost || 0).toFixed(2)}</p>
              ${assignment.couponCode ? `
                <div class="mt-1">
                  <span class="bg-green-100 text-green-800 text-[10px] font-bold px-2 py-0.5 rounded-full">
                    <i class="fas fa-ticket-alt mr-1"></i>${assignment.couponCode} (-$${Number(assignment.discountAmount || 0).toFixed(2)})
                  </span>
                </div>
              ` : ''}
            </div>
            <div>
              <span class="text-gray-500">Files:</span>
              <p class="font-medium">${Array.isArray(assignment.files) ? assignment.files.length : 0}</p>
            </div>
          </div>
          
          <div class="flex space-x-2">
            <button onclick="viewAssignment('${assignment.id}')" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
              <i class="fas fa-eye mr-1"></i>View Details
            </button>
            
            ${assignment.status === 'pending' || assignment.status === 'under-review' ? `
              <button onclick="updateAssignmentStatus('${assignment.id}', 'checking-balance')" 
                      class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 text-sm">
                <i class="fas fa-credit-card mr-1"></i>Check Balance
              </button>
            ` : ''}
            
            ${assignment.status === 'checking-balance' ? `
              <button onclick="updateAssignmentStatus('${assignment.id}', 'assigned')" 
                      class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                <i class="fas fa-check mr-1"></i>Assign
              </button>
            ` : ''}
            
            ${assignment.status === 'assigned' ? `
              <button onclick="updateAssignmentStatus('${assignment.id}', 'in-progress')" 
                      class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm">
                <i class="fas fa-play mr-1"></i>Start Work
              </button>
            ` : ''}
            
            ${assignment.status === 'in-progress' ? `
              <button onclick="openUploadModal('${assignment.id}')" 
                      class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                <i class="fas fa-upload mr-1"></i>Upload Completed
              </button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    // Filter assignments
    function filterAssignments() {
      const status = document.getElementById('statusFilter').value;
      const filtered = status === 'all' ? currentAssignments : 
                      currentAssignments.filter(a => a.status === status);
      displayAssignments(filtered);
    }

    // Get status text
    function getStatusText(status) {
      const statusMap = {
        'pending': 'Pending',
        'under-review': 'Under Review',
        'checking-balance': 'Checking Balance',
        'assigned': 'Assigned',
        'in-progress': 'In Progress',
        'completed': 'Completed',
        'cancelled': 'Cancelled'
      };
      return statusMap[status] || status;
    }

    // View assignment details
     function viewAssignment(assignmentId) {
      const assignment = currentAssignments.find(a => String(a.id) === String(assignmentId));
      if (!assignment) return;

      const modal = document.getElementById('assignmentModal');
      const details = document.getElementById('assignmentDetails');
      
      details.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-semibold text-gray-800 mb-3">Assignment Information</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Title:</strong> ${assignment.assignmentTitle}</p>
              <p><strong>Subject:</strong> ${assignment.subject}</p>
              <p><strong>Type:</strong> ${assignment.orderType}</p>
              <p><strong>Category:</strong> ${assignment.category}</p>
               <p><strong>Pages:</strong> ${assignment.pages > 0 ? assignment.pages : 'N/A'}</p>
               <p><strong>Cost:</strong> $${Number(assignment.totalCost || 0).toFixed(2)}</p>
               ${assignment.couponCode ? `
                 <p><strong>Coupon:</strong> <span class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-[10px] font-bold">${assignment.couponCode} (-$${Number(assignment.discountAmount || 0).toFixed(2)})</span></p>
               ` : ''}
              <p><strong>Deadline:</strong> ${new Date(assignment.deadline).toLocaleString()}</p>
              <p><strong>Status:</strong> <span class="status-${assignment.status} px-2 py-1 rounded text-xs">${getStatusText(assignment.status)}</span></p>
            </div>
          </div>
          
          <div>
            <h4 class="font-semibold text-gray-800 mb-3">Student Information</h4>
            <div class="space-y-2 text-sm">
              <p><strong>Name:</strong> ${assignment.studentName || assignment.userId?.name || 'Unknown'}</p>
              <p><strong>Email:</strong> ${assignment.studentEmail || assignment.userId?.email || 'N/A'}</p>
            </div>
            
            ${assignment.assignedTutor ? `
              <h4 class="font-semibold text-gray-800 mb-3 mt-4">Assigned Tutor</h4>
              <div class="space-y-2 text-sm">
                <p><strong>Name:</strong> ${assignment.assignedTutor.name}</p>
                <p><strong>Email:</strong> ${assignment.assignedTutor.email}</p>
              </div>
            ` : ''}
          </div>
        </div>
        
        <div class="mt-6">
          <h4 class="font-semibold text-gray-800 mb-3">Description</h4>
          <p class="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">${assignment.description || assignment.instructions || 'N/A'}</p>
        </div>
        
        ${assignment.additionalRequirements ? `
          <div class="mt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Additional Requirements</h4>
            <p class="text-sm text-gray-600 bg-gray-50 p-4 rounded-lg">${assignment.additionalRequirements}</p>
          </div>
        ` : ''}
        
        ${Array.isArray(assignment.files) && assignment.files.length > 0 ? `
          <div class="mt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Uploaded Files</h4>
            <div class="space-y-2">
              ${assignment.files.map(file => {
                // Handle both formats: string filename and object with originalName/filename
                const fileName = typeof file === 'string' ? file : file.originalName || file.filename || 'Unknown File';
                const filePath = typeof file === 'string' ? file : file.filename || file;
                return `
                  <div class="flex items-center space-x-2 bg-gray-50 p-2 rounded">
                    <i class="fas fa-file text-gray-500"></i>
                    <span class="text-sm">${fileName}</span>
                    <a href="${getImageUrl(filePath)}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                      <i class="fas fa-download"></i>
                    </a>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        ` : ''}
        
        ${Array.isArray(assignment.completedFiles) && assignment.completedFiles.length > 0 ? `
          <div class="mt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Completed Files</h4>
            <div class="space-y-2">
              ${assignment.completedFiles.map(file => `
                <div class="flex items-center space-x-2 bg-green-50 p-2 rounded">
                  <i class="fas fa-file-check text-green-500"></i>
                  <span class="text-sm">${file.originalName}</span>
                  <a href="${API_BASE}/file/${file.filename}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-download"></i>
                  </a>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        ${assignment.tutorComments ? `
          <div class="mt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Tutor Comments</h4>
            <p class="text-sm text-gray-600 bg-blue-50 p-4 rounded-lg">${assignment.tutorComments}</p>
          </div>
        ` : ''}
      `;
      
      modal.classList.remove('hidden');
    }

    // Close assignment modal
    function closeAssignmentModal() {
      document.getElementById('assignmentModal').classList.add('hidden');
    }

    // Update assignment status
    async function updateAssignmentStatus(assignmentId, newStatus) {
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/update-assignment-status`, {
          method: 'POST',
          body: JSON.stringify({
            assignmentId,
            status: newStatus
          })
        });

        const result = await response.json();
        
        if (result.success) {
          loadAssignments(); // Refresh assignments
          loadOverviewData(); // Refresh overview stats
        } else {
          showMessage('Failed to update assignment status: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('Error updating assignment status:', error);
        showMessage('Error updating assignment status', 'error');
      }
    }

    // Open upload modal
    function openUploadModal(assignmentId) {
      document.getElementById('uploadAssignmentId').value = assignmentId;
      document.getElementById('uploadModal').classList.remove('hidden');
    }

    // Close upload modal
    function closeUploadModal() {
      document.getElementById('uploadModal').classList.add('hidden');
      document.getElementById('uploadForm').reset();
    }

    // Handle file upload form
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    const tId = localStorage.getItem('tutorId');
    if (tId) {
      document.getElementById('uploadTutorId').value = tId;
    }
      e.preventDefault();
      
      const formData = new FormData(this);
      const assignmentId = formData.get('assignmentId');
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/upload-completed-files/${assignmentId}`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        
        if (result.success) {
          closeUploadModal();
          loadAssignments(); // Refresh assignments
          loadOverviewData(); // Refresh overview stats
          showMessage('Files uploaded successfully!', 'success');
        } else {
          showMessage('Failed to upload files: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('Error uploading files:', error);
        showMessage('Error uploading files', 'error');
      }
    });

    // Load students
    async function loadStudents() {
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/students`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (result.success) {
          const students = Array.isArray(result.students) ? result.students : [];
          currentStudents = students;
          sidebarBadgeData.students = students.map(s => String(s?.id || s?._id || s?.userId || '')).filter(Boolean);
          const studentsSection = document.getElementById('students');
          if (studentsSection && !studentsSection.classList.contains('hidden')) {
            markSidebarSectionSeen('students');
          } else {
            refreshSidebarBadges();
          }
          displayStudents(students);
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    // Student Details Modal Functions
    let selectedStudent = null;

    async function openStudentDetails(studentId) {
      selectedStudent = currentStudents.find(s => s.id === studentId);
      if (!selectedStudent) return;

      document.getElementById('studentDetailName').textContent = selectedStudent.name;
      document.getElementById('studentDetailEmail').textContent = selectedStudent.email;
      document.getElementById('studentDetailBalance').textContent = `$${Number(selectedStudent.balance || 0).toFixed(2)}`;
      document.getElementById('studentDetailJoined').textContent = new Date(selectedStudent.createdAt).toLocaleDateString();
      document.getElementById('studentDetailLastLogin').textContent = selectedStudent.lastLogin ? 
        new Date(selectedStudent.lastLogin).toLocaleDateString() + ' ' + new Date(selectedStudent.lastLogin).toLocaleTimeString() : 'Never';
      
      const avatarContainer = document.getElementById('studentDetailAvatar');
      if (selectedStudent.profileImage) {
        avatarContainer.innerHTML = `<img src="${getImageUrl(selectedStudent.profileImage)}" alt="${selectedStudent.name}" class="w-full h-full object-cover rounded-full">`;
        avatarContainer.className = "w-24 h-24 rounded-full flex items-center justify-center mb-4 overflow-hidden bg-gray-100";
      } else {
        avatarContainer.innerHTML = `<i class="fas fa-user text-blue-600 text-4xl"></i>`;
        avatarContainer.className = "w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-4";
      }

      const suspendedBadge = document.getElementById('studentSuspendedBadge');
      const suspendBtn = document.getElementById('suspendBtn');
      
      if (selectedStudent.isSuspended) {
        suspendedBadge.classList.remove('hidden');
        suspendBtn.textContent = 'Unsuspend Account';
        suspendBtn.className = 'w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition';
      } else {
        suspendedBadge.classList.add('hidden');
        suspendBtn.textContent = 'Suspend Account';
        suspendBtn.className = 'w-full px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700 transition';
      }

      // Load student assignments
      loadStudentAssignments(studentId);

      document.getElementById('studentDetailsModal').classList.remove('hidden');
    }

    function closeStudentDetailsModal() {
      document.getElementById('studentDetailsModal').classList.add('hidden');
      selectedStudent = null;
    }

    async function adjustBalance() {
      if (!selectedStudent) return;
      
      const newAmountInput = document.getElementById('adjustBalanceAmount');
      const reasonInput = document.getElementById('adjustBalanceReason');
      const adjustBtn = event.target; // The button that was clicked
      
      const newAmount = newAmountInput.value;
      const reason = reasonInput.value;
      
      if (newAmount === "") {
        showNotification("Please enter a new balance amount", "error");
        return;
      }
      
      if (!confirm(`Are you sure you want to change ${selectedStudent.name}'s balance to $${parseFloat(newAmount).toFixed(2)}?`)) {
        return;
      }

      // Disable button to prevent duplicates
      const originalBtnText = adjustBtn.textContent;
      adjustBtn.disabled = true;
      adjustBtn.textContent = "Updating...";
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/adjust-balance`, {
          method: 'POST',
          body: JSON.stringify({
            userId: selectedStudent.id,
            newAmount: parseFloat(newAmount),
            reason: reason || "Manual adjustment by admin"
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification(`Balance updated to $${result.newBalance.toFixed(2)}`, "success");
          
          // Update local data and UI
          selectedStudent.balance = result.newBalance;
          document.getElementById('studentDetailBalance').textContent = `$${result.newBalance.toFixed(2)}`;
          
          // Reset inputs
          newAmountInput.value = "";
          reasonInput.value = "";
          
          // Refresh student list in background
          loadStudents();
        } else {
          showNotification(result.error || "Failed to update balance", "error");
        }
      } catch (error) {
        console.error("Error adjusting balance:", error);
        showNotification("An error occurred while adjusting balance", "error");
      } finally {
        // Re-enable button
        adjustBtn.disabled = false;
        adjustBtn.textContent = originalBtnText;
      }
    }

    async function loadStudentAssignments(studentId) {
      const container = document.getElementById('studentDetailAssignments');
      container.innerHTML = '<p class="text-gray-500 text-sm">Loading assignments...</p>';
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/orders/${studentId}`);
        const result = await response.json();
        
        if (result.success && result.orders) {
          if (result.orders.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm italic">No assignments found for this student.</p>';
            return;
          }
          
          container.innerHTML = result.orders.map(order => `
            <div class="border rounded-lg p-4 hover:shadow-sm transition bg-gray-50">
              <div class="flex justify-between items-start">
                <div>
                  <h6 class="font-bold text-gray-800">${order.assignmentTitle}</h6>
                  <p class="text-xs text-gray-500">${order.subject} | ${order.orderType}</p>
                </div>
                <span class="text-xs font-bold px-2 py-1 rounded ${getStatusBadgeClass(order.status)}">
                  ${order.status}
                </span>
              </div>
              <div class="mt-3 flex justify-between items-center">
                <div class="text-sm font-bold text-blue-600">$${Number(order.totalCost).toFixed(2)}</div>
                <button onclick="confirmDeleteAssignment(${order.id}, event)" class="text-red-500 hover:text-red-700 text-sm">
                  <i class="fas fa-trash mr-1"></i>Delete
                </button>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading student assignments:', error);
        container.innerHTML = '<p class="text-red-500 text-sm">Failed to load assignments.</p>';
      }
    }

    function getStatusBadgeClass(status) {
      switch(status.toLowerCase()) {
        case 'completed': return 'bg-green-100 text-green-700';
        case 'pending': return 'bg-yellow-100 text-yellow-700';
        case 'in-progress': return 'bg-blue-100 text-blue-700';
        case 'cancelled': return 'bg-red-100 text-red-700';
        default: return 'bg-gray-100 text-gray-700';
      }
    }

    async function toggleStudentSuspension() {
      if (!selectedStudent) return;
      
      const newSuspendedState = !selectedStudent.isSuspended;
      let reason = '';
      
      if (newSuspendedState) {
        reason = await showConfirm(
          'Suspend Student',
          `Are you sure you want to suspend ${selectedStudent.name}? Enter a reason below:`,
          { 
            showInput: true, 
            placeholder: 'Reason for suspension (optional)...',
            confirmText: 'Suspend Account',
            type: 'danger'
          }
        );
        if (reason === null) return; // Cancelled
      } else {
        const confirmed = await showConfirm(
          'Unsuspend Student',
          `Are you sure you want to unsuspend ${selectedStudent.name}?`,
          { confirmText: 'Unsuspend Account', type: 'info' }
        );
        if (!confirmed) return;
      }

      try {
        const response = await fetchWithAuth(`${API_BASE}/api/admin/users/${selectedStudent.id}/suspend`, {
          method: 'POST',
          body: JSON.stringify({ suspend: newSuspendedState, reason })
        });
        
        const result = await response.json();
        if (result.success) {
          showMessage(`Student ${newSuspendedState ? 'suspended' : 'unsuspended'} successfully`, 'success');
          // Update local state and UI
          selectedStudent.isSuspended = newSuspendedState;
          openStudentDetails(selectedStudent.id); // Refresh modal
          loadStudents(); // Refresh main list
        } else {
          showMessage(result.error || 'Failed to update suspension status', 'error');
        }
      } catch (error) {
        console.error('Error toggling suspension:', error);
        showMessage('An error occurred. Please try again.', 'error');
      }
    }

    async function confirmDeleteStudent() {
      if (!selectedStudent) return;
      
      const confirmed = await showConfirm(
        'Delete Student Profile',
        `WARNING: Are you sure you want to delete ${selectedStudent.name}? This will permanently delete their account and ALL associated assignments and payments. This action cannot be undone.`,
        { type: 'danger', confirmText: 'Delete Everything' }
      );
      
      if (!confirmed) return;
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/api/admin/users/${selectedStudent.id}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
          showMessage('Student deleted successfully', 'success');
          closeStudentDetailsModal();
          loadStudents();
        } else {
          showMessage(result.error || 'Failed to delete student', 'error');
        }
      } catch (error) {
        console.error('Error deleting student:', error);
        showMessage('An error occurred. Please try again.', 'error');
      }
    }

    async function confirmDeleteAssignment(assignmentId, event) {
      event.stopPropagation();
      
      const confirmed = await showConfirm(
        'Delete Assignment',
        'Are you sure you want to delete this assignment? This action cannot be undone.',
        { type: 'danger', confirmText: 'Delete' }
      );
      if (!confirmed) return;
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/order/${assignmentId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        if (response.ok) {
          showMessage('Assignment deleted successfully', 'success');
          loadStudentAssignments(selectedStudent.id);
          loadStudents(); // Update counts in main list
        } else {
          showMessage(result.error || 'Failed to delete assignment', 'error');
        }
      } catch (error) {
        console.error('Error deleting assignment:', error);
        showMessage('An error occurred. Please try again.', 'error');
      }
    }

    // Display students
    function displayStudents(students) {
      const container = document.getElementById('studentsList');
      
      container.innerHTML = students.map(student => `
        <div onclick="openStudentDetails(${student.id})" class="bg-white rounded-lg shadow p-6 card-hover transition duration-300 cursor-pointer relative ${student.isSuspended ? 'border-2 border-red-200' : ''}">
          ${student.isSuspended ? `
            <div class="absolute top-2 right-2">
              <span class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase">Suspended</span>
            </div>
          ` : ''}
          <div class="flex items-center space-x-4 mb-4">
            <div class="w-12 h-12 rounded-full overflow-hidden flex items-center justify-center bg-gray-100">
              ${student.profileImage ? 
                `<img src="${getImageUrl(student.profileImage)}" alt="${student.name}" class="w-full h-full object-cover">` : 
                `<div class="w-full h-full ${student.isSuspended ? 'bg-red-100' : 'bg-blue-100'} flex items-center justify-center">
                  <i class="fas fa-user ${student.isSuspended ? 'text-red-600' : 'text-blue-600'} text-xl"></i>
                </div>`
              }
            </div>
            <div>
              <h3 class="font-semibold text-gray-800">${student.name}</h3>
              <p class="text-sm text-gray-600">${student.email}</p>
            </div>
          </div>
          
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-500">Balance:</span>
              <span class="font-medium text-green-600">$${Number(student.balance || 0).toFixed(2)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Total Assignments:</span>
              <span class="font-medium">${student.stats?.totalAssignments ?? 0}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-500">Completed:</span>
              <span class="font-medium text-green-600">${student.stats?.completedAssignments ?? 0}</span>
            </div>
          </div>
          
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex justify-between text-[10px] text-gray-500">
              <span>Joined: ${new Date(student.createdAt).toLocaleDateString()}</span>
              <span>Last Login: ${student.lastLogin ? new Date(student.lastLogin).toLocaleDateString() + ' ' + new Date(student.lastLogin).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Never'}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Load pending payments
    async function loadPendingPayments() {
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/pending-payments`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const result = await response.json();

        if (result.success) {
          const payments = Array.isArray(result.payments) ? result.payments : [];
          currentPayments = payments;
          sidebarBadgeData.payments = payments.map(p => String(p?.id || p?._id || '')).filter(Boolean);
          const paymentsSection = document.getElementById('payments');
          if (paymentsSection && !paymentsSection.classList.contains('hidden')) {
            markSidebarSectionSeen('payments');
          } else {
            refreshSidebarBadges();
          }
          displayPendingPayments(payments);
        }
      } catch (error) {
        console.error('Error loading pending payments:', error);
      }
    }

    // Display pending payments
    function displayPendingPayments(payments) {
      const container = document.getElementById('paymentsList');
      
      if (payments.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-credit-card text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">No pending payments</p>
          </div>
        `;
        return;
      }

      container.innerHTML = payments.map(payment => `
        <div class="bg-white rounded-lg shadow p-6 card-hover transition duration-300">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-semibold text-gray-800">${payment.user.name}</h3>
              <p class="text-sm text-gray-600">${payment.user.email}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-green-600">$${payment.amount.toFixed(2)}</p>
              <p class="text-sm text-gray-500">${payment.method.toUpperCase()}</p>
            </div>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-600"><strong>Reference:</strong> ${payment.reference}</p>
            <p class="text-sm text-gray-600"><strong>Submitted:</strong> ${new Date(payment.createdAt).toLocaleString()}</p>
          </div>
          
          ${payment.proofFile ? `
            <div class="mb-4">
              <p class="text-sm text-gray-600 mb-2"><strong>Proof of Payment:</strong></p>
              <a href="${API_BASE}/file/${payment.proofFile.filename}" download 
                 class="inline-flex items-center space-x-2 text-blue-600 hover:text-blue-800">
                <i class="fas fa-file-image"></i>
                <span>${payment.proofFile.originalName}</span>
                <i class="fas fa-external-link-alt text-xs"></i>
              </a>
            </div>
          ` : ''}
          
          <div class="flex space-x-3">
            <button onclick="approvePayment('${payment.id}')" 
                    class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
              <i class="fas fa-check mr-2"></i>Approve
            </button>
            <button onclick="rejectPayment('${payment.id}')" 
                    class="flex-1 bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">
              <i class="fas fa-times mr-2"></i>Reject
            </button>
          </div>
        </div>
      `).join('');
    }

    // Approve payment
    async function approvePayment(paymentId) {
      const confirmed = await showConfirm(
        'Approve Payment',
        'Are you sure you want to approve this payment? This will update the student\'s balance.',
        { type: 'info', confirmText: 'Approve Payment' }
      );
      if (!confirmed) return;
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/approve-payment`, {
          method: 'POST',
          body: JSON.stringify({
            paymentId,
            tutorId: localStorage.getItem('tutorId')
          })
        });

        const result = await response.json();
        
        if (result.success) {
          loadPendingPayments(); // Refresh payments
          loadOverviewData(); // Refresh overview stats
          showMessage('Payment approved successfully!', 'success');
        } else {
          showMessage('Failed to approve payment: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('Error approving payment:', error);
        showMessage('Error approving payment', 'error');
      }
    }

    // Reject payment
    async function rejectPayment(paymentId) {
      const reason = await showConfirm(
        'Reject Payment',
        'Please provide a reason for rejecting this payment:',
        { 
          showInput: true, 
          placeholder: 'Reason for rejection...',
          confirmText: 'Reject Payment',
          type: 'danger'
        }
      );
      if (!reason) return;
      
      try {
        const response = await fetchWithAuth(`${API_BASE}/tutor/reject-payment`, {
          method: 'POST',
          body: JSON.stringify({
            paymentId,
            tutorId: localStorage.getItem('tutorId'),
            reason
          })
        });

        const result = await response.json();
        
        if (result.success) {
          loadPendingPayments(); // Refresh payments
          loadOverviewData(); // Refresh overview stats
          showMessage('Payment rejected successfully!', 'success');
        } else {
          showMessage('Failed to reject payment: ' + result.message, 'error');
        }
      } catch (error) {
        console.error('Error rejecting payment:', error);
        showMessage('Error rejecting payment', 'error');
      }
    }

    // Refresh all data
    function refreshData() {
      loadOverviewData();
      loadAssignments();
      loadStudents();
      loadPendingPayments();
    }
  </script>
</body>
</html>