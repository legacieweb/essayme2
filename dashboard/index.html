 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    /* Glassmorphism Tiles */
    .glass-card {
      background: rgba(255, 255, 255, 0.1) !important;
      backdrop-filter: blur(16px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(16px) saturate(180%) !important;
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07) !important;
    }
    .dark .glass-card {
      background: rgba(15, 23, 42, 0.3) !important;
      border: 1px solid rgba(255, 255, 255, 0.05) !important;
    }

    /* Font Customization */
    #dashboard-content {
      font-family: var(--dash-font-family, inherit);
      color: var(--dash-font-color, inherit);
    }

    /* Chat Theme Variables */
    :root {
      /* Default Theme */
      --student-chat-bg: #3b82f6;
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #f3f4f6;
      --tutor-chat-text: #1f2937;
      --chat-border-radius: 1rem;
      --chat-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Chat Theme Presets */
    .theme-ocean {
      --student-chat-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #e0f2fe;
      --tutor-chat-text: #0277bd;
    }

    .theme-sunset {
      --student-chat-bg: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      --student-chat-text: #4a5568;
      --tutor-chat-bg: #fff7ed;
      --tutor-chat-text: #c2410c;
    }

    .theme-forest {
      --student-chat-bg: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #f0fdf4;
      --tutor-chat-text: #166534;
    }

    .theme-midnight {
      --student-chat-bg: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #374151;
      --tutor-chat-text: #f9fafb;
    }

    .theme-candy {
      --student-chat-bg: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #fef7ff;
      --tutor-chat-text: #be185d;
    }

    .theme-cyber {
      --student-chat-bg: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      --student-chat-text: #ffffff;
      --tutor-chat-bg: #0f172a;
      --tutor-chat-text: #00d2ff;
      --chat-border-radius: 0.25rem;
      --chat-shadow: 0 0 20px rgba(0,210,255,0.3);
    }

    /* Theme base */
    :root { color-scheme: light; }
    .dark :root { color-scheme: dark; }
    .dark body { background-color: #0f172a; color: #e2e8f0; }
    .dark .bg-white { background-color: #0b1220 !important; }
    .dark .text-gray-800 { color: #e2e8f0 !important; }
    .dark .text-gray-700 { color: #cbd5e1 !important; }
    .dark .text-gray-600 { color: #94a3b8 !important; }
    .dark .bg-gray-50 { background-color: #0f172a !important; }
    .dark .bg-gray-100 { background-color: #0b1220 !important; }
    .dark .border-gray-200 { border-color: #1f2937 !important; }
    
    /* Dark mode sidebar buttons */
    .dark .icon-sidebar { background-color: #1f2937 !important; }
    .dark .icon-sidebar a { color: #e2e8f0 !important; }
    .dark .icon-sidebar a i { color: #e2e8f0 !important; }
    .dark .icon-sidebar a.active { background-color: #374151 !important; }
    
    /* Dark mode chat input */
    .dark #chat-box { 
      background-color: #1f2937 !important; 
      color: #e2e8f0 !important; 
      border-color: #374151 !important; 
    }
    .dark #chat-box::placeholder { color: #abaf9c !important; }
    
    /* Dark mode payment inputs and buttons */
    .dark #depositAmount { 
      background-color: #1f2937 !important; 
      color: #e2e8f0 !important; 
      border-color: #374151 !important; 
    }
    .dark #depositAmount::placeholder { color: #9ca3af !important; }
    .dark .bg-gray-200 { background-color: #374151 !important; }
    .dark .text-gray-700 { color: #e2e8f0 !important; }
    .dark .hover\:bg-gray-300:hover { background-color: #4b5563 !important; }

    /* Dark mode - Order Modal */
    .dark #orderModal .bg-white { background-color: #0b1220 !important; }
    .dark #orderModal .sticky.top-0.bg-white { background-color: #0b1220 !important; }
    .dark #orderModal .border,
    .dark #orderModal .border-b,
    .dark #orderModal .border-t,
    .dark #orderModal .border-l,
    .dark #orderModal .border-r { border-color: #1f2937 !important; }
    .dark #orderModal .border-gray-200 { border-color: #1f2937 !important; }
    .dark #orderModal .border-gray-300 { border-color: #374151 !important; }

    .dark #orderModal h2,
    .dark #orderModal h3,
    .dark #orderModal h4 { color: #e2e8f0 !important; }
    .dark #orderModal p,
    .dark #orderModal label,
    .dark #orderModal span { color: #cbd5e1 !important; }
    .dark #orderModal .text-gray-800 { color: #e2e8f0 !important; }
    .dark #orderModal .text-gray-700 { color: #cbd5e1 !important; }
    .dark #orderModal .text-gray-600 { color: #94a3b8 !important; }

    .dark #orderModal select,
    .dark #orderModal input[type="text"],
    .dark #orderModal input[type="number"],
    .dark #orderModal input[type="file"],
    .dark #orderModal textarea {
      background-color: #111827 !important;
      color: #e5e7eb !important;
      border-color: #374151 !important;
    }
    .dark #orderModal ::placeholder { color: #9ca3af !important; }

    /* Section color tweaks */
    .dark #orderModal .bg-blue-50,
    .dark #orderModal .bg-green-50,
    .dark #orderModal .bg-purple-50,
    .dark #orderModal .bg-orange-50 { background-color: #0f172a !important; }

    .dark #orderModal .text-blue-800 { color: #93c5fd !important; }
    .dark #orderModal .text-green-800 { color: #86efac !important; }
    .dark #orderModal .text-purple-800 { color: #d8b4fe !important; }
    .dark #orderModal .text-orange-800 { color: #fdba74 !important; }
    .dark #orderModal .bg-yellow-50 { background-color: #0f172a !important; }
    .dark #orderModal .text-yellow-800 { color: #fde68a !important; }

    /* Gradient section */
    .dark #orderModal .from-red-50.to-pink-50 {
      background-image: none !important;
      background-color: #111827 !important;
    }
    .dark #orderModal .border-red-200 { border-color: #374151 !important; }
    .dark #orderModal .text-red-800 { color: #fca5a5 !important; }

    /* Drag and drop area */
    .dark #orderModal .border-dashed { border-color: #374151 !important; }
    .dark #orderModal .text-gray-600 { color: #94a3b8 !important; }
    .dark #orderModal .text-gray-500 { color: #9ca3af !important; }
    .dark #orderModal .text-gray-400 { color: #9ca3af !important; }

    /* Step 5: dark mode text and date inputs */
    .dark #orderModal .from-blue-50.to-indigo-50 {
      background-image: none !important;
      background-color: #0f172a !important;
    }
    .dark #orderModal .border-blue-200 { border-color: #374151 !important; }
    .dark #orderModal .text-blue-700 { color: #93c5fd !important; }
    .dark #orderModal .text-blue-800 { color: #93c5fd !important; }
    .dark #orderModal .text-green-700 { color: #86efac !important; }
    .dark #orderModal .text-green-500 { color: #22c55e !important; }
    .dark #orderModal .text-yellow-800 { color: #fde68a !important; }

    .dark #orderModal #dueDateTime,
    .dark #orderModal input[type="datetime-local"],
    .dark #orderModal input[type="date"],
    .dark #orderModal input[type="time"] {
      background-color: #111827 !important;
      color: #e5e7eb !important;
      border-color: #374151 !important;
    }
    .dark #orderModal #dueDateTime::placeholder,
    .dark #orderModal input[type="datetime-local"]::placeholder,
    .dark #orderModal input[type="date"]::placeholder,
    .dark #orderModal input[type="time"]::placeholder {
      color: #9ca3af !important;
    }
    /* Date/time picker icon for Chromium/WebKit */
    .dark #orderModal input[type="date"]::-webkit-calendar-picker-indicator,
    .dark #orderModal input[type="datetime-local"]::-webkit-calendar-picker-indicator,
    .dark #orderModal input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0.85) brightness(1.2);
    }

    /* Edit Profile placeholders in dark theme */
    .dark #edit-profile-form input::placeholder,
    .dark #edit-profile-form textarea::placeholder {
      color: #9ca3af !important;
    }

    /* Inline edit placeholders (profile section) */
    #profile .inline-edit-field { color: #2563eb !important; }
    #profile .inline-edit-field::placeholder { color: #2563eb !important; }
    .dark #profile .inline-edit-field { color: #60a5fa !important; }
    .dark #profile .inline-edit-field::placeholder { color: #60a5fa !important; }

    /* Dynamic Chat Message Styling */
    .student-message {
      background: var(--student-chat-bg) !important;
      color: var(--student-chat-text) !important;
      border-radius: var(--chat-border-radius) !important;
      box-shadow: var(--chat-shadow) !important;
      margin-left: auto;
      max-width: 70%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      animation: slideInRight 0.3s ease-out;
    }

    .tutor-message {
      background: var(--tutor-chat-bg) !important;
      color: var(--tutor-chat-text) !important;
      border-radius: var(--chat-border-radius) !important;
      box-shadow: var(--chat-shadow) !important;
      margin-right: auto;
      max-width: 70%;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      position: relative;
      animation: slideInLeft 0.3s ease-out;
    }

    /* Chat Animation */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Modal Animations */
    @keyframes modal-pop {
      0% { transform: scale(0.9) opacity(0); }
      100% { transform: scale(1) opacity(1); }
    }
    .modal-content {
      animation: modal-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .modal-backdrop {
      transition: opacity 0.3s ease;
    }

    /* Cool Toast/Notification */
    .cool-toast {
      animation: toast-slide 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    @keyframes toast-slide {
      0% { transform: translateX(100%); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .toast-exit {
      animation: toast-exit 0.5s forwards;
    }
    @keyframes toast-exit {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0; }
    }

    /* Theme Preview Cards */
    .theme-preview {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .theme-preview:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .theme-preview.selected {
      ring: 3px;
      ring-color: #3b82f6;
      transform: translateY(-2px);
    }

    /* Settings Modal */
    .settings-modal {
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,0.5);
    }

    .settings-content {
      max-height: 90vh;
      overflow-y: auto;
    }

    /* Sidebar Tooltip Fix */
    .tooltip {
      position: absolute;
      left: 4rem;
      background-color: #374151; /* Dark Gray */
      color: #ffffff;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.75rem;
      opacity: 0;
      transform: translateX(10px);
      transition: opacity 0.3s, transform 0.3s;
      white-space: nowrap;
    }

    .icon-sidebar a:hover .tooltip {
      opacity: 1;
      transform: translateX(0);
    }

    /* Active State for Sidebar */
    .active {
      background-color: #60a5fa; /* Blue */
      border-radius: 0.375rem;
    }

    /* Stepper Styles */
    .stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }

    .stepper::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e5e7eb;
      transform: translateY(-50%);
      z-index: 0;
    }

    .step {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background-color: #fff;
      border: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      z-index: 1;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .step.active {
      border-color: #3b82f6;
      background-color: #3b82f6;
      color: #fff;
    }

    .step.completed {
      border-color: #10b981;
      background-color: #10b981;
      color: #fff;
    }

    .step-label {
      position: absolute;
      top: 3rem;
      font-size: 0.75rem;
      white-space: nowrap;
      color: #6b7280;
      font-weight: 500;
    }

    .dark .step {
      background-color: #1f2937;
      border-color: #374151;
      color: #94a3b8;
    }

    .dark .step.active {
      border-color: #3b82f6;
      background-color: #3b82f6;
      color: #fff;
    }

    .dark .step.completed {
      border-color: #10b981;
      background-color: #10b981;
      color: #fff;
    }

    /* Sidebar Styles */
    .icon-sidebar {
      background-color: #bfdbfe; /* Light Blue */
      height: 100%;
      position: fixed;
      top: 0;
      left: 0;
      width: 4rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Mobile Sidebar */
    @media (max-width: 640px) {
      .icon-sidebar {
        top: auto;
        bottom: 0;
        width: 100%;
        height: 4rem;
        flex-direction: row;
        justify-content: space-around;
      }

      .tooltip {
        left: 50%;
        transform: translateX(-50%);
        bottom: 4rem;
      }
    }

    /* Dropdown Animation */
    #dropdown-menu {
      transition: opacity 0.3s ease, transform 0.3s ease;
      transform-origin: top right;
    }

    #dropdown-menu.hidden {
      opacity: 0;
      transform: scale(0.95);
      pointer-events: none;
    }


    @media (min-width: 768px) {
  #profile-card {
    display: flex;
    flex-direction: row; /* Move to horizontal layout */
    align-items: flex-start;
  }

  /* Ensure profile image is aligned to the left */
  #profile-picture {
    justify-content: flex-start;
  }

  /* Ensure details (name, bio, etc.) are on the right */
  #profile-card div {
    text-align: left;
    align-items: flex-start;
  }
}

    /* Modal and Toast Animations */
    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fade-out {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes toast-enter {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes toast-exit {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(0.8); opacity: 0; }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out; }
    .animate-fade-out { animation: fade-out 0.3s ease-out forwards; }
    .animate-slide-up { animation: slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .cool-toast { animation: toast-enter 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .toast-exit { animation: toast-exit 0.4s ease-in forwards; }
  </style>
<style>
  :root {
    --dash-font-family: inherit;
    --dash-font-color: inherit;
  }
  #dashboard-content {
    font-family: var(--dash-font-family);
    color: var(--dash-font-color);
  }
  #dash-bg-container img, #dash-bg-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    position: absolute;
    top: 0;
    left: 0;
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  .dark .glass-card {
    background: rgba(15, 23, 42, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
</style>
</head>

<body class="bg-gray-100 font-sans relative" x-data x-init="document.documentElement.classList.toggle('dark', localStorage.getItem('theme')==='dark')">

<!-- Dashboard Background Container -->
<div id="dash-bg-container" class="fixed inset-0 -z-10 pointer-events-none overflow-hidden transition-all duration-500"></div>

<style>
  #dash-bg-container video, #dash-bg-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.6;
    transition: opacity 0.5s ease;
  }
  .dark #dash-bg-container video, .dark #dash-bg-container img {
    opacity: 0.3;
  }
</style>

<!-- Sidebar -->
<div class="icon-sidebar hidden md:hidden lg:flex">
  <a href="#" class="relative mb-6 p-4 active" onclick="showSection('overview')">
    <i class="fas fa-home text-xl text-gray-700"></i>
    <span class="tooltip">Dashboard</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('assignments')">
    <i class="fas fa-book text-xl text-gray-700"></i>
    <span class="tooltip">Assignments</span>
    <span id="student-assignments-badge" class="absolute -top-0.5 -right-0.5 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 text-white text-[10px] font-semibold rounded-full px-1.5 py-0.5 shadow hidden">0</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('messages')">
    <i class="fas fa-comments text-xl text-gray-700"></i>
    <span class="tooltip">Messages</span>
    <span id="student-chat-badge" class="absolute -top-0.5 -right-0.5 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('payments')">
    <i class="fas fa-wallet text-xl text-gray-700"></i>
    <span class="tooltip">Payments</span>
    <span id="student-payments-badge" class="absolute -top-0.5 -right-0.5 bg-gradient-to-r from-purple-400 via-purple-500 to-pink-500 text-white text-[10px] font-semibold rounded-full px-1.5 py-0.5 shadow hidden">0</span>
  </a>
  <a href="#" class="relative mb-6 p-4" onclick="showSection('profile')">
    <i class="fas fa-user text-xl text-pink-700"></i>
    <span class="tooltip">Profile</span>
  </a>
</div>

<!-- Bottom Navigation for Medium Screens -->
<nav class="student-bottom-nav fixed bottom-0 left-0 right-0 bg-gray-800 text-white flex justify-around items-center p-2 md:flex lg:hidden z-20">
  <button onclick="showSection('overview')" class="flex flex-col items-center">
    <i class="fas fa-home text-xl"></i>
    <span class="text-xs"></span>
  </button>
  <button onclick="showSection('assignments')" class="flex flex-col items-center relative">
    <i class="fas fa-book text-xl"></i>
    <span class="text-xs"></span>
    <span id="student-assignments-badge-mobile" class="absolute -top-1 -right-1 bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 text-white text-[10px] font-semibold rounded-full px-1.5 py-0.5 shadow hidden">0</span>
  </button>
  <button onclick="showSection('messages')" class="flex flex-col items-center relative">
    <i class="fas fa-comments text-xl"></i>
    <span class="text-xs"></span>
    <span id="student-chat-badge-mobile" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] rounded-full px-1.5 py-0.5 hidden">0</span>
  </button>
  <button onclick="showSection('payments')" class="flex flex-col items-center relative">
    <i class="fas fa-wallet text-xl"></i>
    <span class="text-xs"></span>
    <span id="student-payments-badge-mobile" class="absolute -top-1 -right-1 bg-gradient-to-r from-purple-400 via-purple-500 to-pink-500 text-white text-[10px] font-semibold rounded-full px-1.5 py-0.5 shadow hidden">0</span>
  </button>
  <button onclick="showSection('profile')" class="flex flex-col items-center">
    <i class="fas fa-user text-xl"></i>
    <span class="text-xs"></span>
  </button>
</nav>


<!-- Main Content (Ensuring Proper Layout for All Screens) -->
<main class="md:ml-16 md:pl-6 lg:ml-16 lg:pl-6 pt-6 pb-24 md:pb-6" id="dashboard-content">  
<!-- Overview Section -->
<section id="overview" class="p-6 mb-4 md:mb-16 overflow-y-auto">

  <!-- Quick Action Button -->
  <div class="mb-6">
    <button onclick="openOrderModal()" 
       class="inline-flex items-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-lg">
      <i class="fas fa-plus mr-2"></i>Place New Order
    </button>
  </div>
  
      <!-- Dashboard Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Active Assignments -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-600 text-xl">
              <i class="fas fa-book-open"></i>
            </div>
            <span class="text-xs font-bold text-blue-600 bg-blue-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">Active</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Active Assignments</h3>
          <p id="stat-active" class="text-2xl font-black text-gray-900 dark:text-white mt-2">0 in progress</p>
        </div>

        <!-- Upcoming Deadlines -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-amber-500/20 rounded-xl flex items-center justify-center text-amber-600 text-xl">
              <i class="fas fa-clock"></i>
            </div>
            <span class="text-xs font-bold text-amber-600 bg-amber-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">Urgent</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Upcoming Deadlines</h3>
          <p id="stat-deadlines" class="text-2xl font-black text-gray-900 dark:text-white mt-2">0 approaching</p>
        </div>

        <!-- Recent Messages -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-indigo-500/20 rounded-xl flex items-center justify-center text-indigo-600 text-xl">
              <i class="fas fa-comment-dots"></i>
            </div>
            <span class="text-xs font-bold text-indigo-600 bg-indigo-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">New</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Recent Messages</h3>
          <p id="stat-messages" class="text-2xl font-black text-gray-900 dark:text-white mt-2">0 unread</p>
        </div>

        <!-- Pending Payments -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-rose-500/20 rounded-xl flex items-center justify-center text-rose-600 text-xl">
              <i class="fas fa-credit-card"></i>
            </div>
            <span class="text-xs font-bold text-rose-600 bg-rose-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">Unpaid</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pending Payments</h3>
          <p id="stat-payments" class="text-2xl font-black text-gray-900 dark:text-white mt-2">$0.00 due</p>
        </div>

        <!-- Completed Assignments -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-600 text-xl">
              <i class="fas fa-check-double"></i>
            </div>
            <span class="text-xs font-bold text-emerald-600 bg-emerald-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">Finished</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Completed Assignments</h3>
          <p id="stat-completed" class="text-2xl font-black text-gray-900 dark:text-white mt-2">0 completed</p>
        </div>

        <!-- Reward Points -->
        <div class="glass-card p-6 rounded-2xl shadow-sm hover:shadow-md transition-all">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-600 text-xl">
              <i class="fas fa-award"></i>
            </div>
            <span class="text-xs font-bold text-purple-600 bg-purple-500/20 px-2.5 py-1 rounded-full uppercase tracking-wider">Loyalty</span>
          </div>
          <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Rewards Points</h3>
          <p id="stat-rewards" class="text-2xl font-black text-gray-900 dark:text-white mt-2">0 points</p>
        </div>
      </div>

      <!-- Additional Dashboard Content -->
      <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Academic News -->
        <div class="glass-card p-8 rounded-3xl shadow-sm">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white">Academic News</h3>
            <span class="text-xs font-bold text-blue-600 bg-blue-500/20 px-3 py-1.5 rounded-full uppercase">Latest Updates</span>
          </div>
          <div id="academic-news-container" class="space-y-6">
            <!-- News content here -->
          </div>
          <button class="w-full mt-6 py-3 bg-white/10 dark:bg-slate-800/20 text-gray-600 dark:text-gray-300 font-bold rounded-2xl hover:bg-white/20 dark:hover:bg-slate-700/40 transition-all text-sm border border-white/10">
            View All News
          </button>
        </div>

        <!-- Quick Writing Tips -->
        <div class="glass-card p-8 rounded-3xl shadow-xl text-white relative overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/40 to-blue-700/40 backdrop-blur-md -z-10"></div>
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">Quick Writing Tips</h3>
            <i class="fas fa-lightbulb text-yellow-300 text-xl animate-pulse"></i>
          </div>
          <div id="writing-tips-container" class="space-y-4">
            <!-- Tips content here -->
          </div>
          <div class="mt-8 pt-6 border-t border-white/20">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs text-white/60">Writing Progress</p>
                <p class="text-lg font-black">Advanced Level</p>
              </div>
              <div class="w-12 h-12 rounded-full border-4 border-white/20 flex items-center justify-center">
                <span class="text-xs font-bold">85%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
</section>

    <!-- Assignments Section -->
<section id="assignments" class="p-6 pb-20 md:pb-6 hidden">
  
    <!-- Assignments Grid -->
    <div id="assignments-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
      <!-- Dynamic assignments will be loaded here -->
    </div>
  </section>
  
<!-- Messages Section -->
<section id="messages" class="p-6 pb-20 md:pb-6 hidden">
  <script>document.write('<script src="' + (window.API_BASE || 'https://essayme2.onrender.com') + '/socket.io/socket.io.js"><\/script>');</script>

  <!-- Assignment Selection View -->
  <div id="assignment-selection-view" class="transition-all duration-500 ease-in-out">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-black text-gray-900 dark:text-white mb-3 tracking-tight">Select an Assignment</h2>
      <p class="text-gray-600 dark:text-gray-400 font-bold uppercase tracking-widest text-xs">Choose an assignment to start chatting with your tutor</p>
    </div>
    
    <div class="max-w-4xl mx-auto">
      <div class="glass-card p-8 rounded-3xl shadow-xl border border-white/20">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-600">
              <i class="fas fa-comments"></i>
            </div>
            <h3 class="text-xl font-black text-gray-900 dark:text-white uppercase tracking-tight">Your Assignments</h3>
          </div>
          <button id="refresh-assignments" class="px-6 py-3 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 transition-all font-bold shadow-lg shadow-blue-500/30 flex items-center">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
          </button>
        </div>
        
        <div class="flex flex-col space-y-4" id="assignment-chat-list">
          <!-- Dynamic Assignment List will be inserted here -->
        </div>
        
        <style>
          .assignment-unread-badge {
            position: absolute;
            top: -0.5rem;
            right: -0.5rem;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
          }
          .assignment-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
          .assignment-card:hover {
            transform: scale(1.02);
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          }
        </style>
      </div>
    </div>
  </div>

  <!-- Chat View (Initially Hidden) -->
  <div id="chat-view" class="hidden transition-all duration-500 ease-in-out">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-center justify-between mb-8">
        <div class="flex items-center space-x-6">
          <button id="back-to-assignments" class="w-12 h-12 flex items-center justify-center bg-white/10 dark:bg-slate-800/40 rounded-2xl border border-white/20 text-gray-600 dark:text-gray-300 hover:bg-blue-600 hover:text-white transition-all shadow-lg">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div>
            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Active Chat</span>
            <h2 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight" id="active-assignment-title">Loading...</h2>
          </div>
        </div>
      </div>

      <div class="glass-card rounded-3xl shadow-2xl border border-white/20 overflow-hidden flex flex-col h-[600px]">
        <!-- Chat History -->
        <div id="chat-history" class="flex-1 p-8 overflow-y-auto space-y-6 scrollbar-hide bg-white/5">
          <!-- Messages will be dynamically inserted here -->
        </div>

        <!-- Message Input -->
        <div class="p-6 border-t border-white/10 bg-white/5 backdrop-blur-xl">
          <div class="flex items-end space-x-4 bg-white/10 dark:bg-slate-900/40 p-2 rounded-2xl border border-white/10">
            <textarea id="chat-box" class="flex-1 bg-transparent border-none rounded-xl p-4 resize-none focus:ring-0 text-gray-900 dark:text-white dark:placeholder-gray-500 font-bold text-sm" 
                      placeholder="Write your message here..." rows="1"></textarea>
            <button id="send-message" class="w-14 h-14 flex items-center justify-center bg-blue-600 text-white rounded-xl shadow-xl shadow-blue-500/30 opacity-50 cursor-not-allowed transition-all hover:scale-105 active:scale-95" disabled>
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <audio id="student-new-message-audio" src="audio/receive.mp3" preload="auto"></audio>
  <audio id="student-send-audio" src="audio/send.mp3" preload="auto"></audio>
  <audio id="student-update-audio" src="audio/notify.mp3" preload="auto"></audio>
</section>


<!-- Payments Section -->
<section id="payments" class="p-6 pb-20 md:pb-6 hidden">

  <!-- Balance Notification -->
  <div id="balanceNotification" class="hidden mb-8 p-6 glass-card border-red-500/20 bg-red-500/5 rounded-3xl animate-pulse">
    <div class="flex items-center space-x-4">
      <div class="w-12 h-12 bg-red-500/20 rounded-xl flex items-center justify-center text-red-600">
        <i class="fas fa-exclamation-triangle text-xl"></i>
      </div>
      <div>
        <h3 class="font-black text-red-600 uppercase tracking-wider text-sm">Top Up Required</h3>
        <p class="text-red-500/80 text-xs font-bold leading-relaxed">Your account balance is insufficient for pending assignments. Please add funds to continue.</p>
      </div>
    </div>
  </div>

  <!-- Profile & Wallet Section -->
  <div class="glass-card p-8 rounded-3xl shadow-xl border border-white/20 mb-8 flex flex-col md:flex-row md:items-center justify-between gap-6 overflow-hidden relative">
    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-600/10 rounded-full -mr-16 -mt-16 blur-3xl"></div>
    <div class="flex items-center space-x-6 relative z-10">
      <!-- Profile Icon -->
      <div class="w-20 h-20 rounded-2xl overflow-hidden ring-4 ring-blue-500/30 shadow-2xl transform rotate-3">
        <img id="payments-profile-image" src="" alt="Profile" class="w-full h-full object-cover transform -rotate-3 scale-110">
      </div>

      <!-- Name & Wallet Balance -->
      <div class="flex flex-col">
        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Account Holder</span>
        <span class="font-black text-2xl text-gray-900 dark:text-white mb-2" id="userName">John Doe</span>
        <div class="flex items-center space-x-3">
           <span class="px-3 py-1 bg-emerald-500/20 text-emerald-600 rounded-full text-xs font-black uppercase tracking-wider border border-emerald-500/20">Balance</span>
           <span class="text-3xl font-black text-gray-900 dark:text-white" id="userBalance">$0.00</span>
        </div>
      </div>
    </div>

    <button onclick="openWithdrawPrompt()" class="relative z-10 px-8 py-4 bg-red-500/10 text-red-600 border border-red-500/20 rounded-2xl text-sm font-black uppercase tracking-widest hover:bg-red-500/20 transition-all shadow-xl shadow-red-500/10 active:scale-95 flex items-center justify-center">
      <i class="fas fa-money-bill-wave mr-3"></i>Request Withdraw
    </button>
  </div>

  <!-- Add Funds Section -->
  <div class="mb-8">
    <div class="flex items-center space-x-3 mb-6">
      <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-600">
        <i class="fas fa-plus-circle"></i>
      </div>
      <h2 class="text-2xl font-black text-gray-900 dark:text-white uppercase tracking-tight">Add Funds</h2>
    </div>
    
    <!-- Amount Input -->
    <div class="glass-card rounded-3xl p-8 mb-8 border border-white/20">
      <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Enter Deposit Amount</label>
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <div class="relative flex-1 w-full sm:max-w-xs">
          <span class="absolute left-6 top-1/2 transform -translate-y-1/2 text-gray-400 font-black text-xl">$</span>
          <input type="number" id="depositAmount" min="10" step="0.01" 
                 class="w-full pl-12 pr-6 py-5 rounded-2xl border border-white/20 bg-white/5 dark:bg-slate-800/20 text-gray-900 dark:text-white text-2xl font-black focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                 placeholder="0.00">
        </div>
        <div class="flex flex-wrap gap-2 justify-center">
          <button onclick="document.getElementById('depositAmount').value=20" class="px-4 py-2 rounded-xl bg-white/10 text-gray-600 dark:text-gray-300 font-bold hover:bg-blue-600 hover:text-white transition-all border border-white/10">$20</button>
          <button onclick="document.getElementById('depositAmount').value=50" class="px-4 py-2 rounded-xl bg-white/10 text-gray-600 dark:text-gray-300 font-bold hover:bg-blue-600 hover:text-white transition-all border border-white/10">$50</button>
          <button onclick="document.getElementById('depositAmount').value=100" class="px-4 py-2 rounded-xl bg-white/10 text-gray-600 dark:text-gray-300 font-bold hover:bg-blue-600 hover:text-white transition-all border border-white/10">$100</button>
        </div>
      </div>
      
      <p class="mt-4 text-[10px] font-bold text-gray-400">Minimum deposit is $10.00. Funds are added instantly after payment.</p>
    </div>

    <!-- Payment Methods -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      
      <!-- Paystack -->
      <div class="glass-card p-8 rounded-3xl cursor-pointer hover:shadow-2xl transition-all border border-white/20 hover:border-blue-500/50 group relative overflow-hidden"
           onclick="selectPaymentMethod('paystack')">
        <div class="absolute inset-0 bg-blue-600/5 group-hover:bg-blue-600/10 transition-colors"></div>
        <div class="text-center relative z-10">
          <div class="w-20 h-20 bg-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
            <i class="fas fa-credit-card text-3xl text-blue-600"></i>
          </div>
          <h3 class="text-lg font-black text-gray-900 dark:text-white mb-2 uppercase tracking-tight">Online Payment</h3>
          <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-4 leading-relaxed uppercase tracking-wider">Cards, Apple Pay, Google Pay</p>
          <div class="inline-block px-4 py-1.5 bg-emerald-500/20 text-emerald-600 rounded-full text-[10px] font-black uppercase tracking-widest border border-emerald-500/20">
            ✓ Instant Processing
          </div>
        </div>
      </div>

      <!-- PayPal -->
      <div class="glass-card p-8 rounded-3xl border border-white/10 opacity-40 grayscale cursor-not-allowed relative overflow-hidden">
        <div class="text-center">
          <div class="w-20 h-20 bg-gray-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <i class="fab fa-paypal text-3xl text-gray-400"></i>
          </div>
          <h3 class="text-lg font-black text-gray-400 mb-2 uppercase tracking-tight">PayPal</h3>
          <p class="text-[10px] font-bold text-gray-400 mb-4 leading-relaxed uppercase tracking-wider">Secure Online Payment</p>
          <div class="inline-block px-4 py-1.5 bg-red-500/20 text-red-600 rounded-full text-[10px] font-black uppercase tracking-widest border border-red-500/20">
            Currently Disabled
          </div>
        </div>
      </div>

      <!-- CashApp (Bitcoin) -->
      <div class="glass-card p-8 rounded-3xl cursor-pointer hover:shadow-2xl transition-all border border-white/20 hover:border-green-500/50 group relative overflow-hidden"
           onclick="selectPaymentMethod('cashapp')">
        <div class="absolute inset-0 bg-green-600/5 group-hover:bg-green-600/10 transition-colors"></div>
        <div class="text-center relative z-10">
          <div class="w-20 h-20 bg-green-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
            <i class="fas fa-mobile-alt text-3xl text-green-600"></i>
          </div>
          <h3 class="text-lg font-black text-gray-900 dark:text-white mb-2 uppercase tracking-tight">CashApp</h3>
          <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-4 leading-relaxed uppercase tracking-wider">Bitcoin Deposits Only</p>
          <div class="inline-block px-4 py-1.5 bg-orange-500/20 text-orange-600 rounded-full text-[10px] font-black uppercase tracking-widest border border-orange-500/20">
            ⏳ Manual Approval
          </div>
        </div>
      </div>

      <!-- Bitcoin -->
      <div class="glass-card p-8 rounded-3xl cursor-pointer hover:shadow-2xl transition-all border border-white/20 hover:border-yellow-500/50 group relative overflow-hidden"
           onclick="selectPaymentMethod('bitcoin')">
        <div class="absolute inset-0 bg-yellow-600/5 group-hover:bg-yellow-600/10 transition-colors"></div>
        <div class="text-center relative z-10">
          <div class="w-20 h-20 bg-yellow-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
            <i class="fab fa-bitcoin text-3xl text-yellow-600"></i>
          </div>
          <h3 class="text-lg font-black text-gray-900 dark:text-white mb-2 uppercase tracking-tight">Bitcoin</h3>
          <p class="text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-4 leading-relaxed uppercase tracking-wider">Direct Crypto Transfer</p>
          <div class="inline-block px-4 py-1.5 bg-orange-500/20 text-orange-600 rounded-full text-[10px] font-black uppercase tracking-widest border border-orange-500/20">
            ⏳ Manual Approval
          </div>
        </div>
      </div>
    </div>

    <!-- Payment History -->
    <div class="glass-card p-8 rounded-3xl shadow-xl border border-white/20">
      <div class="flex items-center justify-between mb-8">
        <h2 class="text-xl font-black text-gray-900 dark:text-white uppercase tracking-tight">Transaction History</h2>
        <i class="fas fa-history text-gray-400"></i>
      </div>
      <div id="paymentsList" class="space-y-4"></div>
    </div>
  </div>
</section>


<!-- Profile Section -->
<section id="profile" class="p-6 pb-20 md:pb-6 max-w-6xl mx-auto hidden">

  <!-- Profile Card (Medium & Large Screens) -->
  <div id="profile-card" class="glass-card rounded-xl p-8 border border-gray-200 flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-x-8">

    <!-- Profile Picture (Small & Medium Screens - Popup on Click) -->
    <div class="flex justify-center md:hidden">
      <img id="profile-picture"
          src="" 
          alt="Profile Picture"
          class="w-24 h-24 rounded-full border-4 border-blue-500 shadow-lg hover:scale-105 transition-all duration-300 cursor-pointer"
          onclick="openProfilePicturePopup()">
    </div>

    <!-- Profile Picture (Large Screens - Direct Upload on Click) -->
    <div class="hidden md:flex justify-center">
      <label for="profile-upload" class="cursor-pointer">
          <img id="profile-picture-lg"
              src=""
              alt="Profile Picture"
              class="w-32 md:w-36 lg:w-44 h-32 md:h-36 lg:h-44 rounded-full border-4 border-gray-300 shadow-lg hover:scale-105 transition-all duration-300">
          <div id="profile-upload-placeholder" class="text-xs text-gray-500 mt-2"></div>
      </label>
      <input type="file" id="profile-upload" class="hidden">
    </div>

<!-- User Info -->
<div class="flex-1 text-left w-full"> 
  <h2 id="user-name" class="text-3xl font-semibold text-gray-800">John Doe</h2>
  <p id="user-email" class="text-md text-blue-600 font-awesome underline">johndoe@example.com</p>

  <!-- Phone -->
  <div class="mt-2">
    <p class="text-gray-600 text-sm font-medium">Phone:</p>
    <p id="user-phone" class="text-gray-800">Not set</p>
  </div>
  
  <!-- Bio -->
  <div class="mt-4">
    <p class="text-gray-600 text-sm font-medium">Bio:</p>
    <p id="user-bio" class="text-gray-800">No bio available.</p>
  </div>

  <!-- Wallet Balance -->
  <div class="mt-4">
    <p class="text-gray-600 text-sm font-medium">Wallet Balance</p>
    <h3 id="wallet-balance" class="text-2xl font-semibold text-green-600">$0.00</h3>
  </div>

<!-- Profile Completion -->
<!-- Profile progress removed as requested -->

<!-- Social media removed -->
</div>
</div>

<!-- Profile Action Buttons -->
<div class="flex flex-col sm:flex-row justify-end gap-3 mt-6 w-full">
  <button onclick="openChatSettings()" 
      class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold rounded-full shadow-xl hover:from-purple-600 hover:to-pink-600 transition-all duration-300 flex items-center justify-center">
      <i class="fas fa-palette mr-2"></i>Customize Chat
  </button>
  <button onclick="enableEditProfile()" 
      class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-xl hover:bg-blue-700 transition-all duration-300">
      Edit Profile
  </button>
  <button onclick="logout()" 
      class="px-6 py-3 bg-red-600 text-white font-semibold rounded-full shadow-xl hover:bg-red-700 transition-all duration-300 flex items-center justify-center">
      <i class="fas fa-sign-out-alt mr-2"></i>Logout
  </button>
</div>



<!-- Edit Profile Section (Full-Screen Mode) -->
<div id="edit-profile-form" class="hidden glass-card rounded-xl shadow-xl p-6 inset-0">
  
  <!-- Back Button -->
  <button onclick="cancelEdit()" class="text-gray-600 text-2xl mb-4">←</button>

  <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">Edit Profile</h2>

  <!-- Profile Picture Edit -->
  <div class="flex justify-center">
    <img id="edit-profile-picture"
      src="https://i.imgur.com/vrNbBwT.png" 
      alt="Profile Picture"
      class="w-32 h-32 lg:w-44 lg:h-44 rounded-full border-4 border-gray-300 shadow-lg cursor-pointer"
      onclick="openProfilePicturePopup()">
  </div>

  <!-- Name, Bio, Email, Phone -->
  <div class="mt-6 grid lg:grid-cols-2 gap-6">
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Name</label>
      <input type="text" id="edit-username" class="w-full border rounded-lg p-3 shadow-sm">
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Bio</label>
      <textarea id="edit-bio" rows="4" class="w-full border rounded-lg p-3 shadow-sm"></textarea>
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Email</label>
      <input type="email" id="edit-email" class="w-full border rounded-lg p-3 shadow-sm" placeholder="Enter email">
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-2">Phone Number</label>
      <input type="text" id="edit-phone" class="w-full border rounded-lg p-3 shadow-sm" placeholder="e.g. +1 555 123 4567">
    </div>
  </div>

  <!-- Password Update -->
  <div class="mt-6">
    <label class="block text-gray-700 font-semibold mb-2">Change Password</label>
    <button onclick="openPasswordPopup()" class="w-full border rounded-lg p-3 text-left shadow-sm bg-gray-100">
      Update Password
    </button>
  </div>

  <!-- Save Button -->
  <div class="mt-6 flex justify-end">
    <button onclick="saveProfile()" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition-all">
        Save Changes
    </button>
  </div>

</div>


<!-- Popup Modal for Phone Number -->
<div id="phone-popup" class="hidden fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center z-[70]">
  <div class="glass-card rounded-lg p-6 w-4/5 max-w-lg shadow-2xl">
    <h3 class="text-lg font-semibold mb-4">Add Phone Number</h3>
    
    <!-- Country Code and Phone Number (Horizontal Layout) -->
    <div class="flex mb-4 space-x-4">
      <div class="w-1/3">
        <label class="block text-gray-700">Country Code</label>
        <select id="country-code" class="w-full border rounded-lg p-3">
          <option value="+1">+1 (USA)</option>
          <option value="+44">+44 (UK)</option>
          <option value="+91">+91 (India)</option>
          <!-- Add more country codes as needed -->
        </select>
      </div>

      <div class="flex-1">
        <label class="block text-gray-700">Phone Number</label>
        <input type="text" id="new-phone-number" class="w-full border rounded-lg p-3" placeholder="Enter phone number">
      </div>
    </div>

    <!-- Popup Actions -->
    <div class="flex justify-between">
      <button onclick="closePhonePopup()" class="text-gray-500 hover:text-gray-700">Cancel</button>
      <button onclick="savePhoneNumber()" class="bg-blue-500 text-white px-4 py-2 rounded-lg">Save</button>
    </div>
  </div>
</div>

  <!-- Profile Picture Popup (replaced with simple file picker) -->
  <div id="profile-picture-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Change Profile Picture</h3>
      <input type="file" id="popup-profile-upload" accept="image/*" class="w-full border rounded p-2" />
      <div class="flex justify-end space-x-2 mt-4">
        <button class="px-4 py-2 bg-gray-200 rounded" onclick="closeProfilePicturePopup()">Cancel</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" onclick="savePopupProfileImage()">Save</button>
      </div>
    </div>
  </div>

  <!-- Password Update Popup -->
  <div id="password-popup" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-80">
      <h3 class="text-lg font-semibold text-gray-800">Change Password</h3>
      <input type="password" id="current-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="Current Password">
      <input type="password" id="new-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="New Password">
      <input type="password" id="confirm-password" class="w-full border rounded-lg p-3 shadow-sm mt-2" placeholder="Confirm Password">
      <button class="text-blue-500 mt-2" onclick="forgotPassword()">Forgot Password?</button>
      <button class="mt-4 w-full px-4 py-2 bg-green-500 text-white rounded-lg" onclick="saveNewPassword()">Change Password</button>
      <button class="mt-2 w-full px-4 py-2 bg-gray-300 rounded-lg" onclick="closePasswordPopup()">Cancel</button>
    </div>
  </div>


    <!-- Advanced Settings -->
    <div class="glass-card p-8 rounded-xl shadow-xl mt-8">
      <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-6">Advanced Settings</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Notifications -->
        <div class="space-y-6">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300 text-lg">Notifications</h3>
          <div class="space-y-3">
            <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
              <span class="text-gray-600 dark:text-gray-400">Email Notifications</span>
              <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked id="emailNotifications">
            </label>
            <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
              <span class="text-gray-600 dark:text-gray-400">SMS Notifications</span>
              <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" id="smsNotifications">
            </label>
            <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
              <span class="text-gray-600 dark:text-gray-400">Push Notifications</span>
              <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked id="pushNotifications">
            </label>
            <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
              <span class="text-gray-600 dark:text-gray-400">Order Updates</span>
              <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked id="orderNotifications">
            </label>
          </div>
        </div>
  
        <!-- Theme Preferences -->
        <div class="space-y-6">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300 text-lg">Theme & Display</h3>
          <div class="space-y-4">
            <div>
              <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3">Color Scheme</h4>
              <div class="grid grid-cols-3 gap-3">
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 dark:hover:border-blue-500 transition-all">
                  <input type="radio" name="theme" class="sr-only" value="light" checked onchange="setTheme('light')">
                  <div class="w-8 h-8 bg-gray-100 dark:bg-slate-800 rounded-full mb-2 border-2 border-transparent"></div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">Light</span>
                </label>
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 dark:hover:border-blue-500 transition-all">
                  <input type="radio" name="theme" class="sr-only" value="dark" onchange="setTheme('dark')">
                  <div class="w-8 h-8 bg-gray-900 rounded-full mb-2 border-2 border-transparent"></div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">Dark</span>
                </label>
                <label class="flex flex-col items-center p-3 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:border-blue-500 dark:hover:border-blue-500 transition-all">
                  <input type="radio" name="theme" class="sr-only" value="auto" onchange="setTheme('auto')">
                  <div class="w-8 h-8 bg-gradient-to-r from-gray-100 to-gray-900 rounded-full mb-2 border-2 border-transparent"></div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">Auto</span>
                </label>
              </div>
            </div>
            
            <div>
              <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-3">Font Size</h4>
              <input type="range" id="fontSizeSlider" min="12" max="20" value="16" class="w-full h-2 bg-gray-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer" oninput="updateFontSize(this.value)">
              <div class="flex justify-between text-xs text-gray-500 dark:text-gray-500 mt-1">
                <span>Small</span>
                <span>Medium</span>
                <span>Large</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Dashboard Customization -->
        <div class="lg:col-span-2 mt-8 border-t pt-8">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300 text-lg mb-6">Dashboard Customization</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- Background Color -->
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Background Color</label>
              <input type="color" id="dash-bg-color" class="w-full h-10 rounded-lg cursor-pointer bg-transparent border border-gray-200 dark:border-gray-700" onchange="applyDashBg('color', this.value)">
            </div>
            <!-- Photo/Video Upload -->
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Background Image/Video</label>
              <input type="file" id="dash-bg-upload" accept="image/*,video/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="handleDashBgUpload(this)">
            </div>
            <!-- Font Style -->
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Font Family</label>
              <select id="dash-font-family" class="w-full p-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-blue-500" onchange="applyDashFont('family', this.value)">
                <option value="inherit">Default (Sans)</option>
                <option value="'Inter', sans-serif">Inter</option>
                <option value="'Poppins', sans-serif">Poppins</option>
                <option value="'Roboto', sans-serif">Roboto</option>
                <option value="'Merriweather', serif">Merriweather (Serif)</option>
                <option value="'JetBrains Mono', monospace">JetBrains Mono</option>
              </select>
            </div>
            <!-- Font Color -->
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">Primary Text Color</label>
              <input type="color" id="dash-font-color" class="w-full h-10 rounded-lg cursor-pointer bg-transparent border border-gray-200 dark:border-gray-700" onchange="applyDashFont('color', this.value)">
            </div>
          </div>
          <div class="flex flex-wrap gap-3 mt-6">
            <button onclick="resetDashBg()" class="px-4 py-2 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 transition-all text-sm font-semibold">
              Reset Background
            </button>
            <button onclick="resetDashFont()" class="px-4 py-2 bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 transition-all text-sm font-semibold">
              Reset Fonts
            </button>
            <button onclick="resetAllSettings()" class="px-4 py-2 bg-red-200 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-lg hover:bg-red-300 dark:hover:bg-red-900/50 transition-all text-sm font-semibold">
              Reset All Settings
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-4 italic">Customize your dashboard to match your style. High-resolution videos may slow down your experience.</p>
        </div>

        <!-- Privacy & Security -->
        <div class="lg:col-span-2 mt-8 border-t pt-8">
          <h3 class="font-semibold text-gray-700 dark:text-gray-300 text-lg mb-6">Privacy & Security</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
              <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400">Data Privacy</h4>
              <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
                <span class="text-gray-600 dark:text-gray-400">Analytics Tracking</span>
                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" checked id="analyticsTracking">
              </label>
              <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
                <span class="text-gray-600 dark:text-gray-400">Personalized Ads</span>
                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" id="personalizedAds">
              </label>
            </div>
            <div class="space-y-4">
              <h4 class="text-sm font-medium text-gray-600 dark:text-gray-400">Security</h4>
              <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
                <span class="text-gray-600 dark:text-gray-400">Two-Factor Auth</span>
                <input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500" id="twoFactorAuth">
              </label>
              <label class="flex items-center justify-between p-3 bg-gray-50 dark:bg-slate-800 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 transition-all">
                <span class="text-gray-600 dark:text-gray-400">Session Timeout</span>
                <select id="sessionTimeout" class="bg-transparent text-sm text-gray-600 dark:text-gray-400 focus:ring-0 border-none">
                  <option value="30">30 minutes</option>
                  <option value="60">1 hour</option>
                  <option value="120">2 hours</option>
                  <option value="240">4 hours</option>
                </select>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>  
  </main>

  <!-- Order Modal -->
  <div id="orderModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-all duration-300">
    <div class="glass-card dark:bg-gray-900 rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col overflow-hidden border border-white/20 dark:border-gray-800 modal-content">
      <!-- Modal Header -->
      <div class="px-8 py-6 flex justify-between items-center bg-gradient-to-r from-blue-600/5 to-indigo-600/5 dark:from-blue-600/10 dark:to-indigo-600/10 border-b dark:border-gray-800">
        <div class="flex items-center space-x-4">
          <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/20">
            <i class="fas fa-shopping-cart text-white text-xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-black text-gray-900 dark:text-white tracking-tight">Place New Order</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium">Professional help is just a few clicks away</p>
          </div>
        </div>
        <button onclick="closeOrderModal()" class="group w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-500 hover:bg-red-500 hover:text-white transition-all duration-300">
          <i class="fas fa-times text-lg group-hover:rotate-90 transition-transform"></i>
        </button>
      </div>

      <!-- Stepper -->
      <div class="px-8 py-8 bg-gray-50/50 dark:bg-gray-900/50 border-b dark:border-gray-800">
        <div class="flex items-center justify-between max-w-2xl mx-auto relative">
          <!-- Progress Line Background -->
          <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-200 dark:bg-gray-800 -translate-y-1/2 z-0"></div>
          <!-- Dynamic Progress Line -->
          <div id="stepper-progress" class="absolute top-1/2 left-0 h-1 bg-blue-600 -translate-y-1/2 z-0 transition-all duration-500" style="width: 0%"></div>
          
          <!-- Steps -->
          <div class="step-container group relative z-10" onclick="goToStep(1)">
            <div class="step-circle w-10 h-10 rounded-full bg-white dark:bg-gray-900 border-2 border-blue-600 flex items-center justify-center font-bold text-blue-600 transition-all duration-300 shadow-md active" data-step="1">1</div>
            <span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-bold uppercase tracking-wider text-blue-600 whitespace-nowrap">Course</span>
          </div>
          <div class="step-container group relative z-10" onclick="goToStep(2)">
            <div class="step-circle w-10 h-10 rounded-full bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-800 flex items-center justify-center font-bold text-gray-400 transition-all duration-300 shadow-sm" data-step="2">2</div>
            <span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-bold uppercase tracking-wider text-gray-400 whitespace-nowrap">Type</span>
          </div>
          <div class="step-container group relative z-10" onclick="goToStep(3)">
            <div class="step-circle w-10 h-10 rounded-full bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-800 flex items-center justify-center font-bold text-gray-400 transition-all duration-300 shadow-sm" data-step="3">3</div>
            <span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-bold uppercase tracking-wider text-gray-400 whitespace-nowrap">Details</span>
          </div>
          <div class="step-container group relative z-10" onclick="goToStep(4)">
            <div class="step-circle w-10 h-10 rounded-full bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-800 flex items-center justify-center font-bold text-gray-400 transition-all duration-300 shadow-sm" data-step="4">4</div>
            <span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-bold uppercase tracking-wider text-gray-400 whitespace-nowrap">Files</span>
          </div>
          <div class="step-container group relative z-10" onclick="goToStep(5)">
            <div class="step-circle w-10 h-10 rounded-full bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-800 flex items-center justify-center font-bold text-gray-400 transition-all duration-300 shadow-sm" data-step="5">5</div>
            <span class="absolute -bottom-7 left-1/2 -translate-x-1/2 text-[10px] font-bold uppercase tracking-wider text-gray-400 whitespace-nowrap">Review</span>
          </div>
        </div>
      </div>

      <!-- Modal Content -->
      <div class="flex-1 overflow-y-auto p-8">
        <form id="orderForm" class="space-y-8">
          
          <!-- Step 1: Course Selection -->
          <div id="step-1" class="order-step space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="text-center space-y-2">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">What can we help you with?</h3>
              <p class="text-gray-500 dark:text-gray-400">Select the subject area for your assignment</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Liberal Arts -->
              <div class="group p-6 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-all duration-300 hover:border-blue-500/30">
                <div class="flex items-center space-x-4 mb-4">
                  <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                    <i class="fas fa-book-open"></i>
                  </div>
                  <h4 class="font-bold text-gray-900 dark:text-white">Liberal Arts</h4>
                </div>
                <select id="liberalArtsSubject" class="w-full p-3.5 bg-gray-50 dark:bg-gray-900 border-none rounded-xl focus:ring-2 focus:ring-blue-500 text-gray-700 dark:text-gray-300 transition-all">
                  <option value="">Select Subject</option>
                  <option value="English Literature">English Literature</option>
                  <option value="History">History</option>
                  <option value="Philosophy">Philosophy</option>
                  <option value="Psychology">Psychology</option>
                  <option value="Sociology">Sociology</option>
                  <option value="Political Science">Political Science</option>
                </select>
              </div>
              
              <!-- Business -->
              <div class="group p-6 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-all duration-300 hover:border-indigo-500/30">
                <div class="flex items-center space-x-4 mb-4">
                  <div class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                    <i class="fas fa-briefcase"></i>
                  </div>
                  <h4 class="font-bold text-gray-900 dark:text-white">Business</h4>
                </div>
                <select id="businessSubject" class="w-full p-3.5 bg-gray-50 dark:bg-gray-900 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 text-gray-700 dark:text-gray-300 transition-all">
                  <option value="">Select Subject</option>
                  <option value="Business Administration">Business Administration</option>
                  <option value="Marketing">Marketing</option>
                  <option value="Finance">Finance</option>
                  <option value="Economics">Economics</option>
                  <option value="Management">Management</option>
                  <option value="Accounting">Accounting</option>
                </select>
              </div>
              
              <!-- Sciences -->
              <div class="group p-6 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-all duration-300 hover:border-emerald-500/30">
                <div class="flex items-center space-x-4 mb-4">
                  <div class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600 dark:text-emerald-400 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                    <i class="fas fa-microscope"></i>
                  </div>
                  <h4 class="font-bold text-gray-900 dark:text-white">Sciences</h4>
                </div>
                <select id="scienceSubject" class="w-full p-3.5 bg-gray-50 dark:bg-gray-900 border-none rounded-xl focus:ring-2 focus:ring-emerald-500 text-gray-700 dark:text-gray-300 transition-all">
                  <option value="">Select Subject</option>
                  <option value="Biology">Biology</option>
                  <option value="Chemistry">Chemistry</option>
                  <option value="Environmental Science">Environmental Science</option>
                  <option value="Health Sciences">Health Sciences</option>
                  <option value="Nursing">Nursing</option>
                </select>
              </div>
              
              <!-- Technical -->
              <div class="group p-6 bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-all duration-300 hover:border-purple-500/30">
                <div class="flex items-center space-x-4 mb-4">
                  <div class="w-10 h-10 rounded-xl bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                    <i class="fas fa-laptop-code"></i>
                  </div>
                  <h4 class="font-bold text-gray-900 dark:text-white">Technical</h4>
                </div>
                <select id="technicalSubject" class="w-full p-3.5 bg-gray-50 dark:bg-gray-900 border-none rounded-xl focus:ring-2 focus:ring-purple-500 text-gray-700 dark:text-gray-300 transition-all">
                  <option value="">Select Subject</option>
                  <option value="Mathematics">Mathematics</option>
                  <option value="Physics">Physics</option>
                  <option value="Engineering">Engineering</option>
                  <option value="Computer Science">Computer Science</option>
                  <option value="Statistics">Statistics</option>
                  <option value="Calculus">Calculus</option>
                </select>
              </div>

              <!-- Other -->
              <div class="md:col-span-2 p-6 bg-gradient-to-r from-gray-50 to-slate-100 dark:from-gray-800/50 dark:to-gray-900/50 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700">
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 text-center">Don't see your subject? Enter it below</label>
                <div class="relative max-w-md mx-auto">
                  <input type="text" id="customSubject" placeholder="Enter custom subject" 
                         class="w-full p-4 pl-12 bg-white dark:bg-gray-900 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 shadow-sm transition-all dark:text-white">
                  <i class="fas fa-pencil-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Assignment Type -->
          <div id="step-2" class="order-step hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="text-center space-y-2">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Choose Assignment Type</h3>
              <p class="text-gray-500 dark:text-gray-400 font-medium">Select the type of work and specify the length</p>
            </div>

            <div class="space-y-6">
              <!-- Writing Assignments -->
              <div class="p-6 bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-sm">
                <div class="flex items-center justify-between mb-6">
                  <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">
                      <i class="fas fa-pen-nib"></i>
                    </div>
                    <h4 class="font-bold text-gray-900 dark:text-white text-lg tracking-tight">Writing Assignments</h4>
                  </div>
                  <span class="px-3 py-1 bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 text-xs font-bold rounded-full text-center">Admin will review price</span>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="essay" data-price="custom" data-category="writing" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-blue-600 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-blue-600 dark:peer-checked:text-blue-400">Essay</span>
                    </div>
                  </label>
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="research-paper" data-price="custom" data-category="writing" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-blue-600 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-blue-600 dark:peer-checked:text-blue-400">Research</span>
                    </div>
                  </label>
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="discussion-post" data-price="custom" data-category="writing" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-blue-600 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-blue-600 dark:peer-checked:text-blue-400">Discussion</span>
                    </div>
                  </label>
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="summary" data-price="custom" data-category="writing" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-blue-600 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-blue-600 dark:peer-checked:text-blue-400">Summary</span>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Technical Assignments -->
              <div class="p-6 bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-sm">
                <div class="flex items-center justify-between mb-6">
                  <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-purple-50 dark:bg-purple-900/30 flex items-center justify-center text-purple-600 dark:text-purple-400">
                      <i class="fas fa-atom"></i>
                    </div>
                    <h4 class="font-bold text-gray-900 dark:text-white text-lg tracking-tight">Technical Assignments</h4>
                  </div>
                  <span class="px-3 py-1 bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300 text-xs font-bold rounded-full">Custom Pricing</span>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="math-problems" data-price="custom" data-category="technical" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-purple-600 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-purple-600 dark:peer-checked:text-purple-400">Mathematics</span>
                    </div>
                  </label>
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="programming" data-price="custom" data-category="technical" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-purple-600 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-purple-600 dark:peer-checked:text-purple-400">Programming</span>
                    </div>
                  </label>
                  <label class="group relative cursor-pointer">
                    <input type="radio" name="assignmentType" value="statistics" data-price="custom" data-category="technical" class="sr-only peer">
                    <div class="p-4 bg-gray-50 dark:bg-gray-900/50 border-2 border-transparent rounded-2xl text-center transition-all peer-checked:border-purple-600 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/20 group-hover:bg-gray-100 dark:group-hover:bg-gray-900">
                      <span class="block text-sm font-bold text-gray-700 dark:text-gray-300 peer-checked:text-purple-600 dark:peer-checked:text-purple-400">Statistics</span>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Pages Section -->
              <div id="pagesSection" class="hidden animate-in fade-in zoom-in-95 duration-300">
                <div class="p-8 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl text-white shadow-xl shadow-blue-500/20">
                  <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                      <div>
                        <h4 class="text-xl font-bold mb-1">Number of Pages</h4>
                        <p class="text-blue-100 text-sm font-medium">Approx. 250 words per page</p>
                      </div>
                      <div class="flex items-center bg-white/10 p-2 rounded-2xl backdrop-blur-md border border-white/20">
                        <button type="button" onclick="var p = document.getElementById('pages'); p.stepDown(); p.dispatchEvent(new Event('input'));" class="w-12 h-12 flex items-center justify-center hover:bg-white/10 rounded-xl transition-colors">
                          <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="pages" min="1" max="100" value="1" placeholder="Number of pages"
                               class="w-24 bg-transparent border-none text-center text-2xl font-black focus:ring-0 placeholder-blue-200 text-white">
                        <button type="button" onclick="var p = document.getElementById('pages'); p.stepUp(); p.dispatchEvent(new Event('input'));" class="w-12 h-12 flex items-center justify-center hover:bg-white/10 rounded-xl transition-colors">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>

                    <div class="pt-4 border-t border-white/10">
                      <label class="flex items-center space-x-3 cursor-pointer group">
                        <div class="relative flex items-center">
                          <input type="checkbox" id="readInstructions" class="sr-only peer" onchange="togglePagesInput(this)">
                          <div class="w-12 h-6 bg-white/10 rounded-full peer peer-checked:bg-emerald-500 transition-all border border-white/20"></div>
                          <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all peer-checked:translate-x-6"></div>
                        </div>
                        <span class="text-sm font-bold text-white group-hover:text-emerald-300 transition-colors">Not sure? Just read my instructions for length.</span>
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <div id="technicalNote" class="hidden p-5 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/50 rounded-2xl text-amber-800 dark:text-amber-300 text-sm flex items-start space-x-3 animate-in fade-in duration-300">
                <div class="w-6 h-6 rounded-full bg-amber-200 dark:bg-amber-800 flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-info text-[10px]"></i>
                </div>
                <p class="font-medium">All assignments require admin review. We'll provide a confirmed quote after reviewing your materials.</p>
              </div>
            </div>
          </div>

          <!-- Step 3: Assignment Details -->
          <div id="step-3" class="order-step hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="text-center space-y-2">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Assignment Details</h3>
              <p class="text-gray-500 dark:text-gray-400 font-medium">Provide the specifics of your task</p>
            </div>
            
            <div class="space-y-6">
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 ml-1">Assignment Title</label>
                <input type="text" id="assignmentTitle" 
                       class="w-full p-4 bg-gray-50 dark:bg-gray-900 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-gray-800 rounded-2xl transition-all outline-none text-gray-900 dark:text-white placeholder-gray-400" 
                       placeholder="e.g., Analysis of Global Warming Trends" required>
              </div>
              
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 ml-1">Detailed Instructions</label>
                <textarea id="assignmentDescription" rows="5" 
                          class="w-full p-4 bg-gray-50 dark:bg-gray-900 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-gray-800 rounded-2xl transition-all outline-none text-gray-900 dark:text-white placeholder-gray-400 resize-none" 
                          placeholder="Provide as much detail as possible to get the best result..." required></textarea>
              </div>
              
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 ml-1">Formatting & Special Requirements (Optional)</label>
                <textarea id="additionalRequirements" rows="2" 
                          class="w-full p-4 bg-gray-50 dark:bg-gray-900 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-gray-800 rounded-2xl transition-all outline-none text-gray-900 dark:text-white placeholder-gray-400 resize-none" 
                          placeholder="Citation style (APA, MLA), specific sources, font size..."></textarea>
              </div>
            </div>
          </div>

          <!-- Step 4: File Upload & Deadline -->
          <div id="step-4" class="order-step hidden space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="space-y-6">
              <div class="text-center space-y-2">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Materials & Timeline</h3>
                <p class="text-gray-500 dark:text-gray-400 font-medium">Upload your files and set your deadline</p>
              </div>
              
              <div class="relative group">
                <input type="file" id="fileUpload" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xlsx,.xls,.ppt,.pptx" class="hidden">
                <div onclick="document.getElementById('fileUpload').click()" 
                     class="border-3 border-dashed border-gray-200 dark:border-gray-800 rounded-3xl p-12 text-center cursor-pointer group-hover:border-blue-500 group-hover:bg-blue-50 dark:group-hover:bg-blue-900/10 transition-all duration-300">
                  <div class="w-20 h-20 bg-blue-50 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform duration-300">
                    <i class="fas fa-cloud-upload-alt text-4xl text-blue-600 dark:text-blue-400"></i>
                  </div>
                  <p class="text-xl text-gray-900 dark:text-white font-bold">Drop files here or click to browse</p>
                  <p class="text-gray-500 dark:text-gray-400 font-medium mt-2">Support: PDF, DOCX, Images, etc. (Max 50MB)</p>
                </div>
                <div id="fileList" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
              </div>
            </div>

            <div class="p-8 bg-gray-50 dark:bg-gray-800/50 rounded-3xl border border-gray-100 dark:border-gray-800 space-y-8">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-end">
                <div class="space-y-3">
                  <label class="flex items-center space-x-2 text-sm font-bold text-gray-700 dark:text-gray-300 ml-1">
                    <i class="fas fa-calendar-alt text-blue-600"></i>
                    <span>Due Date & Time *</span>
                  </label>
                  <input type="datetime-local" id="dueDateTime" 
                         class="w-full p-4 bg-white dark:bg-gray-900 border-2 border-transparent focus:border-blue-500 rounded-2xl transition-all outline-none text-gray-900 dark:text-white font-bold shadow-sm" required>
                </div>
                
                <!-- Proposed Budget Section (Toggled via JS) -->
                <div id="proposedBudgetSection" class="hidden space-y-3">
                  <label class="flex items-center space-x-2 text-sm font-bold text-gray-700 dark:text-gray-300 ml-1">
                    <i class="fas fa-hand-holding-usd text-emerald-600"></i>
                    <span>Your Proposed Budget ($) *</span>
                  </label>
                  <div class="relative">
                    <input type="number" id="proposedBudget" min="1" placeholder="Ex: 50"
                           class="w-full p-4 pl-10 bg-white dark:bg-gray-900 border-2 border-transparent focus:border-emerald-500 rounded-2xl transition-all outline-none text-gray-900 dark:text-white font-black shadow-sm">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                  </div>
                </div>
              </div>

              <div class="bg-blue-600/5 dark:bg-blue-400/5 p-6 rounded-2xl border border-blue-100 dark:border-blue-900/30 flex items-start space-x-4">
                <div class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/20">
                  <i class="fas fa-shield-alt text-white"></i>
                </div>
                <div>
                  <h5 class="text-sm font-bold text-blue-900 dark:text-blue-200 mb-1">Pricing Policy</h5>
                  <p class="text-xs text-blue-700/80 dark:text-blue-300/80 leading-relaxed font-medium">
                    The final price will be confirmed by our admin after reviewing your instructions. Your proposed budget helps us match you with the best expert.
                  </p>
                </div>
              </div>

              <div id="timeWarning" class="hidden mt-6 p-5 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800/50 rounded-2xl text-red-800 dark:text-red-300 flex items-start space-x-4 animate-in fade-in slide-in-from-top-2">
                <div class="w-10 h-10 rounded-xl bg-red-600 flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-white"></i>
                </div>
                <div>
                  <p class="font-bold text-lg leading-tight">Deadline too close!</p>
                  <p class="text-sm font-medium mt-1">We need at least 2 hours to ensure quality work. Please select a later time.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 5: Final Confirmation & Review -->
          <div id="step-5" class="order-step hidden space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="text-center space-y-2">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Review Your Order</h3>
              <p class="text-gray-500 dark:text-gray-400 font-medium">Double-check everything before submitting</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
              <!-- Order Summary Details -->
              <div class="lg:col-span-3 space-y-4">
                <div class="p-6 bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-sm space-y-6">
                  <div class="flex items-start justify-between pb-6 border-b dark:border-gray-700">
                    <div class="space-y-1">
                      <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Subject & Type</p>
                      <h4 id="review-subject" class="text-xl font-bold text-gray-900 dark:text-white">-</h4>
                      <p id="review-type" class="text-sm font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-lg inline-block mt-2">-</p>
                    </div>
                    <div class="text-right">
                      <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Length</p>
                      <p id="review-length" class="text-sm font-bold text-gray-900 dark:text-white mt-1">1 Page</p>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                      <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Assignment Title</p>
                      <p id="review-title" class="text-lg font-bold text-gray-800 dark:text-gray-200 leading-tight truncate">-</p>
                    </div>
                    <div class="space-y-2 text-right">
                      <p class="text-[10px] font-black uppercase tracking-widest text-gray-400">Deadline</p>
                      <p id="review-deadline" class="text-lg font-bold text-gray-800 dark:text-gray-200 leading-tight">-</p>
                    </div>
                  </div>
                </div>

                <div class="p-6 bg-blue-600 rounded-3xl text-white shadow-xl shadow-blue-500/20">
                  <div class="flex items-start space-x-4">
                    <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center flex-shrink-0">
                      <i class="fas fa-user-shield text-xl"></i>
                    </div>
                    <div>
                      <h4 class="text-lg font-bold">Admin Review Process</h4>
                      <p class="text-blue-100 text-sm font-medium mt-1 leading-relaxed">
                        An administrator will review your instructions and materials within minutes. We will communicate the final price and confirm your expert via the website dashboard.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Price Breakdown Card -->
              <div class="lg:col-span-2">
                <div class="p-8 bg-gray-900 dark:bg-black rounded-3xl text-white sticky top-0 shadow-2xl overflow-hidden relative">
                  <!-- Decorative circle -->
                  <div class="absolute -right-4 -top-4 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl"></div>
                  
                  <h4 class="text-lg font-black tracking-tight mb-8 flex items-center relative z-10">
                    <i class="fas fa-file-invoice-dollar mr-3 text-emerald-500"></i>
                    Pricing Review
                  </h4>
                  
                  <div class="space-y-6 mb-10 relative z-10">
                    <div class="flex justify-between items-center text-gray-400 font-bold">
                      <span id="review-price-label">Proposed Budget</span>
                      <span id="review-proposed-budget" class="text-white text-xl">$0.00</span>
                    </div>

                    <div id="couponDiscountRow" class="space-y-2 hidden">
                      <div class="flex justify-between items-center text-green-400 font-bold">
                        <span class="text-xs uppercase tracking-wider">Total Discounts</span>
                        <span id="review-coupon-discount">-$0.00</span>
                      </div>
                      <div id="appliedCouponsList" class="flex flex-wrap gap-2 py-2 border-t border-gray-800">
                        <!-- Applied coupons will appear here -->
                      </div>
                    </div>
                    
                    <div class="h-px bg-gray-800 my-4"></div>

                    <div class="mt-4">
                      <div class="flex space-x-2">
                        <input type="text" id="couponCode" placeholder="Promo Code" 
                               class="flex-1 bg-gray-800 border-none rounded-xl p-3 text-sm focus:ring-1 focus:ring-emerald-500 text-white placeholder-gray-500 uppercase font-bold">
                        <div class="flex flex-col space-y-1">
                          <button type="button" onclick="applyCoupon()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl text-xs font-black transition-all">
                            Redeem
                          </button>
                        </div>
                      </div>
                      <p id="couponMessage" class="hidden mt-2 text-[11px] font-bold"></p>
                    </div>
                    
                    <div class="space-y-4">
                      <div class="flex items-center space-x-3 text-amber-400">
                        <i class="fas fa-hourglass-half text-sm"></i>
                        <span class="text-xs font-bold uppercase tracking-wider">Awaiting Admin Confirmation</span>
                      </div>
                      <p class="text-[11px] text-gray-400 leading-relaxed font-medium">
                        The price shown is your proposed budget. The final cost may be adjusted based on the complexity of your requirements.
                      </p>
                    </div>
                  </div>

                  <div class="mt-8 flex flex-col space-y-3 relative z-10">
                    <div class="flex items-center space-x-3 text-emerald-400 text-xs font-bold bg-emerald-400/10 p-4 rounded-2xl border border-emerald-400/20">
                      <i class="fas fa-comment-dots text-lg"></i>
                      <span>Real-time communication via dashboard</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="px-8 py-6 border-t dark:border-gray-800 bg-gray-50/50 dark:bg-gray-900/50 flex justify-between items-center">
        <button id="prevBtn" onclick="prevStep()" class="hidden px-8 py-4 text-gray-500 dark:text-gray-400 font-black hover:text-gray-900 dark:hover:text-white transition-all flex items-center group">
          <i class="fas fa-chevron-left mr-3 group-hover:-translate-x-1 transition-transform"></i>
          Back
        </button>
        <button id="nextBtn" onclick="nextStep()" class="ml-auto px-10 py-5 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-2xl shadow-xl shadow-blue-500/30 transition-all hover:-translate-y-1 active:scale-95 flex items-center group">
          Next Step
          <i class="fas fa-chevron-right ml-3 group-hover:translate-x-1 transition-transform"></i>
        </button>
        <button id="submitOrderBtn" type="submit" form="orderForm" class="hidden ml-auto px-12 py-5 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-black rounded-2xl shadow-2xl shadow-blue-500/40 transition-all hover:-translate-y-1 active:scale-95 flex items-center group">
          <span class="btn-text">Place My Order</span>
          <i class="fas fa-paper-plane ml-3 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
        </button>
      </div>
    </div>
  </div>



  <script>
    let currentStep = 1;

    function goToStep(step) {
        if (step > currentStep) {
            if (!validateCurrentStep()) return;
        }
        
        // Update current step
        currentStep = step;

        // Hide all steps and show target step with animation
        document.querySelectorAll('.order-step').forEach(s => {
            s.classList.add('hidden');
            s.classList.remove('animate-in', 'fade-in', 'slide-in-from-bottom-4');
        });
        
        const targetStep = document.getElementById(`step-${step}`);
        targetStep.classList.remove('hidden');
        // Trigger re-animation
        void targetStep.offsetWidth;
        targetStep.classList.add('animate-in', 'fade-in', 'slide-in-from-bottom-4');
        
        // Update stepper UI
        const progressLine = document.getElementById('stepper-progress');
        const progressPercentage = ((step - 1) / 4) * 100;
        progressLine.style.width = `${progressPercentage}%`;

        document.querySelectorAll('.step-container').forEach(container => {
            const circle = container.querySelector('.step-circle');
            const label = container.querySelector('span');
            const stepNum = parseInt(circle.dataset.step);
            
            // Reset states
            circle.classList.remove('bg-blue-600', 'text-white', 'border-blue-600', 'bg-white', 'dark:bg-gray-900', 'text-blue-600', 'text-gray-400', 'border-gray-200', 'dark:border-gray-800', 'bg-emerald-500', 'border-emerald-500');
            label.classList.remove('text-blue-600', 'text-gray-400', 'text-emerald-500');

            if (stepNum === step) {
                // Active State
                circle.classList.add('bg-white', 'dark:bg-gray-900', 'text-blue-600', 'border-blue-600', 'shadow-md', 'scale-110');
                label.classList.add('text-blue-600');
                circle.innerHTML = stepNum;
            } else if (stepNum < step) {
                // Completed State
                circle.classList.add('bg-emerald-500', 'border-emerald-500', 'text-white');
                label.classList.add('text-emerald-500');
                circle.innerHTML = '<i class="fas fa-check text-xs"></i>';
            } else {
                // Pending State
                circle.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-400', 'border-gray-200', 'dark:border-gray-800');
                label.classList.add('text-gray-400');
                circle.innerHTML = stepNum;
            }
        });
        
        updateNavButtons();
        
        if (step === 5) {
            updateReviewStep();
        }
        
        // Scroll to top of modal content
        document.querySelector('.flex-1.overflow-y-auto').scrollTop = 0;
    }

    function nextStep() {
        if (validateCurrentStep()) {
            if (currentStep < 5) {
                goToStep(currentStep + 1);
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            goToStep(currentStep - 1);
        }
    }

    function updateNavButtons() {
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitOrderBtn');
        
        if (currentStep === 1) {
            prevBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        } else if (currentStep === 5) {
            prevBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
            submitBtn.classList.remove('hidden');
        } else {
            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            submitBtn.classList.add('hidden');
        }
    }

    function validateCurrentStep() {
        if (currentStep === 1) {
            const subject = getSelectedSubject();
            if (!subject) {
                showToast('Please select a subject or enter a custom one.', 'error');
                return false;
            }
        } else if (currentStep === 2) {
            const selectedType = document.querySelector('input[name="assignmentType"]:checked');
            if (!selectedType) {
                showToast('Please select an assignment type.', 'error');
                return false;
            }
            const isReadInstructions = document.getElementById('readInstructions').checked;
            if (selectedType.dataset.category !== 'technical' && !isReadInstructions) {
                const pages = parseInt(document.getElementById('pages').value);
                if (!pages || pages < 1) {
                    showToast('Please specify the number of pages or select "Read instructions".', 'error');
                    return false;
                }
            }
        } else if (currentStep === 3) {
            if (!document.getElementById('assignmentTitle').value.trim()) {
                showToast('Please enter an assignment title.', 'error');
                return false;
            }
            if (!document.getElementById('assignmentDescription').value.trim()) {
                showToast('Please provide detailed instructions.', 'error');
                return false;
            }
        } else if (currentStep === 4) {
            if (!document.getElementById('dueDateTime').value) {
                showToast('Please select a due date and time.', 'error');
                return false;
            }
            if (!validateDueDate()) return false;
            
            const isReadInstructions = document.getElementById('readInstructions').checked;
            if (isReadInstructions) {
                const budget = document.getElementById('proposedBudget').value;
                if (!budget || budget <= 0) {
                    showToast('Please enter your proposed budget.', 'error');
                    return false;
                }
            }
        }
        return true;
    }

    function togglePagesInput(checkbox) {
        const pagesInput = document.getElementById('pages');
        const plusBtn = pagesInput.nextElementSibling;
        const minusBtn = pagesInput.previousElementSibling;
        const budgetSection = document.getElementById('proposedBudgetSection');
        
        if (checkbox.checked) {
            pagesInput.disabled = true;
            pagesInput.classList.add('opacity-30');
            plusBtn.classList.add('opacity-30', 'pointer-events-none');
            minusBtn.classList.add('opacity-30', 'pointer-events-none');
            if (budgetSection) budgetSection.classList.remove('hidden');
        } else {
            pagesInput.disabled = false;
            pagesInput.classList.remove('opacity-30');
            plusBtn.classList.remove('opacity-30', 'pointer-events-none');
            minusBtn.classList.remove('opacity-30', 'pointer-events-none');
            if (budgetSection) budgetSection.classList.add('hidden');
        }
        updatePriceBreakdown();
    }

    function updateReviewStep() {
        const selectedType = document.querySelector('input[name="assignmentType"]:checked');
        const subject = getSelectedSubject();
        const isReadInstructions = document.getElementById('readInstructions').checked;
        const pages = document.getElementById('pages').value;
        const budget = document.getElementById('proposedBudget').value;
        
        document.getElementById('review-subject').textContent = subject;
        document.getElementById('review-type').textContent = selectedType ? selectedType.value.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : '-';
        document.getElementById('review-title').textContent = document.getElementById('assignmentTitle').value || 'Untitled Assignment';
        
        // Update Length display
        const lengthEl = document.getElementById('review-length');
        if (isReadInstructions) {
            lengthEl.textContent = 'Read Instructions';
        } else {
            lengthEl.textContent = `${pages} Page${pages > 1 ? 's' : ''}`;
        }

        // Update Price/Budget display logic
        const budgetLabel = document.getElementById('review-price-label');
        if (isReadInstructions) {
            budgetLabel.textContent = 'Proposed Budget';
            document.getElementById('review-proposed-budget').textContent = `$${parseFloat(budget || 0).toFixed(2)}`;
        } else {
            budgetLabel.textContent = 'Estimated Price';
            // Default to $10 per page if not checked instructions
            const estTotal = parseInt(pages) * 10;
            document.getElementById('review-proposed-budget').textContent = `$${estTotal.toFixed(2)}`;
        }

        const deadline = document.getElementById('dueDateTime').value;
        document.getElementById('review-deadline').textContent = deadline ? new Date(deadline).toLocaleString([], {
            weekday: 'short',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : '-';
        
        updatePriceBreakdown();
    }

    function updatePriceBreakdown() {
        const isReadInstructions = document.getElementById('readInstructions').checked;
        const budgetReviewEl = document.getElementById('review-proposed-budget');
        const discountRow = document.getElementById('couponDiscountRow');
        const discountEl = document.getElementById('review-coupon-discount');
        
        if (!budgetReviewEl) return;

        let baseTotal = 0;
        if (isReadInstructions) {
            baseTotal = parseFloat(document.getElementById('proposedBudget').value || 0);
        } else {
            const pages = document.getElementById('pages').value || 1;
            baseTotal = parseInt(pages) * 10;
        }

        budgetReviewEl.textContent = `$${baseTotal.toFixed(2)}`;

        // Handle Multiple Coupons
        if (appliedCoupons.length > 0 && discountRow && discountEl) {
            let totalDiscount = 0;
            appliedCoupons.forEach(coupon => {
                const discountType = coupon.discount_type || coupon.type;
                const discountValue = parseFloat(coupon.discount_value || coupon.value || 0);

                if (discountType === 'percentage') {
                    totalDiscount += baseTotal * (discountValue / 100);
                } else {
                    totalDiscount += discountValue;
                }
            });
            
            discountEl.textContent = `-$${(totalDiscount || 0).toFixed(2)}`;
            discountRow.classList.remove('hidden');
            
            const finalTotal = Math.max(0, baseTotal - (totalDiscount || 0));
            budgetReviewEl.textContent = `$${finalTotal.toFixed(2)}`;
        } else {
            if (discountRow) discountRow.classList.add('hidden');
        }
    }

    // Wrap the existing openOrderModal to reset steps
    const originalOpenOrderModal = window.openOrderModal;
    window.openOrderModal = function() {
        currentStep = 1;
        goToStep(1);
        
        // Reset states
        const readInstructions = document.getElementById('readInstructions');
        if (readInstructions) {
            readInstructions.checked = false;
            togglePagesInput(readInstructions);
        }
        document.getElementById('pages').value = 1;
        document.getElementById('proposedBudget').value = '';
        
        if (typeof originalOpenOrderModal === 'function') {
            originalOpenOrderModal();
        } else {
            document.getElementById('orderModal').classList.remove('hidden');
        }
    };



  </script>

  <script>
    // Section Navigation

function goBack() {
  history.back(); // Navigates to the previous page
}

function updateHeader(sectionName) {
  const mobile = document.getElementById("section-title-mobile");
  const large = document.getElementById("section-title-large");
  if(mobile) mobile.textContent = sectionName;
  if(large) large.textContent = sectionName;
}

// Example: Call this when switching sections
// updateHeader("Messages");

  </script>

<script>
// Check authentication on page load
window.addEventListener('DOMContentLoaded', function() {
    const userId = localStorage.getItem("userId");
    if (!userId || userId === 'undefined') {
        showMessage("Please log in to access the dashboard", "error");
        window.location.href = '../index.html?auth=login';
        return;
    }
    
    // Load user profile
    fetchProfile();
    
    // Load Customizations
    loadDashBg();
    loadDashFont();
    
    // Update header with user name
    const userName = localStorage.getItem("userName");
    if (userName) {
        updateHeader(`Welcome, ${userName}`);
    }
});

const studentId = localStorage.getItem("userId"); // Ensure user ID is stored
const API_BASE = "https://essayme2.onrender.com";

// Helper for authenticated fetches
async function fetchWithAuth(url, options = {}) {
    const email = localStorage.getItem('userEmail');
    const headers = {
        ...options.headers,
        'x-user-email': email
    };
    if (options.body && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
    }
    
    try {
        const response = await fetch(url, { ...options, headers });
        
        // Handle suspension or account deletion
        if (response.status === 401 || response.status === 403 || response.status === 404) {
            const data = await response.clone().json().catch(() => ({}));
            if (data.error && (data.error.includes('suspended') || data.error.includes('found'))) {
                localStorage.clear();
                window.location.href = '../index.html?error=' + encodeURIComponent(data.error);
                return new Promise(() => {}); // Stop further execution
            }
        }
        
        return response;
    } catch (error) {
        console.error('Fetch error:', error);
        throw error;
    }
}

function getImageUrl(path) {
    if (!path) return defaultAvatar;
    if (path.startsWith('http')) return path;
    if (path.startsWith('/uploads/')) return `${API_BASE}${path}`;
    if (path.startsWith('uploads/')) return `${API_BASE}/${path}`;
    return `${API_BASE}/uploads/${path}`;
}

function showConfirm(title, message, options = {}) {
    const { 
        confirmText = 'Confirm', 
        cancelText = 'Cancel', 
        type = 'warning',
        showInput = false,
        placeholder = '',
        inputValue = ''
    } = options;

    return new Promise((resolve) => {
        const modalId = 'confirm-modal-' + Date.now();
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in';
        
        const colors = {
            warning: 'text-yellow-500 bg-yellow-50',
            danger: 'text-red-500 bg-red-50',
            info: 'text-blue-500 bg-blue-50'
        };

        const icons = {
            warning: 'fa-exclamation-triangle',
            danger: 'fa-trash-alt',
            info: 'fa-info-circle'
        };

        const colorClass = colors[type] || colors.warning;
        const iconClass = icons[type] || icons.warning;

        modal.innerHTML = `
            <div class="glass-card bg-white/10 dark:bg-slate-900/40 backdrop-blur-xl border border-white/20 rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slide-up">
                <div class="p-8 text-center">
                    <div class="w-20 h-20 ${colorClass} rounded-2xl flex items-center justify-center mx-auto mb-6 transform rotate-12">
                        <i class="fas ${iconClass} text-3xl transform -rotate-12"></i>
                    </div>
                    <h3 class="text-2xl font-black text-gray-900 dark:text-white mb-3">${title}</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-8 leading-relaxed">${message}</p>
                    
                    ${showInput ? `
                        <div class="mb-8">
                            <input type="text" id="${modalId}-input" 
                                class="w-full px-6 py-4 rounded-2xl border border-white/20 bg-white/5 dark:bg-slate-800/20 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all placeholder-gray-400"
                                placeholder="${placeholder}" value="${inputValue}">
                        </div>
                    ` : ''}
                    
                    <div class="flex space-x-4">
                        <button id="${modalId}-cancel" class="flex-1 px-6 py-4 rounded-2xl bg-white/10 dark:bg-slate-800/30 text-gray-700 dark:text-gray-300 font-bold hover:bg-white/20 dark:hover:bg-slate-700/50 transition-all border border-white/10">
                            ${cancelText}
                        </button>
                        <button id="${modalId}-confirm" class="flex-1 px-6 py-4 rounded-2xl ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} text-white font-bold transition-all shadow-xl shadow-blue-500/20 hover:scale-[1.02] active:scale-[0.98]">
                            ${confirmText}
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        const input = modal.querySelector('input');
        if (input) {
            setTimeout(() => input.focus(), 100);
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') confirmBtn.click();
            });
        }

        const confirmBtn = document.getElementById(`${modalId}-confirm`);
        const cancelBtn = document.getElementById(`${modalId}-cancel`);

        confirmBtn.onclick = () => {
            const value = input ? input.value : true;
            modal.classList.add('animate-fade-out');
            setTimeout(() => {
                modal.remove();
                resolve(value);
            }, 300);
        };

        cancelBtn.onclick = () => {
            modal.classList.add('animate-fade-out');
            setTimeout(() => {
                modal.remove();
                resolve(null);
            }, 300);
        };

        modal.onclick = (e) => {
            if (e.target === modal) cancelBtn.click();
        };
    });
}

function showMessage(message, type = 'info') {
    // Remove existing toast
    const existingToast = document.querySelector('.toast');
    if (existingToast) {
        existingToast.classList.add('toast-exit');
        setTimeout(() => existingToast.remove(), 500);
    }
    
    // Create new toast
    const toast = document.createElement('div');
    const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        info: 'fa-info-circle',
        warning: 'fa-exclamation-triangle'
    };
    const colors = {
        success: 'bg-green-600/80 backdrop-blur-md border border-green-500/20',
        error: 'bg-red-600/80 backdrop-blur-md border border-red-500/20',
        info: 'bg-blue-600/80 backdrop-blur-md border border-blue-500/20',
        warning: 'bg-yellow-600/80 backdrop-blur-md border border-yellow-500/20'
    };

    toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-xl shadow-2xl z-[100] cool-toast flex items-center space-x-3 text-white font-medium ${colors[type] || colors.info} toast`;
    
    toast.innerHTML = `
        <i class="fas ${icons[type] || icons.info} text-xl"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    // Remove toast after 4 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 500);
        }
    }, 4000);
}

const defaultAvatar = "https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/User_icon_2.svg/960px-User_icon_2.svg.png"; // Default avatar

// ✅ Fetch and Display Profile Information
async function fetchProfile() {
    if (!studentId) {
        console.error("No studentId found in localStorage.");
        window.location.href = 'index.html';
        return;
    }

    try {
        const response = await fetchWithAuth(`${API_BASE}/user/${studentId}`);
        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.message || 'Failed to fetch profile');
        }

        const data = result.user;
        if (!data) {
            console.error("No profile data received.");
            return;
        }

        // ✅ Update Profile Details (supports view and inline-edit modes)
        const setTextOrValue = (el, text) => {
          if (!el) return;
          if ('value' in el) { el.value = text; } else { el.textContent = text; }
        };
        setTextOrValue(document.getElementById('user-name') || document.getElementById('inline-name'), data.name || 'Unknown');
        setTextOrValue(document.getElementById('user-email') || document.getElementById('inline-email'), data.email || 'No email provided');
        try { localStorage.setItem('userEmail', data.email || ''); } catch (e) {}
        const balance = Number(data.balance || 0);
        const walletEl = document.getElementById('wallet-balance');
        if (walletEl) walletEl.textContent = `$${balance.toFixed(2)}`;
        // Also update the payments section balance
        const userBalanceElement = document.getElementById('userBalance');
        if (userBalanceElement) {
            userBalanceElement.textContent = `$${balance.toFixed(2)}`;
        }
        
        // Update user name in payments section
        const userNameElement = document.getElementById('userName');
        if (userNameElement) {
            userNameElement.textContent = data.name || 'User';
        }
        // Bio
        setTextOrValue(document.getElementById('user-bio') || document.getElementById('inline-bio'), data.bio || 'Welcome to EssayMe! Complete your profile to get started.');
        
        // Phone
        const phoneTarget = document.getElementById('user-phone') || document.getElementById('inline-phone');
        if (phoneTarget) setTextOrValue(phoneTarget, data.phone || 'Not set');

        // Social links removed from UI; no update needed

        // ✅ Update Profile Image
        const profileImageUrl = getImageUrl(data.profileImage);
        
        document.getElementById("profile-picture").src = profileImageUrl;
        document.getElementById("profile-picture-lg").src = profileImageUrl;
        document.getElementById("edit-profile-picture").src = profileImageUrl;

        // Payments profile image
        const paymentsImg = document.getElementById('payments-profile-image');
        if (paymentsImg) paymentsImg.src = profileImageUrl;
        
        // Update header icon: show image if available; otherwise show initials
        const iconImg = document.getElementById("profile-icon-image");
        const initialsEl = document.getElementById("profile-initials");
        if (iconImg && initialsEl) {
          if (profileImageUrl && profileImageUrl !== defaultAvatar) {
            iconImg.src = profileImageUrl;
            iconImg.classList.remove('hidden');
            initialsEl.classList.add('hidden');
          } else {
            iconImg.classList.add('hidden');
            initialsEl.classList.remove('hidden');
          }
        }
        
        // Update profile initials (guard if header element not present)
        const initials = data.name ? data.name.split(' ').map(n => n[0]).join('').toUpperCase() : '??';
        const initialsNode = document.getElementById('profile-initials');
        if (initialsNode) initialsNode.textContent = initials;

        // Verify account is not suspended in background periodically
        if (!window._accountCheckInterval) {
          window._accountCheckInterval = setInterval(async () => {
            try {
              const res = await fetchWithAuth(`${API_BASE}/user/${studentId}`);
              if (!res.ok && (res.status === 401 || res.status === 403 || res.status === 404)) {
                // Suspended or deleted while logged in
                clearInterval(window._accountCheckInterval);
              }
            } catch (e) {}
          }, 30000); // Check every 30 seconds
        }
        
    } catch (error) {
        console.error("Profile Fetch Error:", error.message);
        showMessage("Failed to load profile. Please try logging in again.", "error");
    }
}

// ✅ Utility function: Fetch data from an API endpoint
async function fetchData(endpoint, method = "GET", body = null) {
    const headers = { "Content-Type": "application/json" };
    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);

    try {
        const response = await fetchWithAuth(`${API_BASE}/${endpoint}`, options);
        if (!response.ok) throw new Error(`Failed to fetch ${endpoint}: ${response.statusText}`);
        return await response.json();
    } catch (error) {
        console.error("API Fetch Error:", error.message);
    }
}

// ✅ Open/Edit Toggle: Edit Profile button becomes Save Profile on second click
function enableEditProfile() {
    const card = document.getElementById("profile-card");
    const actions = card && (card.nextElementSibling || document.querySelector('#profile .flex.flex-col.sm\\:flex-row'));
    const editBtn = actions && actions.querySelector('button[onclick="enableEditProfile()"]');
    if (!card || !actions || !editBtn) return;

    // If already in editing mode, clicking again saves
    if (editBtn.dataset.mode === 'saving') {
      saveInlineProfile();
      return;
    }

    // First click: switch to inline edit mode
    const nameEl = document.getElementById("user-name");
    const emailEl = document.getElementById("user-email");
    const bioEl = document.getElementById("user-bio");
    const phoneEl = document.getElementById("user-phone");
    if (!nameEl || !emailEl || !bioEl) return;

    if (!document.getElementById('inline-name')) {
      const current = nameEl.textContent.trim();
      nameEl.outerHTML = `<input id="inline-name" type="text" class="inline-edit-field text-3xl font-semibold text-gray-800 w-full border rounded-lg p-2" value="${current}" placeholder="Enter your full name">`;
    }
    if (!document.getElementById('inline-email')) {
      const current = (emailEl.textContent||'').trim();
      emailEl.outerHTML = `<input id="inline-email" type="email" class="inline-edit-field text-md text-blue-600 underline w-full border rounded-lg p-2 mt-1" value="${current}" placeholder="Enter your email address">`;
    }
    if (!document.getElementById('inline-phone')) {
      const phoneCurrent = (phoneEl && phoneEl.textContent && phoneEl.textContent !== 'Not set') ? phoneEl.textContent.trim() : '';
      const phoneBlock = document.createElement('div');
      phoneBlock.innerHTML = `<input id="inline-phone" type="text" class="inline-edit-field w-full border rounded-lg p-2 mt-2" placeholder="e.g. +1 555 123 4567" value="${phoneCurrent}">`;
      const userInfoContainer = card.querySelector('.flex-1.text-left.w-full');
      const bioBlock = userInfoContainer && userInfoContainer.querySelector('div.mt-4');
      (userInfoContainer && bioBlock) && userInfoContainer.insertBefore(phoneBlock, bioBlock);
    }
    if (!document.getElementById('inline-bio')) {
      const current = bioEl.textContent.trim();
      bioEl.outerHTML = `<textarea id="inline-bio" rows="3" class="inline-edit-field w-full border rounded-lg p-3 shadow-sm" placeholder="Tell us about yourself">${current}</textarea>`;
    }

    // Toggle button to Save mode
    editBtn.textContent = 'Save Profile';
    editBtn.dataset.mode = 'saving';
}

// ✅ Cancel Edit (Return to Profile Overview)
function cancelEdit() {
    // Legacy full-screen editor support (kept, but we use inline now)
    document.getElementById("edit-profile-form")?.classList.add("hidden");
    document.getElementById("profile-card")?.classList.remove("hidden");
}

// Inline: cancel and restore view state
function cancelInlineEdit() {
  // reload data to restore original DOM
  fetchProfile();
  const actions = document.querySelector('#profile .flex.flex-col.sm\\:flex-row') || document.getElementById('profile')?.querySelector('.flex.flex-col');
  const editBtn = actions && actions.querySelector('button[onclick="enableEditProfile()"]');
  if (editBtn) {
    editBtn.textContent = 'Edit Profile';
    editBtn.dataset.mode = '';
    editBtn.classList.remove('hidden');
  }
}

async function saveInlineProfile() {
  const studentId = localStorage.getItem("userId");
  if (!studentId || studentId === 'undefined') {
    showMessage('User not logged in!', "error");
    window.location.href = '../index.html?auth=login';
    return;
  }
  const name = document.getElementById('inline-name')?.value || '';
  const email = document.getElementById('inline-email')?.value || '';
  const bio = document.getElementById('inline-bio')?.value || '';
  const phone = document.getElementById('inline-phone')?.value || '';

  try {
    const res = await fetchWithAuth(`${API_BASE}/update-account`, {
      method: 'POST',
      body: (() => {
        const fd = new FormData();
        fd.append('userId', studentId);
        fd.append('name', name);
        fd.append('email', email);
        fd.append('bio', bio);
        fd.append('phone', phone);
        return fd;
      })()
    });
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to update profile');
    }
    await fetchProfile();
    cancelInlineEdit();
  } catch (e) {
    console.error('Profile Update Error:', e);
    showMessage('Failed to update profile', "error");
  }
}

// ✅ Preview Profile Picture When Selected
function updateProfilePicture(event) {
    const input = event?.target || document.getElementById('profile-upload');
    const file = input && input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const url = e.target.result;
        ['edit-profile-picture','profile-picture','profile-picture-lg'].forEach(id => {
            const img = document.getElementById(id);
            if (img) img.src = url;
        });
    };
    reader.readAsDataURL(file);
}

document.getElementById('profile-upload')?.addEventListener('change', async (e) => {
  const placeholder = document.getElementById('profile-upload-placeholder');
  if (placeholder) placeholder.textContent = 'Uploading...';
  updateProfilePicture(e);
  // Try uploading immediately to backend
  const file = e.target?.files?.[0];
  if (file && studentId) {
    try {
      const fd = new FormData();
      fd.append('userId', studentId);
      fd.append('profileImage', file);
      await fetchWithAuth(`${API_BASE}/update-account`, { method: 'POST', body: fd });
      if (placeholder) placeholder.textContent = 'Uploaded';
      setTimeout(() => { if (placeholder) placeholder.textContent = ''; }, 1500);
    } catch (_) {
      if (placeholder) placeholder.textContent = 'Upload failed';
      setTimeout(() => { if (placeholder) placeholder.textContent = ''; }, 2000);
    }
  }
});

// ✅ Save Updated Profile Information
async function saveProfile() {
    if (!studentId) return showMessage("User not logged in!", "error");

    const formData = new FormData();
    formData.append("userId", studentId);
    formData.append("name", document.getElementById("edit-username").value);
    formData.append("bio", document.getElementById("edit-bio").value);
    formData.append("phone", document.getElementById("edit-phone").value || '');

    const profileImage = document.getElementById("profile-upload").files[0];
    if (profileImage) {
        formData.append("profileImage", profileImage);
    }

    try {
        const response = await fetchWithAuth(`${API_BASE}/update-account`, { method: "POST", body: formData });
        if (!response.ok) throw new Error("Failed to update profile");

        showMessage("Profile updated successfully!", "success");
        fetchProfile(); // Refresh profile data
        cancelEdit(); // Return to profile overview
    } catch (error) {
        console.error("Profile Update Error:", error.message);
    }
}


  function downloadAllCompleted(assignmentId) {
    // For now, just open each file in a new tab; zipping can be added later server-side
    const assignment = (window._lastAssignments || []).find(a => String(a.id) === String(assignmentId));
    if (!assignment || !Array.isArray(assignment.completedFiles)) return;
    
    assignment.completedFiles.forEach((f, index) => {
      // Add a small delay between downloads to prevent browser blocking
      setTimeout(() => {
        const a = document.createElement('a');
        a.href = `${API_BASE}/file/${encodeURIComponent(f.filename)}`;
        a.download = f.originalName || f.filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }, index * 500);
    });
  }

  async function requestRefund(orderId, amount) {
    const confirmed = await showConfirm(
      'Request Refund',
      `Are you sure you want to request a refund of $${Number(amount).toFixed(2)} for this order?`,
      { confirmText: 'Request Refund', type: 'warning' }
    );
    if (!confirmed) return;
    try {
      const res = await fetchWithAuth(`${API_BASE}/payments/request-refund`, {
        method: 'POST',
        body: JSON.stringify({ userId: studentId, orderId, amount, reason: 'Student requested refund' })
      });
      const result = await res.json();
      if (result.success) {
        showMessage('Refund requested. We will notify you once processed.', 'success');
      } else {
        showMessage(result.message || 'Failed to request refund', 'error');
      }
    } catch (e) {
      console.error('Refund request error:', e);
      showMessage('Error requesting refund', 'error');
    }
  }

  // Fetch and Display Assignments
  async function fetchHomework() {
    try {
      const response = await fetchWithAuth(`${API_BASE}/orders/${studentId}`);
      const result = await response.json();
      
      if (!response.ok) {
        throw new Error(result.message || 'Failed to fetch orders');
      }
      
      const assignments = (Array.isArray(result.orders) ? result.orders : []).map(order => {
        // Map 'files' array (strings) to 'completedFiles' (objects) if it exists
        if (order.files && Array.isArray(order.files)) {
          order.completedFiles = order.files.map(filename => ({
            filename: filename,
            originalName: filename // We don't have original name for tutor uploads in DB currently
          }));
        }
        return order;
      });
      const assignmentsContainer = document.getElementById("assignments-container");
      studentBadgeData.assignments = assignments.map(a => String(a.id || a._id || '')).filter(Boolean);
      refreshStudentSectionBadges();
      
      if (assignments.length === 0) {
        assignmentsContainer.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="glass-card rounded-3xl p-12 max-w-lg mx-auto border border-white/20">
              <div class="w-20 h-20 bg-blue-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-book-open text-4xl text-blue-600"></i>
              </div>
              <h3 class="text-2xl font-black text-gray-800 dark:text-white mb-3">No Orders Yet</h3>
              <p class="text-gray-600 dark:text-gray-400 mb-8 leading-relaxed">Your orders will appear here once you place them. Start your academic journey today!</p>
              <button onclick="openOrderModal()" class="inline-flex items-center bg-blue-600 text-white px-8 py-4 rounded-2xl hover:bg-blue-700 transition-all font-bold shadow-xl shadow-blue-500/30 hover:scale-[1.02] active:scale-[0.98]">
                <i class="fas fa-plus mr-3"></i>Place Your First Order
              </button>
            </div>
          </div>
        `;
        return;
      }
  
      // keep a copy for helpers like downloadAllCompleted
      window._lastAssignments = assignments;

      assignmentsContainer.innerHTML = assignments
        .map(
          (assignment) => `
            <div class="glass-card p-6 rounded-3xl shadow-sm hover:shadow-xl transition-all duration-300 border border-white/20 group">
              <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-black text-gray-900 dark:text-white leading-tight group-hover:text-blue-600 transition-colors">${assignment.assignmentTitle || assignment.subject + ' - ' + assignment.orderType}</h2>
                <span class="${getStatusClass(assignment.status)} text-[10px] font-black uppercase tracking-widest px-3 py-1.5 rounded-xl border">${getStatusText(assignment.status)}</span>
              </div>
              
              <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="space-y-1">
                  <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Subject</p>
                  <p class="text-sm font-bold text-gray-700 dark:text-gray-200">${assignment.subject}</p>
                </div>
                <div class="space-y-1">
                  <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Order Type</p>
                  <p class="text-sm font-bold text-gray-700 dark:text-gray-200">${assignment.orderType}</p>
                </div>
                <div class="space-y-1">
                  <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Deadline</p>
                  <p class="text-sm font-bold text-gray-700 dark:text-gray-200">${new Date(assignment.deadline).toLocaleDateString()}</p>
                </div>
                <div class="space-y-1">
                  <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Cost</p>
                  <p class="text-sm font-black text-blue-600 dark:text-blue-400">$${parseFloat(assignment.totalCost || 0).toFixed(2)}</p>
                </div>
              </div>
              
              <div class="mb-6 p-4 rounded-2xl bg-white/5 dark:bg-slate-800/20 border border-white/10">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Description</p>
                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 leading-relaxed italic">"${(assignment.description || 'No description provided')}"</p>
              </div>
              
              <!-- Progress -->
              <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                   <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Progress</span>
                   <span class="text-[10px] font-black text-blue-600 dark:text-blue-400">${getProgressWidth(assignment.status).replace('w-[', '').replace('%]', '')}%</span>
                </div>
                <div class="bg-white/10 dark:bg-slate-800/40 rounded-full h-2 overflow-hidden">
                  <div class="${getProgressBarClass(assignment.status)} h-full rounded-full ${getProgressWidth(assignment.status)} transition-all duration-1000"></div> 
                </div>
              </div>
              
              ${getStatusActions(assignment)}
            </div>`
        )
        .join("");
    } catch (error) {
      console.error("Failed to fetch homework:", error.message);
      document.getElementById("assignments-container").innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="glass-card rounded-3xl p-12 max-w-lg mx-auto border border-red-500/20 bg-red-500/5">
            <div class="w-20 h-20 bg-red-500/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-exclamation-triangle text-4xl text-red-600"></i>
            </div>
            <h3 class="text-2xl font-black text-red-600 mb-3">Loading Failed</h3>
            <p class="text-red-500/80 mb-8 leading-relaxed">We couldn't retrieve your assignments. Please check your connection or try again.</p>
            <button onclick="fetchHomework()" class="inline-flex items-center bg-red-600 text-white px-8 py-4 rounded-2xl hover:bg-red-700 transition-all font-bold shadow-xl shadow-red-500/30">
              <i class="fas fa-sync-alt mr-3"></i>Retry Now
            </button>
          </div>
        </div>
      `;
    }
  }
  
  // Helper function to get status class
  function getStatusClass(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'bg-yellow-500/10 text-yellow-600 border-yellow-500/20';
      case 'under-review': return 'bg-purple-500/10 text-purple-600 border-purple-500/20';
      case 'checking-balance': return 'bg-orange-500/10 text-orange-600 border-orange-500/20';
      case 'assigned': return 'bg-blue-500/10 text-blue-600 border-blue-500/20';
      case 'in-progress': return 'bg-indigo-500/10 text-indigo-600 border-indigo-500/20';
      case 'completed': return 'bg-green-500/10 text-green-600 border-green-500/20';
      case 'cancelled': return 'bg-red-500/10 text-red-600 border-red-500/20';
      default: return 'bg-gray-500/10 text-gray-600 border-gray-500/20';
    }
  }
  
  // Helper function to get status text
  function getStatusText(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'Pending';
      case 'under-review': return 'Under Review';
      case 'checking-balance': return 'Needs Funds';
      case 'assigned': return 'Assigned';
      case 'in-progress': return 'Working';
      case 'completed': return 'Finished';
      case 'cancelled': return 'Cancelled';
      default: return status;
    }
  }
  
  // Helper function to get status actions
  function getStatusActions(assignment) {
    switch(assignment.status.toLowerCase()) {
      case 'under-review':
        return `<div class="p-4 rounded-2xl bg-purple-500/10 border border-purple-500/20">
          <p class="text-xs font-bold text-purple-700 dark:text-purple-300 flex items-center">
            <i class="fas fa-clock mr-2 animate-pulse"></i>
            Being reviewed. Quote expected within 1 hour.
          </p>
        </div>`;
      
      case 'checking-balance':
        return `<div class="p-4 rounded-2xl bg-orange-500/10 border border-orange-500/20">
          <p class="text-xs font-bold text-orange-700 dark:text-orange-300 mb-3 flex items-center">
            <i class="fas fa-wallet mr-2"></i>
            Balance must cover $${Number(assignment.totalCost).toFixed(2)}
          </p>
          <button onclick="showSection('payments')" class="w-full py-3 bg-orange-600 text-white rounded-xl text-sm font-bold hover:bg-orange-700 transition-all shadow-lg shadow-orange-500/20">
            <i class="fas fa-plus-circle mr-2"></i>Add Funds Now
          </button>
        </div>`;
      
      case 'completed':
        return `<div class="p-4 rounded-2xl bg-green-500/10 border border-green-500/20">
          <p class="text-xs font-bold text-green-700 dark:text-green-300 mb-4 flex items-center">
            <i class="fas fa-check-circle mr-2 text-lg"></i>
            Assignment successfully completed!
          </p>
          ${Array.isArray(assignment.completedFiles) && assignment.completedFiles.length > 0 ? `
            <div class="space-y-2 mb-4">
              ${assignment.completedFiles.map(f => `
                <div class="flex items-center justify-between bg-white/10 dark:bg-slate-800/40 p-3 rounded-xl border border-white/10">
                  <div class="flex items-center space-x-3 overflow-hidden">
                    <i class="fas fa-file-alt text-blue-500 text-lg"></i>
                    <span class="text-xs font-bold text-gray-700 dark:text-gray-200 truncate">${f.originalName || f.filename}</span>
                  </div>
                  <a href="${API_BASE}/file/${encodeURIComponent(f.filename)}" download class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">
                    <i class="fas fa-download text-xs"></i>
                  </a>
                </div>
              `).join('')}
            </div>
          ` : `<p class="text-[10px] italic text-green-600/70 mb-4">Ready for download shortly.</p>`}
          <div class="grid grid-cols-2 gap-3">
            <button class="py-3 bg-green-600 text-white rounded-xl text-xs font-black hover:bg-green-700 transition-all shadow-lg shadow-green-500/20 uppercase tracking-widest" onclick="downloadAllCompleted('${assignment.id}')">
              <i class="fas fa-cloud-download-alt mr-2"></i>Download All
            </button>
            <button class="py-3 bg-red-500/20 text-red-600 rounded-xl text-xs font-black hover:bg-red-500/30 transition-all border border-red-500/20 uppercase tracking-widest" onclick="requestRefund('${assignment.id}', ${Number(assignment.totalCost || 0)})">
              <i class="fas fa-flag mr-2"></i>Refund
            </button>
          </div>
        </div>`;
      
      default:
        return `<button onclick="showSection('messages')" class="w-full py-3 bg-blue-600/10 text-blue-600 border border-blue-600/20 rounded-xl text-sm font-black hover:bg-blue-600/20 transition-all uppercase tracking-widest">
            <i class="fas fa-comments mr-2"></i>Chat with Tutor
        </button>`;
    }
  }
  
  // Helper function to get progress bar class
  function getProgressBarClass(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'bg-yellow-500';
      case 'under-review': return 'bg-purple-500';
      case 'checking-balance': return 'bg-orange-500';
      case 'assigned': return 'bg-blue-500';
      case 'in-progress': return 'bg-indigo-500';
      case 'completed': return 'bg-green-500';
      case 'cancelled': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  }
  
  // Helper function to get progress width
  function getProgressWidth(status) {
    switch(status.toLowerCase()) {
      case 'pending': return 'w-[15%]';
      case 'under-review': return 'w-[25%]';
      case 'checking-balance': return 'w-[40%]';
      case 'assigned': return 'w-[60%]';
      case 'in-progress': return 'w-[80%]';
      case 'completed': return 'w-full';
      case 'cancelled': return 'w-[10%]';
      default: return 'w-[5%]';
    }
  }
  
  // Fetch and Display Chat Messages
// Removed old fetchMessages and openChat functions - using SSE-based messaging system
// Function to format message HTML
function createMessageHTML(message) {
  return `
    <div class="chat-message ${message.sender === "Student" ? "student" : "tutor"}">
      <div class="chat-bubble ${message.sender === "Student" ? "bg-blue-500 text-white" : "bg-gray-200 text-black"} p-3 rounded-lg shadow-md">
        <strong>${message.sender}</strong>: ${message.content}
        <br><small class="text-xs text-black-500">${message.timestamp}</small>
      </div>
    </div>`;
}

document.getElementById("send-message").addEventListener("click", sendMessage);
document.getElementById("chat-box").addEventListener("input", toggleSendButton);



// Removed duplicate sendMessage function that was causing triple message display

  
  // Section Navigation
  function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('main > section').forEach(section => section.classList.add('hidden'));
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) targetSection.classList.remove('hidden');

    // Update active state in sidebar
    document.querySelectorAll(".icon-sidebar a").forEach((link) => {
        link.classList.remove("active");
        if (link.getAttribute('onclick')?.includes(sectionId)) {
            link.classList.add('active');
        }
    });

    // Update section titles
    const sectionTitles = {
      'overview': 'Dashboard',
      'assignments': 'Assignments',
      'messages': 'Messages',
      'payments': 'Payments',
      'profile': 'Profile'
    };
    const title = sectionTitles[sectionId] || 'Dashboard';
    const titleMobile = document.getElementById('section-title-mobile');
    const titleLarge = document.getElementById('section-title-large');
    if(titleMobile) titleMobile.textContent = title;
    if(titleLarge) titleLarge.textContent = title;

    // Special handling for sections
    if (sectionId === 'messages') {
      switchToAssignmentView();
      if (typeof activeAssignment !== 'undefined' && activeAssignment && activeAssignment.id) {
        clearStudentUnread(activeAssignment.id);
      }
    } else if (sectionId === 'assignments') {
      if (typeof markStudentSectionSeen === 'function') markStudentSectionSeen('assignments');
      if (typeof fetchHomework === 'function') fetchHomework();
    } else if (sectionId === 'payments') {
      if (typeof markStudentSectionSeen === 'function') markStudentSectionSeen('payments');
      if (typeof loadUserPayments === 'function') loadUserPayments();
      if (typeof checkBalanceNotification === 'function') checkBalanceNotification();
    } else if (sectionId === 'overview' || sectionId === 'dashboard') {
      if (typeof updateDashboardOverview === 'function') updateDashboardOverview();
    }
  }
  
  // Initialize Dashboard
  let activeAssignment = null; // { id, title, assignedTutor }
  let loggedInStudentId = localStorage.getItem('userId') || '';

  // SSE realtime for student
  let studentEventSource = null;
  let studentSeenMessageIds = new Set();
  function updateStudentSidebarBadge(){
    const total = Array.from(window.studentUnread?.values()||[]).reduce((a,b)=>a+b,0);
    const chatBadge = document.getElementById('student-chat-badge');
    if(chatBadge) {
      if(total>0){ chatBadge.textContent = String(total); chatBadge.classList.remove('hidden'); }
      else { chatBadge.classList.add('hidden'); }
    }
    const chatBadgeMobile = document.getElementById('student-chat-badge-mobile');
    if(chatBadgeMobile) {
      if(total>0){ chatBadgeMobile.textContent = String(total); chatBadgeMobile.classList.remove('hidden'); }
      else { chatBadgeMobile.classList.add('hidden'); }
    }
  }
  function updateStudentAssignmentsBadge(count){
    const badge = document.getElementById('student-assignments-badge');
    const badgeMobile = document.getElementById('student-assignments-badge-mobile');
    const targetCount = count>99 ? '99+' : String(count);
    [badge, badgeMobile].forEach(el => {
      if(!el) return;
      if(count>0){ el.textContent = targetCount; el.classList.remove('hidden'); }
      else { el.classList.add('hidden'); }
    });
  }
  function updateStudentPaymentsBadge(count){
    const badge = document.getElementById('student-payments-badge');
    const badgeMobile = document.getElementById('student-payments-badge-mobile');
    const targetCount = count>99 ? '99+' : String(count);
    [badge, badgeMobile].forEach(el => {
      if(!el) return;
      if(count>0){ el.textContent = targetCount; el.classList.remove('hidden'); }
      else { el.classList.add('hidden'); }
    });
  }
  function updateStudentListBadge(assignmentId){
    const btn = document.querySelector(`#assignment-chat-list button[data-id="${CSS.escape(String(assignmentId))}"]`);
    if(!btn) return;
    const badge = btn.querySelector('.assignment-unread-badge');
    const count = window.studentUnread?.get(String(assignmentId))||0;
    if(count>0){ badge.textContent = String(count); badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }
  }

  // LocalStorage helpers for last-read timestamps per assignment
  function getStudentLastReadMap(){
    try{ return JSON.parse(localStorage.getItem('studentLastRead')||'{}')||{}; }catch(_){ return {}; }
  }
  function setStudentLastRead(assignmentId, ts){
    const map = getStudentLastReadMap();
    map[String(assignmentId)] = ts || Date.now();
    localStorage.setItem('studentLastRead', JSON.stringify(map));
  }
  function getStudentLastRead(assignmentId){
    const map = getStudentLastReadMap();
    const v = map[String(assignmentId)];
    return typeof v === 'number' ? v : 0;
  }

  function incrementStudentUnread(assignmentId){
    const id = String(assignmentId);
    // If messages section visible and this assignment is active, don't count
    const messagesVisible = !document.getElementById('messages').classList.contains('hidden');
    if(messagesVisible && activeAssignment && String(activeAssignment.id)===id) return;
    const current = window.studentUnread.get(id)||0;
    window.studentUnread.set(id, current+1);
    updateStudentListBadge(id);
    updateStudentSidebarBadge();
  }
  function clearStudentUnread(assignmentId){
    if(!assignmentId) return;
    const id = String(assignmentId);
    // Update client-side last read timestamp
    setStudentLastRead(id, Date.now());
    if(window.studentUnread.has(id)) window.studentUnread.set(id, 0);
    updateStudentListBadge(id);
    updateStudentSidebarBadge();
  }

  // Poll server to compute unread counts for all assignments using last-read timestamps
  async function refreshUnreadCounts(){
    try{
      const list = document.getElementById('assignment-chat-list');
      if(!list) return;
      const buttons = Array.from(list.querySelectorAll('button[data-id]'));
      if(buttons.length===0) return;
      // Fetch messages for each assignment and compute tutor messages after last-read
      await Promise.all(buttons.map(async (btn)=>{
        const id = String(btn.dataset.id);
        try{
          const res = await fetchWithAuth(`${API_BASE}/messages?assignmentId=${encodeURIComponent(id)}`);
          const data = await res.json();
          if(!data.success) return;
          const lastRead = getStudentLastRead(id);
          const count = (data.messages||[]).filter(m=> m.sender==='tutor' && new Date(m.createdAt).getTime() > lastRead).length;
          window.studentUnread.set(id, count);
          updateStudentListBadge(id);
        }catch(_){ /* ignore per-assignment failure */ }
      }));
      updateStudentSidebarBadge();
    }catch(_){ /* ignore */ }
  }

  function startStudentSSE(){
    if (studentEventSource) { try{ studentEventSource.close(); }catch(_){} studentEventSource = null; }
    if (!activeAssignment) return;
    // Don't reset studentSeenMessageIds here - it's reset when switching assignments and populated by loadMessages
    const url = `${API_BASE}/messages/stream?assignmentId=${encodeURIComponent(activeAssignment.id)}`;
    studentEventSource = new EventSource(url);
    studentEventSource.onmessage = (evt)=>{
      try {
        const data = JSON.parse(evt.data);
        if (data?.type === 'message' && data.message) {
          const m = data.message;
          if (String(m.assignmentId) !== String(activeAssignment.id)) return;
          if (m._id && studentSeenMessageIds.has(m._id)) return;
          if (m._id) studentSeenMessageIds.add(m._id);
          const sender = m.sender === 'student' ? 'Student' : 'Tutor';
          appendMessageToChat({ sender, content: m.content, timestamp: new Date(m.createdAt).toLocaleString() });
          if(sender === 'Tutor'){
            incrementStudentUnread(m.assignmentId);
            document.getElementById('student-new-message-audio')?.play().catch(()=>{});
          }
        }
      } catch(_){ }
    };
  }
  function restartStudentSSE(){ if(studentEventSource){ try{ studentEventSource.close(); }catch(_){} studentEventSource=null; } startStudentSSE(); }

  // View switching functions
  function switchToChatView() {
    const assignmentView = document.getElementById('assignment-selection-view');
    const chatView = document.getElementById('chat-view');
    
    // Add fade out animation to assignment view
    assignmentView.style.opacity = '0';
    assignmentView.style.transform = 'translateX(-20px)';
    
    setTimeout(() => {
      assignmentView.classList.add('hidden');
      chatView.classList.remove('hidden');
      
      // Add fade in animation to chat view
      chatView.style.opacity = '0';
      chatView.style.transform = 'translateX(20px)';
      
      setTimeout(() => {
        chatView.style.opacity = '1';
        chatView.style.transform = 'translateX(0)';
      }, 50);
    }, 250);
  }

  function switchToAssignmentView() {
    const assignmentView = document.getElementById('assignment-selection-view');
    const chatView = document.getElementById('chat-view');
    
    // Add fade out animation to chat view
    chatView.style.opacity = '0';
    chatView.style.transform = 'translateX(20px)';
    
    setTimeout(() => {
      chatView.classList.add('hidden');
      assignmentView.classList.remove('hidden');
      
      // Add fade in animation to assignment view
      assignmentView.style.opacity = '0';
      assignmentView.style.transform = 'translateX(-20px)';
      
      setTimeout(() => {
        assignmentView.style.opacity = '1';
        assignmentView.style.transform = 'translateX(0)';
      }, 50);
    }, 250);
    
    // Clear active assignment
    activeAssignment = null;
    document.getElementById('active-assignment-title').textContent = 'None';
    toggleSendButton();
    
    // Stop SSE connection
    if(studentEventSource){ 
      try{ studentEventSource.close(); }catch(_){} 
      studentEventSource=null; 
    }
  }

  const studentBadgeData = { assignments: [], payments: [] };
  const studentBadgeSeenKeys = { assignments: 'studentSeenAssignments', payments: 'studentSeenPayments' };
  const studentBadgePreviousCounts = { assignments: 0, payments: 0 };
  let studentBadgesInitialized = false;

  function getStudentSeenIds(section){
    const key = studentBadgeSeenKeys[section];
    if(!key) return new Set();
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return new Set();
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) return new Set(parsed.map(String));
    }catch(_){ }
    return new Set();
  }

  function setStudentSeenIds(section, ids){
    const key = studentBadgeSeenKeys[section];
    if(!key) return;
    try{
      const unique = Array.from(new Set((ids||[]).map(String)));
      localStorage.setItem(key, JSON.stringify(unique));
    }catch(_){ }
  }

  function refreshStudentSectionBadges(){
    const shouldSound = studentBadgesInitialized;
    const updateSections = [
      { section: 'assignments', ids: studentBadgeData.assignments, updateFn: updateStudentAssignmentsBadge },
      { section: 'payments', ids: studentBadgeData.payments, updateFn: updateStudentPaymentsBadge }
    ];
    updateSections.forEach(({ section, ids, updateFn }) => {
      const seen = getStudentSeenIds(section);
      const unseenIds = (ids||[]).filter(id => id && !seen.has(String(id)));
      updateFn(unseenIds.length);
      if (shouldSound && unseenIds.length > (studentBadgePreviousCounts[section] || 0) && unseenIds.length > 0) {
        document.getElementById('student-update-audio')?.play?.().catch(()=>{});
      }
      studentBadgePreviousCounts[section] = unseenIds.length;
    });
    studentBadgesInitialized = true;
  }

  function markStudentSectionSeen(section){
    setStudentSeenIds(section, studentBadgeData[section] || []);
    studentBadgePreviousCounts[section] = 0;
    refreshStudentSectionBadges();
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("send-message").addEventListener("click", sendMessage);
    document.getElementById("chat-box").addEventListener("input", toggleSendButton);
    toggleSendButton();
    document.getElementById("refresh-assignments")?.addEventListener("click", loadAssignmentList);
    document.getElementById("back-to-assignments")?.addEventListener("click", switchToAssignmentView);
    window.studentUnread = new Map();
    fetchProfile();
    loadAssignmentList();
  });

  async function loadAssignmentList(){
    const list = document.getElementById('assignment-chat-list');
    list.innerHTML = '<div class="text-gray-500 text-sm">Loading...</div>';
    try{
      const res = await fetchWithAuth(`${API_BASE}/student/assignments?userId=${encodeURIComponent(loggedInStudentId)}`);
      const data = await res.json();
      if(!data.success){ list.innerHTML = '<div class="text-red-600 text-sm">Failed to load assignments</div>'; return; }
      const items = (data.assignments||[]).map(a=>{
        const t = a.title || 'Untitled';
        const s = a.status || '';
        return `<button class="assignment-card text-left p-4 rounded-xl hover:bg-white/10 relative shadow-sm border border-white/20 transition-all duration-300" data-id="${a.id}" data-title="${t}" data-tutor="${a.assignedTutor||''}">
          <div class="font-semibold text-gray-800 dark:text-white">${t}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">${a.subject||''} • ${s}</div>
          <span class="assignment-unread-badge bg-red-600 text-white text-[10px] leading-none rounded-full px-1.5 py-0.5 hidden">0</span>
        </button>`;
      }).join('');
      list.innerHTML = items || '<div class="text-gray-500 text-sm">No assignments yet.</div>';
      // attach click handlers and apply unread counts
      list.querySelectorAll('button[data-id]')?.forEach(btn=>{
        const id = String(btn.dataset.id);
        const badge = btn.querySelector('.assignment-unread-badge');
        const count = window.studentUnread?.get(id)||0;
        if(count>0){ badge.textContent = String(count); badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
        btn.addEventListener('click', ()=>{
          activeAssignment = { id: btn.dataset.id, title: btn.dataset.title, assignedTutor: btn.dataset.tutor };
          studentSeenMessageIds = new Set(); // reset dedup cache when switching assignment
          document.getElementById('active-assignment-title').textContent = activeAssignment.title;
          // opening marks as read
          clearStudentUnread(activeAssignment.id);
          toggleSendButton();
          loadMessages();
          restartStudentSSE();
          // Switch to chat view with animation
          switchToChatView();
        });
      });
      // After rendering, refresh unread counts once to ensure badges appear
      refreshUnreadCounts();
      updateStudentSidebarBadge();
    }catch(e){ list.innerHTML = '<div class="text-red-600 text-sm">Network error</div>'; }
  }

  async function loadMessages(){
    const history = document.getElementById('chat-history');
    if(!activeAssignment){ history.innerHTML = '<div class="text-gray-500 text-sm">Select an assignment to start chatting.</div>'; return; }
    history.innerHTML = '<div class="text-gray-500 text-sm">Loading messages...</div>';
    try{
      const res = await fetchWithAuth(`${API_BASE}/messages?assignmentId=${encodeURIComponent(activeAssignment.id)}`);
      const data = await res.json();
      if(!data.success){ history.innerHTML = '<div class="text-red-600 text-sm">Failed to load messages</div>'; return; }
      history.innerHTML = '';
      (data.messages||[]).forEach(m=> {
        // Add message ID to seen set to prevent SSE duplicates
        if (m._id) studentSeenMessageIds.add(m._id);
        appendMessageToChat({ sender: m.sender === 'student' ? 'Student' : 'Tutor', content: m.content, timestamp: new Date(m.createdAt).toLocaleString() }, false);
      });
      history.scrollTop = history.scrollHeight;
      // opening chat means read
      clearStudentUnread(activeAssignment.id);
    }catch(e){ history.innerHTML = '<div class="text-red-600 text-sm">Network error</div>'; }
  }

  function appendMessageToChat(message, append=true){
    const chatHistory = document.getElementById("chat-history");
    if (!chatHistory) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = message.sender === 'Student' ? 'student-message' : 'tutor-message';
    
    const messageContent = `
      <div class="flex items-start space-x-2">
        <div class="flex-1">
          <div class="font-semibold text-xs mb-1 opacity-75">${message.sender}</div>
          <div>${message.content}</div>
          <div class="text-xs opacity-60 mt-1">${message.timestamp}</div>
        </div>
      </div>
    `;
    
    messageDiv.innerHTML = messageContent;
    chatHistory.appendChild(messageDiv);
    if(append!==false) chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  async function sendMessage(){
    const content = document.getElementById('chat-box').value.trim();
    if(!content || !activeAssignment){ return; }
    try{
      const tutorId = activeAssignment.assignedTutor || '';
      const res = await fetchWithAuth(`${API_BASE}/messages`, { method:'POST', body: JSON.stringify({ assignmentId: activeAssignment.id, studentId: loggedInStudentId, tutorId, sender: 'student', content }) });
      const data = await res.json();
      if(!data.success){ console.error('Failed to send'); }
      // play send sound on successful post
      document.getElementById('student-send-audio')?.play().catch(()=>{});
    }catch(e){ console.error('Network error'); }
    finally {
      document.getElementById('chat-box').value='';
      toggleSendButton();
    }
  }

  function toggleSendButton(){
    const chatBox = document.getElementById('chat-box');
    const sendButton = document.getElementById('send-message');
    const canSend = !!chatBox.value.trim() && !!activeAssignment; // allow sending even if tutor not yet assigned
    sendButton.disabled = !canSend;
    if(canSend){ sendButton.classList.remove("bg-gray-400","cursor-not-allowed"); sendButton.classList.add("bg-blue-500","hover:bg-blue-400"); }
    else { sendButton.classList.add("bg-gray-400","cursor-not-allowed"); sendButton.classList.remove("bg-blue-500","hover:bg-blue-400"); }
  }

// Open the phone number popup
function openPhonePopup() {
  document.getElementById("phone-popup").classList.remove("hidden");
}

// Close the phone number popup
function closePhonePopup() {
  document.getElementById("phone-popup").classList.add("hidden");
}

// Save the phone number and update the input field
function savePhoneNumber() {
  const countryCode = document.getElementById("country-code").value;
  const phoneNumber = document.getElementById("new-phone-number").value;
  const fullPhoneNumber = countryCode + " " + phoneNumber;

  // Update the phone number input field with the selected number
  document.getElementById("phone-number").value = fullPhoneNumber;

  // Close the popup
  closePhonePopup();
}


// Open Password Update Popup
function openPasswordPopup() {
  document.getElementById("password-popup").classList.remove("hidden");
}

// Close Password Popup
function closePasswordPopup() {
  document.getElementById("password-popup").classList.add("hidden");
}

// Open Profile Picture Popup
function openProfilePicturePopup() {
  document.getElementById("profile-picture-popup").classList.remove("hidden");
}

// Close Profile Picture Popup
function closeProfilePicturePopup() {
  document.getElementById("profile-picture-popup").classList.add("hidden");
}

// Simulated functions for photo selection
function takePhoto() {
  showMessage("Taking a new photo...", "info");
  closeProfilePicturePopup();
}

function selectPhoto() {
  // Deprecated; replaced by savePopupProfileImage via file picker
  document.getElementById('popup-profile-upload')?.click();
}


async function savePopupProfileImage() {
  const input = document.getElementById('popup-profile-upload');
  const file = input && input.files && input.files[0];
  if (!file) { closeProfilePicturePopup(); return; }
  const formData = new FormData();
  formData.append('userId', studentId);
  formData.append('profileImage', file);
  try {
    const res = await fetchWithAuth(`${API_BASE}/update-account`, {
        method: 'POST',
        headers: {
            'x-user-email': localStorage.getItem('userEmail')
        },
        body: formData 
    });
    if (!res.ok) throw new Error('Failed to upload profile image');
    await fetchProfile();
    closeProfilePicturePopup();
  } catch (e) {
    console.error('Profile image upload error:', e);
    showMessage('Failed to upload profile image', 'error');
  }
}

// Save New Password
function saveNewPassword() {
  const currentPassword = document.getElementById("current-password").value;
  const newPassword = document.getElementById("new-password").value;
  const confirmPassword = document.getElementById("confirm-password").value;

  if (!currentPassword || !newPassword || !confirmPassword) {
    showMessage("Please fill out all password fields.", "warning");
    return;
  }

  if (newPassword !== confirmPassword) {
    showMessage("New password and confirmation do not match.", "error");
    return;
  }

  showMessage("Password changed successfully!", "success");
  closePasswordPopup();
}

// Forgot Password Function
function forgotPassword() {
}

// Logout Functions
function confirmLogout() {
    logout();
}

function logout() {
    // Clear all user data from localStorage
    localStorage.removeItem('userId');
    localStorage.removeItem('userName');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userRole');
    
    // Show logout notification
    showNotification('Logging out... Redirecting to home page', 'success');
    
    // Redirect to home page after 1.5 seconds
    setTimeout(() => {
        window.location.href = '../index.html';
    }, 1500);
}

// Toggle dropdown menu
function toggleDropdown() {
    const dropdown = document.getElementById('dropdown-menu');
    dropdown.classList.toggle('hidden');
}

// Update dashboard overview with real data
async function updateDashboardOverview() {
    // Load additional content (news & tips)
    fetchDashboardContent();

    try {
        const response = await fetchWithAuth(`${API_BASE}/orders/${studentId}`);
        const result = await response.json();
        
        if (response.ok && result.orders) {
            const orders = result.orders;
            
            // Calculate comprehensive stats
            const activeOrders = orders.filter(order => ['assigned', 'in-progress'].includes(order.status)).length;
            const upcomingDeadlines = orders.filter(order => {
                const deadline = new Date(order.deadline);
                const now = new Date();
                const threeDaysFromNow = new Date(now.getTime() + (3 * 24 * 60 * 60 * 1000));
                return deadline <= threeDaysFromNow && deadline > now && !['completed', 'cancelled'].includes(order.status);
            }).length;
            
            const checkingBalanceOrders = orders.filter(order => order.status === 'checking-balance');
            const totalPendingPayments = checkingBalanceOrders.reduce((sum, order) => sum + (parseFloat(order.totalCost) || 0), 0);
            
            const completedOrders = orders.filter(order => order.status === 'completed');
            
            // Update dashboard cards
            const activeStat = document.getElementById('stat-active');
            if (activeStat) activeStat.textContent = `${activeOrders} in progress`;
            
            const deadlineStat = document.getElementById('stat-deadlines');
            if (deadlineStat) deadlineStat.textContent = `${upcomingDeadlines} approaching`;
            
            const paymentStat = document.getElementById('stat-payments');
            if (paymentStat) paymentStat.textContent = `$${Number(totalPendingPayments).toFixed(2)} due`;
            
            const completedStat = document.getElementById('stat-completed');
            if (completedStat) completedStat.textContent = `${completedOrders.length} completed`;

            // Messages and rewards (calculating rewards based on completed assignments)
            const messageStat = document.getElementById('stat-messages');
            if (messageStat) messageStat.textContent = `0 unread`;
            
            const rewardsStat = document.getElementById('stat-rewards');
            if (rewardsStat) {
                const points = completedOrders.length * 10; // Simple points system: 10 points per completed assignment
                rewardsStat.textContent = `${points} points`;
            }
        }
    } catch (error) {
        console.error('Error updating dashboard overview:', error);
    }
}

// Load user payments
async function loadUserPayments() {
    try {
        const response = await fetchWithAuth(`${API_BASE}/payments/${studentId}`);
        const result = await response.json();
        
        if (result.success) {
            const payments = Array.isArray(result.payments) ? result.payments : [];
            studentBadgeData.payments = payments.filter(p => p.status && p.status.toLowerCase() === 'pending').map(p => String(p.id || p._id || '')).filter(Boolean);
            refreshStudentSectionBadges();
            displayPaymentHistory(payments);
        }
    } catch (error) {
        console.error('Error loading payments:', error);
    }
}

// Fetch Additional Dashboard Content (News & Tips)
async function fetchDashboardContent() {
  try {
    // Fetch Announcements
    const annResponse = await fetch(`${API_BASE}/announcements`);
    const annData = await annResponse.json();
    if (annData.success && annData.announcements.length > 0) {
      const container = document.getElementById('academic-news-container');
      if (container) {
        container.innerHTML = annData.announcements.map(ann => `
          <div class="flex items-start space-x-4">
            <div class="w-10 h-10 bg-indigo-50 rounded-xl flex-shrink-0 flex items-center justify-center text-indigo-600">
              <i class="fas ${ann.icon || 'fa-graduation-cap'}"></i>
            </div>
            <div>
              <h4 class="font-bold text-gray-800">${ann.title}</h4>
              <p class="text-sm text-gray-500 mt-1">${ann.content}</p>
            </div>
          </div>
        `).join('');
      }
    }

    // Fetch Tips
    const tipsResponse = await fetch(`${API_BASE}/tips`);
    const tipsData = await tipsResponse.json();
    if (tipsData.success && tipsData.tips.length > 0) {
      const container = document.getElementById('writing-tips-container');
      if (container) {
        container.innerHTML = tipsData.tips.map(tip => `
          <div class="bg-white/10 backdrop-blur-md p-4 rounded-2xl border border-white/20">
            <p class="text-sm italic">"${tip.content}"</p>
          </div>
        `).join('');
      }
    }
  } catch (error) {
    console.error('Error fetching dashboard content:', error);
  }
}

// Display payment history
function displayPaymentHistory(payments) {
    const container = document.getElementById('paymentsList');
    if (!container) { console.log('Payment history:', payments); return; }
    container.innerHTML = '';
    payments.forEach(p => {
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center py-2 border-b border-gray-100';
        const amountText = (p.amount >= 0 ? `+$${p.amount.toFixed(2)}` : `-$${Math.abs(p.amount).toFixed(2)}`);
        el.innerHTML = `
          <div class="text-sm text-gray-700">${new Date(p.createdAt).toLocaleString()}</div>
          <div class="text-sm font-medium">${p.method}</div>
          <div class="text-sm ${p.amount>=0? 'text-green-600':'text-red-600'}">${amountText}</div>
          <div class="text-xs text-gray-500">${p.status}</div>
        `;
        container.appendChild(el);
    });
}

// Check if balance notification should be shown
async function checkBalanceNotification() {
    try {
        const response = await fetchWithAuth(`${API_BASE}/orders/${studentId}`);
        const result = await response.json();
        
        if (response.ok && result.orders) {
            const checkingBalanceOrders = result.orders.filter(order => order.status === 'checking-balance');
            const totalPendingCost = checkingBalanceOrders.reduce((sum, order) => sum + order.totalCost, 0);
            
            // Get current user balance
            const userResponse = await fetchWithAuth(`${API_BASE}/user/${studentId}`);
            const userResult = await userResponse.json();
            
            if (userResponse.ok && userResult.user) {
                const currentBalance = userResult.user.walletBalance || 0;
                
                if (totalPendingCost > currentBalance && totalPendingCost > 0) {
                    document.getElementById('balanceNotification').classList.remove('hidden');
                } else {
                    document.getElementById('balanceNotification').classList.add('hidden');
                }
            }
        }
    } catch (error) {
        console.error('Error checking balance notification:', error);
    }
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  const userId = localStorage.getItem("userId");
  if (!userId || userId === 'undefined') {
      showMessage("Please log in to access the dashboard", "error");
      window.location.href = '../index.html?auth=login';
      return;
  }
  
  fetchProfile(); // Load user profile
  fetchHomework(); // Load assignments
  updateDashboardOverview(); // Update dashboard cards
  // Messages are loaded via SSE when assignment is selected
  loadUserPayments(); // Load payment history
  checkBalanceNotification(); // Check if balance notification should be shown
  
  // Theme controls
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.classList.toggle('dark', savedTheme === 'dark');
  document.querySelectorAll('input[name="theme"]').forEach(r => {
    r.checked = (r.value === savedTheme);
    r.addEventListener('change', () => {
      const mode = r.value;
      localStorage.setItem('theme', mode);
      document.documentElement.classList.toggle('dark', mode === 'dark');
    });
  });
  
  // Set up periodic refresh for real-time updates
  setInterval(() => {
    fetchHomework(); // Refresh assignments
    updateDashboardOverview(); // Refresh dashboard
    checkBalanceNotification(); // Check balance status
  }, 30000); // Refresh every 30 seconds
});

// Also call fetchHomework when assignments section is shown


// Order Modal Functions
let isPlacingOrder = false;
let autoAppliedCoupon = null;

async function openOrderModal() {
    currentStep = 1;
    goToStep(1);
    document.getElementById('orderModal').classList.remove('hidden');
    
    // Set minimum date to current date + 2 hours
    const now = new Date();
    now.setHours(now.getHours() + 2);
    document.getElementById('dueDateTime').min = now.toISOString().slice(0, 16);

    // Fetch auto-applied coupon if not already applied
    if (!appliedCoupon) {
        try {
            const response = await fetchWithAuth(`${API_BASE}/api/coupons/auto`);
            const result = await response.json();
            if (result.success && result.coupon) {
                autoAppliedCoupon = result.coupon;
                appliedCoupon = result.coupon;
                document.getElementById('couponCode').value = result.coupon.code;
                showCouponMessage('Onsite Discount applied automatically!', 'success');
                updatePriceBreakdown();
            }
        } catch (error) {
            console.error('Error fetching auto coupon:', error);
        }
    }
}

function closeOrderModal() {
    document.getElementById('orderModal').classList.add('hidden');
    document.getElementById('orderForm').reset();
    resetOrderModal();
}

// Subject selection handler
function getSelectedSubject() {
    const subjects = [
        'liberalArtsSubject', 'businessSubject', 'scienceSubject', 
        'technicalSubject', 'customSubject'
    ];
    
    for (let subjectId of subjects) {
        const element = document.getElementById(subjectId);
        if (element && element.value) {
            return element.value;
        }
    }
    return '';
}

// Assignment type change handler
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners for assignment type selection
    const assignmentTypes = document.querySelectorAll('input[name="assignmentType"]');
    assignmentTypes.forEach(radio => {
        radio.addEventListener('change', function() {
            toggleSections();
            updatePriceBreakdown();
            
            // Slide to pages section if it's shown
            const pagesSection = document.getElementById('pagesSection');
            if (pagesSection && !pagesSection.classList.contains('hidden')) {
                setTimeout(() => {
                    pagesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        });
    });

    // Handle subject selection - clear others when one is selected
    const subjectSelects = ['liberalArtsSubject', 'businessSubject', 'scienceSubject', 'technicalSubject'];
    subjectSelects.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', function() {
                if (this.value) {
                    subjectSelects.forEach(otherId => {
                        if (otherId !== id) {
                            const otherEl = document.getElementById(otherId);
                            if (otherEl) otherEl.value = '';
                        }
                    });
                    const customEl = document.getElementById('customSubject');
                    if (customEl) customEl.value = '';
                    
                    // Auto-next to Step 2
                    setTimeout(() => nextStep(), 300);
                }
            });
        }
    });

    const customSubjectEl = document.getElementById('customSubject');
    if (customSubjectEl) {
        customSubjectEl.addEventListener('input', function() {
            if (this.value) {
                subjectSelects.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
            }
        });
        
        customSubjectEl.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (this.value.trim()) {
                    nextStep();
                }
            }
        });
    }
    
    // Add event listener for pages input
    const pagesInput = document.getElementById('pages');
    if (pagesInput) {
        pagesInput.addEventListener('input', updatePriceBreakdown);
    }
    
    // Add event listener for due date validation
    const dueDateTimeInput = document.getElementById('dueDateTime');
    if (dueDateTimeInput) {
        dueDateTimeInput.addEventListener('change', validateDueDate);
    }
    
    // Add event listener for file upload
    const fileUploadInput = document.getElementById('fileUpload');
    if (fileUploadInput) {
        fileUploadInput.addEventListener('change', handleFileUpload);
    }

    // Add event listener for proposed budget input
    const proposedBudgetInput = document.getElementById('proposedBudget');
    if (proposedBudgetInput) {
        proposedBudgetInput.addEventListener('input', updatePriceBreakdown);
    }
});

function toggleSections() {
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    const pagesSection = document.getElementById('pagesSection');
    const technicalNote = document.getElementById('technicalNote');
    
    if (selectedType) {
        const category = selectedType.dataset.category;
        
        if (category === 'technical') {
            pagesSection.classList.add('hidden');
            technicalNote.classList.remove('hidden');
        } else {
            pagesSection.classList.remove('hidden');
            technicalNote.classList.add('hidden');
        }
    }
}

let appliedCoupons = [];
autoAppliedCoupon = null;

function resetOrderModal() {
    appliedCoupons = [];
    renderAppliedCoupons();
    const pagesEl = document.getElementById('pages');
    if (pagesEl) {
        pagesEl.value = 1;
        pagesEl.disabled = false;
        pagesEl.classList.remove('opacity-30');
    }
    
    const readInstructions = document.getElementById('readInstructions');
    if (readInstructions) readInstructions.checked = false;
    
    const proposedBudget = document.getElementById('proposedBudget');
    if (proposedBudget) proposedBudget.value = '';

    const couponCode = document.getElementById('couponCode');
    if (couponCode) couponCode.value = '';

    const couponMessage = document.getElementById('couponMessage');
    if (couponMessage) {
        couponMessage.textContent = '';
        couponMessage.classList.add('hidden');
    }

    const couponDiscountRow = document.getElementById('couponDiscountRow');
    if (couponDiscountRow) couponDiscountRow.classList.add('hidden');

    const timeWarning = document.getElementById('timeWarning');
    if (timeWarning) timeWarning.classList.add('hidden');

    appliedCoupon = null;
    
    // Reset file list
    const fileList = document.getElementById('fileList');
    if (fileList) fileList.innerHTML = '';
}

async function applyCoupon() {
    const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
    
    if (!couponCode) {
        showCouponMessage('Please enter a coupon code', 'error');
        return;
    }

    if (appliedCoupons.some(c => c.code === couponCode)) {
        showCouponMessage('This coupon is already applied', 'error');
        return;
    }
    
    try {
        const response = await fetchWithAuth(`${API_BASE}/api/coupons/validate?code=${encodeURIComponent(couponCode)}&userId=${localStorage.getItem('userId')}`);
        const result = await response.json();
        
        if (result.success) {
            appliedCoupons.push(result.coupon);
            document.getElementById('couponCode').value = '';
            showCouponMessage(`Coupon ${couponCode} redeemed!`, 'success');
            renderAppliedCoupons();
            updatePriceBreakdown();
        } else {
            showCouponMessage(result.error || 'Invalid coupon code', 'error');
        }
    } catch (error) {
        console.error('Error applying coupon:', error);
        showCouponMessage('Failed to apply coupon', 'error');
    }
}

function removeCoupon(code) {
    appliedCoupons = appliedCoupons.filter(c => c.code !== code);
    renderAppliedCoupons();
    updatePriceBreakdown();
}

function renderAppliedCoupons() {
    const list = document.getElementById('appliedCouponsList');
    const row = document.getElementById('couponDiscountRow');
    if (!list || !row) return;

    if (appliedCoupons.length === 0) {
        row.classList.add('hidden');
        list.innerHTML = '';
        return;
    }

    row.classList.remove('hidden');
    list.innerHTML = appliedCoupons.map(coupon => `
        <div class="flex items-center bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30 text-[10px] font-bold">
            <i class="fas fa-ticket-alt mr-1.5"></i>
            ${coupon.code}
            <button type="button" onclick="removeCoupon('${coupon.code}')" class="ml-2 hover:text-white transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function showCouponMessage(message, type) {
    const messageElement = document.getElementById('couponMessage');
    if (!messageElement) return;
    
    messageElement.textContent = message;
    messageElement.className = `text-[11px] font-bold mt-2 ${type === 'success' ? 'text-green-400' : 'text-red-400'}`;
    messageElement.classList.remove('hidden');
    
    setTimeout(() => messageElement.classList.add('hidden'), 5000);
}


async function redeemCoupons(orderId, orderAmount) {
    for (const coupon of appliedCoupons) {
        try {
            const response = await fetchWithAuth(`${API_BASE}/api/coupons/redeem`, {
                method: 'POST',
                body: JSON.stringify({
                    couponCode: coupon.code,
                    userId: localStorage.getItem('userId'),
                    orderId: orderId,
                    orderAmount: orderAmount
                })
            });
            
            if (!response.ok) {
                console.error(`Failed to redeem coupon: ${coupon.code}`);
            }
        } catch (error) {
            console.error(`Error redeeming coupon ${coupon.code}:`, error);
        }
    }
}

function validateDueDate() {
    const dueDateTime = new Date(document.getElementById('dueDateTime').value);
    const now = new Date();
    const twoHoursFromNow = new Date(now.getTime() + (2 * 60 * 60 * 1000));
    const timeWarning = document.getElementById('timeWarning');
    
    if (dueDateTime <= twoHoursFromNow) {
        timeWarning.classList.remove('hidden');
        return false;
    } else {
        timeWarning.classList.add('hidden');
        return true;
    }
}

function handleFileUpload() {
    const fileInput = document.getElementById('fileUpload');
    const fileList = document.getElementById('fileList');
    const files = Array.from(fileInput.files);
    
    fileList.innerHTML = '';
    
    if (files.length === 0) return;
    
    files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-white dark:bg-gray-800 p-3 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm animate-in fade-in slide-in-from-bottom-2';
        fileItem.innerHTML = `
            <div class="flex items-center min-w-0">
                <div class="w-8 h-8 rounded-lg bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 text-xs"></i>
                </div>
                <div class="min-w-0">
                    <p class="text-xs font-bold text-gray-900 dark:text-white truncate">${file.name}</p>
                    <p class="text-[10px] text-gray-500 font-medium">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
            <button type="button" onclick="removeFile(${index})" class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition-colors">
                <i class="fas fa-times text-xs"></i>
            </button>
        `;
        fileList.appendChild(fileItem);
    });
}

function removeFile(index) {
    const fileInput = document.getElementById('fileUpload');
    const dt = new DataTransfer();
    const files = Array.from(fileInput.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    fileInput.files = dt.files;
    handleFileUpload();
}

// Order form submission
document.addEventListener('DOMContentLoaded', function() {
    let isPlacingOrder = false;
    const formEl = document.getElementById('orderForm');
    formEl.addEventListener('submit', async function(e) {
        e.preventDefault();
        if (isPlacingOrder) return;
        
        // Validate form
        if (!validateOrderForm()) {
            return;
        }
        
        isPlacingOrder = true;
        const btn = document.getElementById('submitOrderBtn');
        const btnText = btn?.querySelector('.btn-text');
        const originalHTML = btn?.innerHTML;
        if (btn) {
          btn.disabled = true;
          btn.classList.add('opacity-60','cursor-not-allowed');
          if (btnText) btnText.textContent = 'Submitting...';
        }
        
        // Get form data
        const formData = getOrderFormData();
        
        try {
            // Create FormData for file upload
            const submitData = new FormData();
            
            // Add all form fields
            Object.keys(formData).forEach(key => {
                submitData.append(key, formData[key]);
            });
            
            // Add files if any
            const fileInput = document.getElementById('fileUpload');
            if (fileInput && fileInput.files) {
                for (let i = 0; i < fileInput.files.length; i++) {
                    submitData.append('files', fileInput.files[i]);
                }
            }
            
            const response = await fetchWithAuth(`${API_BASE}/place-order`, {
                method: 'POST',
                body: submitData // Don't set Content-Type header for FormData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccessMessage(result.order);
                closeOrderModal();
                fetchHomework();
                updateDashboardOverview();
                
                // Redeem coupons if applied
                if (appliedCoupons.length > 0) {
                    redeemCoupons(result.order.id, formData.totalCost);
                }
            } else {
                showMessage(result.message || 'Failed to place order. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Order placement error:', error);
            showMessage('An error occurred. Please try again.', 'error');
        } finally {
            isPlacingOrder = false;
            if (btn) {
              btn.disabled = false;
              btn.classList.remove('opacity-60','cursor-not-allowed');
              if (btnText) btnText.textContent = 'Submit Order';
              else btn.innerHTML = originalHTML;
            }
        }
    }, { once: false });
});

function validateOrderForm() {
    // Check if subject is selected
    const subject = getSelectedSubject();
    if (!subject) {
        showMessage('Please select a subject.', 'warning');
        return false;
    }
    
    // Check if assignment type is selected
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    if (!selectedType) {
        showMessage('Please select an assignment type.', 'warning');
        return false;
    }
    
    // Check pages for non-technical assignments
    if (selectedType.dataset.category !== 'technical') {
        const pages = parseInt(document.getElementById('pages').value);
        if (!pages || pages < 1) {
            showMessage('Please enter the number of pages.', 'warning');
            return false;
        }
    }
    
    // Check assignment title
    if (!document.getElementById('assignmentTitle').value.trim()) {
        showMessage('Please enter an assignment title.', 'warning');
        return false;
    }
    
    // Check assignment description
    if (!document.getElementById('assignmentDescription').value.trim()) {
        showMessage('Please provide assignment instructions.', 'warning');
        return false;
    }
    
    // Check due date
    if (!document.getElementById('dueDateTime').value) {
        showMessage('Please select a due date and time.', 'warning');
        return false;
    }
    
    // Validate due date is not within 2 hours
    if (!validateDueDate()) {
        showMessage('Assignments due within 2 hours cannot be accepted. Please select a later due date.', 'warning');
        return false;
    }
    
    return true;
}

function getOrderFormData() {
    const selectedType = document.querySelector('input[name="assignmentType"]:checked');
    const subject = getSelectedSubject();
    const isReadInstructions = document.getElementById('readInstructions').checked;
    const pages = isReadInstructions ? 0 : (parseInt(document.getElementById('pages').value) || 0);
    
    let baseTotal = 0;
    if (isReadInstructions) {
        baseTotal = parseFloat(document.getElementById('proposedBudget').value || 0);
    } else {
        baseTotal = pages * 10;
    }

    let totalDiscount = 0;
    appliedCoupons.forEach(coupon => {
        const discountType = coupon.discount_type || coupon.type;
        const discountValue = parseFloat(coupon.discount_value || coupon.value || 0);

        if (discountType === 'percentage') {
            totalDiscount += baseTotal * (discountValue / 100);
        } else {
            totalDiscount += discountValue;
        }
    });

    const finalTotal = Math.max(0, baseTotal - totalDiscount);
    
    const orderData = {
        userId: studentId,
        subject: subject,
        orderType: selectedType ? selectedType.value : '',
        assignmentTitle: document.getElementById('assignmentTitle').value.trim(),
        description: document.getElementById('assignmentDescription').value.trim(),
        additionalRequirements: document.getElementById('additionalRequirements').value.trim(),
        pages: pages,
        readInstructions: isReadInstructions,
        proposedBudget: isReadInstructions ? baseTotal : 0,
        deadline: document.getElementById('dueDateTime').value,
        category: selectedType ? selectedType.dataset.category : '',
        totalCost: finalTotal,
        discountAmount: totalDiscount,
        couponCode: appliedCoupons.map(c => c.code).join(','),
        status: 'under-review', 
        hasFiles: document.getElementById('fileUpload').files.length > 0
    };
    
    return orderData;
}

// Show success message after order placement
function showSuccessMessage(order) {
    // Create success modal
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] p-4';
    successModal.innerHTML = `
        <div class="glass-card dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full text-center shadow-2xl transform transition-all animate-in zoom-in duration-300">
            <div class="w-24 h-24 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-4xl text-green-500"></i>
            </div>
            
            <h3 class="text-3xl font-black text-gray-900 dark:text-white mb-2">Order Confirmed! 🎉</h3>
            <p class="text-gray-500 dark:text-gray-400 mb-8">Your assignment is now being reviewed by our experts.</p>
            
            <div class="bg-gray-50 dark:bg-gray-900/50 rounded-2xl p-6 mb-8 text-left border dark:border-gray-700 space-y-3">
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Order ID</span>
                    <span class="text-sm font-mono font-bold text-gray-900 dark:text-white">#${order.id}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Assignment</span>
                    <span class="text-sm font-bold text-gray-900 dark:text-white truncate ml-4">${order.assignmentTitle}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Estimate</span>
                    <span class="text-sm font-bold text-blue-600 dark:text-blue-400">${parseFloat(order.totalCost) > 0 ? `$${parseFloat(order.totalCost).toFixed(2)}` : 'Custom Quote'}</span>
                </div>
                ${order.couponCode ? `
                <div class="flex flex-col pt-2 border-t dark:border-gray-700/50 space-y-1">
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-green-500 uppercase tracking-widest">Coupons Applied:</span>
                        <span class="text-sm font-bold text-green-500">-$${parseFloat(order.discountAmount || 0).toFixed(2)}</span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${order.couponCode.split(',').map(code => `<span class="bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 text-[8px] px-1.5 py-0.5 rounded-md font-bold border border-green-200/50">${code}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
            
            <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/50 rounded-2xl p-5 mb-8">
                <div class="flex items-center justify-center space-x-2 text-blue-800 dark:text-blue-300 mb-1">
                    <i class="fas fa-shield-alt"></i>
                    <span class="font-bold">Payment Protection Active</span>
                </div>
                <p class="text-[11px] text-blue-700 dark:text-blue-400">
                    Submit with confidence. You won't be charged until we confirm we can complete your assignment.
                </p>
            </div>
            
            <button onclick="closeSuccessMessage()" class="w-full py-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-black rounded-2xl hover:scale-[1.02] transition-transform">
                Got it, Thanks!
            </button>
            
            <p id="success-timer" class="text-[10px] text-gray-400 mt-4 uppercase tracking-widest font-bold">Auto-closing in 5s</p>
        </div>
    `;
    
    document.body.appendChild(successModal);
    
    // Auto-close after 5 seconds with countdown
    let remaining = 5;
    const label = successModal.querySelector('#success-timer');
    const interval = setInterval(() => {
        remaining -= 1;
        if (label) label.textContent = `Auto-closing in ${remaining}s`;
        if (remaining <= 0) {
            clearInterval(interval);
            closeSuccessMessage();
        }
    }, 1000);
}

function closeSuccessMessage() {
    const modals = document.querySelectorAll('.fixed.inset-0');
    modals.forEach(modal => {
        if (modal.innerHTML.includes('Order Confirmed')) {
            modal.remove();
        }
    });
    // Refresh data
    fetchHomework();
    updateDashboardOverview();
}

// Payment System Functions
let selectedPaymentAmount = 0;

// Set amount for payment
function setAmount(amount) {
    document.getElementById('depositAmount').value = amount;
    selectedPaymentAmount = amount;
}

// Select payment method
function selectPaymentMethod(method) {
    const amount = parseFloat(document.getElementById('depositAmount').value);
    
    if (!amount || amount < 10) {
        showMessage('Please enter an amount of at least $10', 'warning');
        return;
    }
    
    selectedPaymentAmount = amount;
    
    // Update amount displays in modals
    const updates = [
        'paystackAmount','paypalAmount','cashappAmount','cashappAmountText','bitcoinAmount','bitcoinAmountText'
    ];
    updates.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = `$${amount.toFixed(2)}`;
    });
    
    // Show appropriate modal
    switch(method) {
        case 'paystack':
            document.getElementById('paystackModal').classList.remove('hidden');
            break;
        case 'paypal':
            document.getElementById('paypalModal').classList.remove('hidden');
            break;
        case 'cashapp':
            document.getElementById('cashappModal').classList.remove('hidden');
            break;
        case 'bitcoin':
            document.getElementById('bitcoinModal').classList.remove('hidden');
            break;
    }
}

// Close payment modal
function closePaymentModal() {
    document.getElementById('paystackModal').classList.add('hidden');
    document.getElementById('paypalModal').classList.add('hidden');
    document.getElementById('cashappModal').classList.add('hidden');
    document.getElementById('bitcoinModal').classList.add('hidden');
}

// Process Paystack payment
function processPaystackPayment() {
    // Initialize Paystack payment
    const handler = PaystackPop.setup({
        key: 'pk_test_232531a5c927ef2cc67ed1b85af3f26e3b8ed2f2',
        email: (localStorage.getItem('userEmail') || document.getElementById('user-email')?.textContent?.trim() || ''),
        amount: selectedPaymentAmount * 100, // Amount in kobo
        currency: 'USD',
        callback: function(response) {
            // Payment successful
            updateUserBalance(selectedPaymentAmount, 'paystack', response.reference);
            closePaymentModal();
            showPaymentSuccess('Paystack', selectedPaymentAmount, response.reference);
        },
        onClose: function() {
            showMessage('Payment cancelled', 'info');
        }
    });
    handler.openIframe();
}

// Process PayPal payment
function processPaypalPayment() {
    // Simulate PayPal payment (in real implementation, use PayPal SDK)
    setTimeout(() => {
        const reference = 'PP' + Date.now();
        updateUserBalance(selectedPaymentAmount, 'paypal', reference);
        closePaymentModal();
        showPaymentSuccess('PayPal', selectedPaymentAmount, reference);
    }, 2000);
}

// Submit CashApp payment
function submitCashappPayment() {
    const proofFile = document.getElementById('cashappProof').files[0];
    
    if (!proofFile) {
        showMessage('Please upload payment proof', 'warning');
        return;
    }
    
    // Create FormData for file upload
    const formData = new FormData();
    formData.append('amount', selectedPaymentAmount);
    formData.append('method', 'cashapp');
    formData.append('proof', proofFile);
    formData.append('userId', studentId);
    
    // Submit to server for manual approval
    fetchWithAuth(`${API_BASE}/submit-payment-proof`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closePaymentModal();
            showPaymentPending('CashApp', selectedPaymentAmount);
        } else {
            showMessage('Failed to submit payment proof: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error submitting payment proof:', error);
        showMessage('Error submitting payment proof. Please try again.', 'error');
    });
}

// Submit Bitcoin payment
function submitBitcoinPayment() {
    const proofFile = document.getElementById('bitcoinProof').files[0];
    
    if (!proofFile) {
        showMessage('Please upload payment proof', 'warning');
        return;
    }
    
    // Create FormData for file upload
    const formData = new FormData();
    formData.append('amount', selectedPaymentAmount);
    formData.append('method', 'bitcoin');
    formData.append('proof', proofFile);
    formData.append('userId', studentId);
    
    // Submit to server for manual approval
    fetchWithAuth(`${API_BASE}/submit-payment-proof`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closePaymentModal();
            showPaymentPending('Bitcoin', selectedPaymentAmount);
        } else {
            showMessage('Failed to submit payment proof: ' + result.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error submitting payment proof:', error);
        showMessage('Error submitting payment proof. Please try again.', 'error');
    });
}

// Copy Bitcoin address
function copyBitcoinAddress() {
    const address = '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa';
    navigator.clipboard.writeText(address).then(() => {
        showMessage('Bitcoin address copied to clipboard!', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = address;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showMessage('Bitcoin address copied to clipboard!', 'success');
    });
}

async function openWithdrawPrompt() {
  const amtStr = await showConfirm(
    'Withdraw Funds',
    'Enter the amount you wish to withdraw:',
    { showInput: true, placeholder: 'Amount ($)', type: 'info', confirmText: 'Next' }
  );
  if (!amtStr) return;
  const amount = Number(amtStr);
  if (!amount || amount <= 0) return showMessage('Enter a valid amount', 'warning');

  const method = await showConfirm(
    'Withdrawal Method',
    'Enter your preferred withdrawal method (paypal, bitcoin, or cashapp):',
    { 
      showInput: true, 
      placeholder: 'Method (e.g. paypal)', 
      inputValue: 'paypal',
      type: 'info', 
      confirmText: 'Next' 
    }
  );
  if (!method) return;

  const destination = await showConfirm(
    'Withdrawal Destination',
    `Enter your ${method} details (email address or wallet address):`,
    { 
      showInput: true, 
      placeholder: 'Destination details...', 
      type: 'info', 
      confirmText: 'Request Withdrawal' 
    }
  );
  if (!destination) return;

  requestWithdraw(amount, method, destination);
}

async function requestWithdraw(amount, method, destination) {
  try {
    const res = await fetchWithAuth(`${API_BASE}/payments/request-withdraw`, {
      method: 'POST',
      body: JSON.stringify({ userId: studentId, amount, method, destination })
    });
    const result = await res.json();
    if (result.success) {
      showMessage('Withdraw requested. You will be notified after approval.', 'success');
    } else {
      showMessage(result.message || 'Failed to request withdraw', 'error');
    }
  } catch (e) {
    console.error('Withdraw request error:', e);
    showMessage('Error requesting withdraw', 'error');
  }
}

// Update user balance
async function updateUserBalance(amount, method = 'paystack', reference = '') {
    try {
        const response = await fetchWithAuth(`${API_BASE}/update-balance`, {
            method: 'POST',
            body: JSON.stringify({
                userId: studentId,
                amount: amount,
                method: method,
                reference: reference
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update balance display
            document.getElementById('userBalance').textContent = `$${result.newBalance.toFixed(2)}`;
            // Hide balance notification if it was showing
            document.getElementById('balanceNotification').classList.add('hidden');
            // Refresh assignments to update status
            fetchHomework();
            updateDashboardOverview();
        }
    } catch (error) {
        console.error('Error updating balance:', error);
    }
}


// Show payment success message
function showPaymentSuccess(method, amount, reference) {
    const successModal = document.createElement('div');
    successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    successModal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-check-circle text-green-500 text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Successful! 🎉</h3>
            <p class="text-gray-600 mb-4">Your account has been credited.</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
                <h4 class="font-semibold text-gray-800 mb-2">Payment Details:</h4>
                <p class="text-sm text-gray-600"><strong>Method:</strong> ${method}</p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> $${amount.toFixed(2)}</p>
                <p class="text-sm text-gray-600"><strong>Reference:</strong> ${reference}</p>
            </div>
            
            <button onclick="closePaymentSuccess()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700">
                <i class="fas fa-thumbs-up mr-2"></i>Great!
            </button>
        </div>
    `;
    
    document.body.appendChild(successModal);
    
    // Auto-close after 5 seconds
    setTimeout(() => {
        if (document.body.contains(successModal)) {
            closePaymentSuccess();
        }
    }, 5000);
}

// Show payment pending message
function showPaymentPending(method, amount) {
    const pendingModal = document.createElement('div');
    pendingModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    pendingModal.innerHTML = `
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 text-center">
            <div class="mb-4">
                <i class="fas fa-clock text-yellow-500 text-6xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Payment Submitted! ⏳</h3>
            <p class="text-gray-600 mb-4">Your payment proof has been submitted for review.</p>
            
            <div class="bg-yellow-50 rounded-lg p-4 mb-4 text-left">
                <h4 class="font-semibold text-gray-800 mb-2">Submission Details:</h4>
                <p class="text-sm text-gray-600"><strong>Method:</strong> ${method}</p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> $${amount.toFixed(2)}</p>
                <p class="text-sm text-gray-600"><strong>Status:</strong> Pending Approval</p>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                <p class="text-blue-800 text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    Your account will be credited once the payment is approved by our team.
                </p>
            </div>
            
            <button onclick="closePaymentSuccess()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                <i class="fas fa-check mr-2"></i>Got It!
            </button>
        </div>
    `;
    
    document.body.appendChild(pendingModal);
}

// Close payment success/pending modal
function closePaymentSuccess() {
    const modals = document.querySelectorAll('.fixed.inset-0.bg-black.bg-opacity-50');
    modals.forEach(m => m.remove());
}

// Check if user needs to top up balance (server-driven)
async function checkBalanceNotification() {
    try {
        const response = await fetchWithAuth(`${API_BASE}/check-balance/${studentId}`);
        const result = await response.json();
        if (response.ok && result.success) {
            const notif = document.getElementById('balanceNotification');
            if (result.needsTopUp && result.checkingBalanceOrders > 0) {
                notif.classList.remove('hidden');
            } else {
                notif.classList.add('hidden');
            }
            // Keep top-of-section balance in sync too
            const userBalanceElement = document.getElementById('userBalance');
            if (userBalanceElement && typeof result.balance === 'number') {
                userBalanceElement.textContent = `$${Number(result.balance).toFixed(2)}`;
            }
        }
    } catch (e) {
        console.error('Error checking balance:', e);
    }
}

// Load Paystack script
function loadPaystackScript() {
    if (!document.getElementById('paystack-script')) {
        const script = document.createElement('script');
        script.id = 'paystack-script';
        script.src = 'https://js.paystack.co/v1/inline.js';
        document.head.appendChild(script);
    }
}

// Initialize payment system
document.addEventListener('DOMContentLoaded', function() {
    loadPaystackScript();
    // Load PayPal SDK
    if (!document.getElementById('paypal-sdk')) {
      const s = document.createElement('script');
      s.id = 'paypal-sdk';
      s.src = 'https://www.paypal.com/sdk/js?client-id=sb&currency=USD'; // sb = sandbox client id
      s.onload = () => {
        if (window.paypal) {
          try {
            paypal.Buttons({
              createOrder: function(data, actions) {
                return actions.order.create({
                  purchase_units: [{ amount: { value: (selectedPaymentAmount || 0).toFixed(2) } }]
                });
              },
              onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                  const reference = details.id;
                  updateUserBalance(selectedPaymentAmount, 'paypal', reference);
                  closePaymentModal();
                  showPaymentSuccess('PayPal', selectedPaymentAmount, reference);
                });
              }
            }).render('#paypal-buttons');
          } catch(e) { console.error('PayPal init error:', e); }
        }
      };
      document.head.appendChild(s);
    }
    checkBalanceNotification();
});

    </script>

<!-- Payment Modals -->

<!-- Paystack Modal -->
<div id="paystackModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
  <div class="bg-white rounded-2xl max-w-md w-full mx-4 shadow-2xl modal-content">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Pay with Paystack</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-credit-card text-2xl text-blue-600"></i>
        </div>
        <p class="text-gray-600">Amount: <span class="font-semibold text-xl" id="paystackAmount">$0.00</span></p>
      </div>
      
      <button onclick="processPaystackPayment()" 
              class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700">
        <i class="fas fa-credit-card mr-2"></i>Pay Now
      </button>
    </div>
  </div>
</div>

<!-- PayPal Modal -->
<div id="paypalModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
  <div class="bg-white rounded-2xl max-w-md w-full mx-4 shadow-2xl modal-content">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Pay with PayPal</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fab fa-paypal text-2xl text-blue-600"></i>
        </div>
        <p class="text-gray-600">Amount: <span class="font-semibold text-xl" id="paypalAmount">$0.00</span></p>
      </div>
      
      <div id="paypal-buttons"></div>
    </div>
  </div>
</div>

<!-- CashApp Bitcoin Modal -->
<div id="cashappModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
  <div class="bg-white rounded-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl modal-content">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">CashApp Bitcoin Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-2 text-green-800 mb-2">
          <i class="fas fa-info-circle"></i>
          <span class="font-semibold">CashApp Bitcoin Payment Instructions</span>
        </div>
        <div class="text-green-700 text-sm space-y-2">
          <p><strong>Amount to Pay:</strong> <span id="cashappAmount" class="font-semibold">$0.00</span></p>
          <p><strong>Payment Method:</strong> Bitcoin only via CashApp</p>
        </div>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-3">How to Pay with CashApp Bitcoin:</h4>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
            <li>Open your CashApp mobile application</li>
            <li>Tap on the "Bitcoin" tab at the bottom</li>
            <li>Select "Send Bitcoin" or "Withdraw Bitcoin"</li>
            <li>Enter the Bitcoin address below</li>
            <li>Enter the equivalent Bitcoin amount for <span id="cashappAmountText">$0.00</span></li>
            <li>Complete the transaction</li>
            <li>Take a screenshot of the transaction confirmation</li>
            <li>Upload the screenshot below as proof of payment</li>
          </ol>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Bitcoin Address:</h4>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-2 rounded text-sm flex-1 break-all">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa</code>
            <button onclick="copyBitcoinAddress()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Proof *</label>
          <input type="file" id="cashappProof" accept="image/*" 
                 class="w-full border border-gray-300 rounded-md p-2">
          <p class="text-xs text-gray-500 mt-1">Upload screenshot of your CashApp Bitcoin transaction</p>
        </div>

        <div class="flex space-x-3">
          <button onclick="closePaymentModal()" 
                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
            Cancel
          </button>
          <button onclick="submitCashappPayment()" 
                  class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
            <i class="fas fa-upload mr-2"></i>Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bitcoin Modal -->
<div id="bitcoinModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
  <div class="bg-white rounded-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto shadow-2xl modal-content">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Bitcoin Payment</h3>
        <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
        <div class="flex items-center space-x-2 text-yellow-800 mb-2">
          <i class="fab fa-bitcoin"></i>
          <span class="font-semibold">Bitcoin Direct Payment</span>
        </div>
        <div class="text-yellow-700 text-sm space-y-2">
          <p><strong>Amount to Pay:</strong> <span id="bitcoinAmount" class="font-semibold">$0.00</span></p>
          <p><strong>Payment Method:</strong> Direct Bitcoin transfer</p>
        </div>
      </div>

      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-3">Bitcoin Payment Instructions:</h4>
          <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
            <li>Copy the Bitcoin address below</li>
            <li>Open your Bitcoin wallet application</li>
            <li>Send the equivalent Bitcoin amount for <span id="bitcoinAmountText">$0.00</span></li>
            <li>Use the Bitcoin address provided</li>
            <li>Complete the transaction</li>
            <li>Take a screenshot of the transaction confirmation</li>
            <li>Upload the screenshot below as proof of payment</li>
          </ol>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Bitcoin Address:</h4>
          <div class="flex items-center space-x-2">
            <code class="bg-gray-100 px-3 py-2 rounded text-sm flex-1 break-all">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa</code>
            <button onclick="copyBitcoinAddress()" class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700">
              <i class="fas fa-copy"></i>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload Payment Proof *</label>
          <input type="file" id="bitcoinProof" accept="image/*" 
                 class="w-full border border-gray-300 rounded-md p-2">
          <p class="text-xs text-gray-500 mt-1">Upload screenshot of your Bitcoin transaction</p>
        </div>

        <div class="flex space-x-3">
          <button onclick="closePaymentModal()" 
                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
            Cancel
          </button>
          <button onclick="submitBitcoinPayment()" 
                  class="flex-1 bg-yellow-600 text-white py-2 px-4 rounded-md hover:bg-yellow-700">
            <i class="fas fa-upload mr-2"></i>Submit Payment
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Settings Modal -->
<div id="chatSettingsModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
  <div class="bg-white dark:bg-slate-900 rounded-2xl max-w-4xl w-full mx-4 settings-content shadow-2xl modal-content">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
            <i class="fas fa-palette text-white"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">Chat Themes</h2>
            <p class="text-gray-600">Customize your chat experience</p>
          </div>
        </div>
        <button onclick="closeChatSettings()" class="text-gray-500 hover:text-gray-700 text-2xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Theme Selection -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose Your Theme</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          
          <!-- Default Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="default" onclick="showThemePreview('default')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Classic Blue</h4>
              <p class="text-sm text-gray-600">Clean and professional</p>
            </div>
            <div class="space-y-2">
              <div class="bg-blue-500 text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-100 text-gray-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Ocean Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="ocean" onclick="showThemePreview('ocean')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Ocean Waves</h4>
              <p class="text-sm text-gray-600">Deep blue gradients</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-blue-50 text-blue-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Sunset Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="sunset" onclick="showThemePreview('sunset')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Sunset Glow</h4>
              <p class="text-sm text-gray-600">Warm pink tones</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);" class="text-gray-700 p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-orange-50 text-orange-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Forest Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="forest" onclick="showThemePreview('forest')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Forest Green</h4>
              <p class="text-sm text-gray-600">Natural and fresh</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-green-50 text-green-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Midnight Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="midnight" onclick="showThemePreview('midnight')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Midnight Dark</h4>
              <p class="text-sm text-gray-600">Sleek and modern</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #2c3e50 0%, #4a6741 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-700 text-gray-100 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Candy Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="candy" onclick="showThemePreview('candy')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Sweet Candy</h4>
              <p class="text-sm text-gray-600">Playful and bright</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);" class="text-white p-2 rounded-lg text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-pink-50 text-pink-800 p-2 rounded-lg text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

          <!-- Cyber Theme -->
          <div class="theme-preview bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-400 transition-all" data-theme="cyber" onclick="showThemePreview('cyber')">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-800">Cyber Neon</h4>
              <p class="text-sm text-gray-600">Futuristic vibes</p>
            </div>
            <div class="space-y-2">
              <div style="background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);" class="text-white p-2 rounded text-sm ml-auto max-w-[80%]">
                Your message
              </div>
              <div class="bg-gray-900 text-cyan-400 p-2 rounded text-sm mr-auto max-w-[80%]">
                Tutor response
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Custom Color Section -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Custom Colors</h3>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Your Message Color</label>
              <input type="color" id="studentColorPicker" value="#3b82f6" 
                     class="w-full h-10 rounded border border-gray-300 cursor-pointer">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Tutor Message Color</label>
              <input type="color" id="tutorColorPicker" value="#f3f4f6" 
                     class="w-full h-10 rounded border border-gray-300 cursor-pointer">
            </div>
          </div>
          <button onclick="showThemePreview('custom')" 
                  class="mt-4 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
            <i class="fas fa-paint-brush mr-2"></i>Preview Custom Colors
          </button>
        </div>
      </div>

<!-- Theme Preview Popup -->
<div id="themePreviewPopup" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden flex items-center justify-center z-[60] transition-all duration-300">
  <div class="bg-white rounded-2xl max-w-md w-full mx-4 shadow-2xl modal-content">
    <div class="p-6">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4">
        <div>
          <h3 class="text-lg font-bold text-gray-800" id="previewThemeName">Theme Preview</h3>
          <p class="text-sm text-gray-600">See how your messages will look</p>
        </div>
        <button onclick="closeThemePreview()" class="text-gray-500 hover:text-gray-700 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Live Preview -->
      <div class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto mb-4" id="liveThemePreview">
        <div class="space-y-3">
          <div class="preview-student-message">
            Hey! I need help with this assignment 📚
          </div>
          <div class="preview-tutor-message">
            Of course! I'd be happy to help you. What specific part are you struggling with?
          </div>
          <div class="preview-student-message">
            I'm having trouble understanding the concept
          </div>
          <div class="preview-tutor-message">
            Let me break it down for you step by step. First, let's start with the basics...
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex space-x-3">
        <button onclick="closeThemePreview()" 
                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
          Cancel
        </button>
        <button onclick="applyPreviewedTheme()" 
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
          <i class="fas fa-check mr-2"></i>Apply Theme
        </button>
      </div>
    </div>
  </div>
</div>

      <!-- Action Buttons -->
      <div class="flex justify-between">
        <button onclick="resetToDefault()" 
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
          <i class="fas fa-undo mr-2"></i>Reset to Default
        </button>
        <div class="space-x-3">
          <button onclick="closeChatSettings()" 
                  class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Chat Theme Management
let currentChatTheme = 'default';
let previewedTheme = null;

// Load saved theme on page load
document.addEventListener('DOMContentLoaded', function() {
  loadSavedChatTheme();
});

// Open chat settings modal
function openChatSettings() {
  document.getElementById('chatSettingsModal').classList.remove('hidden');
  document.getElementById('dropdown-menu').classList.add('hidden');
  updateThemeSelection();
}

// Close chat settings modal
function closeChatSettings() {
  document.getElementById('chatSettingsModal').classList.add('hidden');
}

// Show theme preview popup
function showThemePreview(themeName) {
  previewedTheme = themeName;
  const popup = document.getElementById('themePreviewPopup');
  const previewArea = document.getElementById('liveThemePreview');
  const themeTitleElement = document.getElementById('previewThemeName');
  
  // Set theme name
  const themeNames = {
    'default': 'Classic Blue',
    'ocean': 'Ocean Waves',
    'sunset': 'Sunset Glow',
    'forest': 'Forest Green',
    'midnight': 'Midnight Dark',
    'candy': 'Sweet Candy',
    'cyber': 'Cyber Neon',
    'custom': 'Custom Colors'
  };
  
  themeTitleElement.textContent = themeNames[themeName] || 'Theme Preview';
  
  // Apply preview theme to popup messages
  applyPreviewTheme(themeName);
  
  // Show popup
  popup.classList.remove('hidden');
}

// Close theme preview popup
function closeThemePreview() {
  document.getElementById('themePreviewPopup').classList.add('hidden');
  previewedTheme = null;
}

// Apply previewed theme
function applyPreviewedTheme() {
  if (previewedTheme) {
    applyTheme(previewedTheme);
    saveChatTheme();
    closeThemePreview();
    closeChatSettings();
  }
}

// Apply preview theme to popup
function applyPreviewTheme(themeName) {
  const previewArea = document.getElementById('liveThemePreview');
  
  // Remove all theme classes
  previewArea.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-midnight', 'theme-candy', 'theme-cyber');
  
  if (themeName === 'custom') {
    const studentColor = document.getElementById('studentColorPicker').value;
    const tutorColor = document.getElementById('tutorColorPicker').value;
    
    // Apply custom colors to preview
    const studentMessages = previewArea.querySelectorAll('.preview-student-message');
    const tutorMessages = previewArea.querySelectorAll('.preview-tutor-message');
    
    studentMessages.forEach(msg => {
      msg.style.background = studentColor;
      msg.style.color = getContrastColor(studentColor);
    });
    
    tutorMessages.forEach(msg => {
      msg.style.background = tutorColor;
      msg.style.color = getContrastColor(tutorColor);
    });
  } else if (themeName !== 'default') {
    previewArea.classList.add(`theme-${themeName}`);
  }
}

// Update theme selection UI
function updateThemeSelection() {
  document.querySelectorAll('.theme-preview').forEach(preview => {
    preview.classList.remove('selected', 'border-blue-500');
    if (preview.dataset.theme === currentChatTheme) {
      preview.classList.add('selected', 'border-blue-500');
    }
  });
}

// Apply theme
function applyTheme(themeName) {
  currentChatTheme = themeName;
  
  // Remove all theme classes
  document.body.classList.remove('theme-ocean', 'theme-sunset', 'theme-forest', 'theme-midnight', 'theme-candy', 'theme-cyber');
  
  // Apply new theme class
  if (themeName === 'custom') {
    const studentColor = document.getElementById('studentColorPicker').value;
    const tutorColor = document.getElementById('tutorColorPicker').value;
    
    // Apply custom colors
    document.documentElement.style.setProperty('--student-chat-bg', studentColor);
    document.documentElement.style.setProperty('--tutor-chat-bg', tutorColor);
    document.documentElement.style.setProperty('--student-chat-text', getContrastColor(studentColor));
    document.documentElement.style.setProperty('--tutor-chat-text', getContrastColor(tutorColor));
  } else if (themeName !== 'default') {
    document.body.classList.add(`theme-${themeName}`);
  }
  
  updateThemeSelection();
  updateChatMessages();
}

// Get contrast color (black or white) based on background
function getContrastColor(hexColor) {
  const r = parseInt(hexColor.substr(1, 2), 16);
  const g = parseInt(hexColor.substr(3, 2), 16);
  const b = parseInt(hexColor.substr(5, 2), 16);
  const brightness = (r * 299 + g * 587 + b * 114) / 1000;
  return brightness > 128 ? '#000000' : '#ffffff';
}

// Reset to default theme
function resetToDefault() {
  applyTheme('default');
  document.getElementById('studentColorPicker').value = '#3b82f6';
  document.getElementById('tutorColorPicker').value = '#f3f4f6';
}

// Save chat theme (with offline fallback)
async function saveChatTheme() {
  try {
    const themeData = {
      userId: loggedInStudentId || 'guest',
      theme: currentChatTheme,
      customColors: currentChatTheme === 'custom' ? {
        studentBg: document.getElementById('studentColorPicker').value,
        tutorBg: document.getElementById('tutorColorPicker').value
      } : null
    };

    // Try to save to server
    const response = await fetchWithAuth(`${API_BASE}/student/save-chat-theme`, {
      method: 'POST',
      body: JSON.stringify(themeData)
    });

    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        showNotification('Theme saved successfully! 🎨', 'success');
        return;
      }
    }
    
    // Fallback to localStorage if server fails
    localStorage.setItem('chatTheme', JSON.stringify(themeData));
    showNotification('Theme saved locally! 💾', 'success');
    
  } catch (error) {
    console.error('Error saving theme:', error);
    
    // Fallback to localStorage
    const themeData = {
      userId: loggedInStudentId || 'guest',
      theme: currentChatTheme,
      customColors: currentChatTheme === 'custom' ? {
        studentBg: document.getElementById('studentColorPicker').value,
        tutorBg: document.getElementById('tutorColorPicker').value
      } : null
    };
    
    localStorage.setItem('chatTheme', JSON.stringify(themeData));
    showNotification('Theme saved locally! 💾', 'success');
  }
}

// Load saved chat theme (with offline fallback)
async function loadSavedChatTheme() {
  const studentId = localStorage.getItem('userId') || 'guest';
  try {
    // Try to load from server first
    const response = await fetchWithAuth(`${API_BASE}/student/get-chat-theme?userId=${encodeURIComponent(studentId)}`);
    
    if (response.ok) {
      const result = await response.json();
      if (result.success && result.theme) {
        const themeData = result.theme;
        
        if (themeData.theme === 'custom' && themeData.customColors) {
          document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
          document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
          applyTheme('custom');
        } else {
          applyTheme(themeData.theme);
        }
        return;
      }
    }
    
    // Fallback to localStorage
    const savedTheme = localStorage.getItem('chatTheme');
    if (savedTheme) {
      const themeData = JSON.parse(savedTheme);
      
      if (themeData.theme === 'custom' && themeData.customColors) {
        document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
        document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
        applyTheme('custom');
      } else {
        applyTheme(themeData.theme);
      }
    }
    
  } catch (error) {
    console.error('Error loading saved theme:', error);
    
    // Try localStorage as final fallback
    try {
      const savedTheme = localStorage.getItem('chatTheme');
      if (savedTheme) {
        const themeData = JSON.parse(savedTheme);
        
        if (themeData.theme === 'custom' && themeData.customColors) {
          document.getElementById('studentColorPicker').value = themeData.customColors.studentBg;
          document.getElementById('tutorColorPicker').value = themeData.customColors.tutorBg;
          applyTheme('custom');
        } else {
          applyTheme(themeData.theme);
        }
      }
    } catch (localError) {
      console.error('Error loading from localStorage:', localError);
    }
  }
}

// Update existing chat messages with new theme
function updateChatMessages() {
  const chatHistory = document.getElementById('chat-history');
  if (chatHistory) {
    // Re-apply classes to existing messages
    chatHistory.querySelectorAll('.student-message, .tutor-message').forEach(msg => {
      // Force re-render by toggling a class
      msg.style.display = 'none';
      setTimeout(() => {
        msg.style.display = 'block';
      }, 10);
    });
  }
}

// Show notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 ${
    type === 'success' ? 'bg-green-500 text-white' : 
    type === 'error' ? 'bg-red-500 text-white' : 
    'bg-blue-500 text-white'
  }`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => {
      if (document.body.contains(notification)) {
        document.body.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Dashboard Background Management
document.addEventListener('DOMContentLoaded', function() {
  loadDashBg();
  loadDashFont();
});

function applyDashFont(type, value) {
  const root = document.documentElement;
  const content = document.getElementById('dashboard-content');
  if (!content) return;

  if (type === 'family') {
    content.style.setProperty('--dash-font-family', value);
    saveDashFont({ family: value });
  } else if (type === 'color') {
    content.style.setProperty('--dash-font-color', value);
    saveDashFont({ color: value });
  }
}

function saveDashFont(data) {
  const saved = JSON.parse(localStorage.getItem('dash_font') || '{}');
  const newData = { ...saved, ...data };
  localStorage.setItem('dash_font', JSON.stringify(newData));
}

function loadDashFont() {
  const saved = localStorage.getItem('dash_font');
  if (saved) {
    const data = JSON.parse(saved);
    if (data.family) {
      applyDashFont('family', data.family);
      document.getElementById('dash-font-family').value = data.family;
    }
    if (data.color) {
      applyDashFont('color', data.color);
      document.getElementById('dash-font-color').value = data.color;
    }
  }
}

function resetDashFont() {
  const content = document.getElementById('dashboard-content');
  if (content) {
    content.style.removeProperty('--dash-font-family');
    content.style.removeProperty('--dash-font-color');
  }
  localStorage.removeItem('dash_font');
  document.getElementById('dash-font-family').value = 'inherit';
  document.getElementById('dash-font-color').value = '#000000';
  showNotification('Fonts reset to default.', 'success');
}

function applyDashBg(type, value) {
  const container = document.getElementById('dash-bg-container');
  if (!container) return;

  container.innerHTML = '';
  container.style.backgroundColor = '';

  // Ensure absolute URL for uploaded backgrounds
  let finalValue = value;
  if (type !== 'color' && value && !value.startsWith('http') && !value.startsWith('data:')) {
    finalValue = `${API_BASE}${value.startsWith('/') ? '' : '/'}${value}`;
  }

  if (type === 'color') {
    container.style.backgroundColor = value;
    saveDashBg({ type, value });
  } else if (type === 'image') {
    const img = document.createElement('img');
    img.src = finalValue;
    container.appendChild(img);
    saveDashBg({ type, value: finalValue });
  } else if (type === 'video') {
    const video = document.createElement('video');
    video.src = finalValue;
    video.autoplay = true;
    video.muted = true;
    video.loop = true;
    video.playsInline = true;
    container.appendChild(video);
    saveDashBg({ type, value: finalValue });
  }

  // Automatically switch to dark theme for better visibility over custom backgrounds
  setTheme('dark');
  // Update radio button UI
  const darkRadio = document.querySelector('input[name="theme"][value="dark"]');
  if (darkRadio) darkRadio.checked = true;
}

async function handleDashBgUpload(input) {
  const file = input.files[0];
  if (!file) return;

  const MAX_SIZE = 100 * 1024 * 1024; // 100MB
  if (file.size > MAX_SIZE) {
    showNotification('File too large! Maximum size is 100MB.', 'error');
    return;
  }

  showNotification('Uploading background...', 'info');

  const formData = new FormData();
  formData.append('background', file);

  try {
    const response = await fetch(`${API_BASE}/upload-background`, {
      method: 'POST',
      body: formData
    });
    const result = await response.json();

    if (result.success) {
      const type = file.type.startsWith('video/') ? 'video' : 'image';
      applyDashBg(type, result.url);
      showNotification('Background updated successfully!', 'success');
    } else {
      throw new Error(result.error || 'Upload failed');
    }
  } catch (error) {
    console.error('Upload error:', error);
    showNotification('Failed to upload background. ' + error.message, 'error');
  }
}

function saveDashBg(data) {
  try {
    localStorage.setItem('dash_background', JSON.stringify(data));
  } catch (e) {
    console.error('Failed to save background to localStorage:', e);
    showNotification('Storage full! Background could not be saved permanently.', 'error');
  }
}

function loadDashBg() {
  const saved = localStorage.getItem('dash_background');
  if (saved) {
    const data = JSON.parse(saved);
    applyDashBg(data.type, data.value);
    if (data.type === 'color') {
      document.getElementById('dash-bg-color').value = data.value;
    }
  }
}

function resetDashBg() {
  const container = document.getElementById('dash-bg-container');
  if (container) {
    container.innerHTML = '';
    container.style.backgroundColor = '';
  }
  localStorage.removeItem('dash_background');
  showNotification('Background reset to default.', 'success');
}

function setTheme(mode) {
  if (mode === 'dark') {
    document.documentElement.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  } else if (mode === 'light') {
    document.documentElement.classList.remove('dark');
    localStorage.setItem('theme', 'light');
  } else {
    // Auto mode: respect system preference
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    if (systemPrefersDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    localStorage.setItem('theme', 'auto');
  }
}

function updateFontSize(size) {
  document.documentElement.style.fontSize = `${size}px`;
  localStorage.setItem('fontSize', size);
  showNotification(`Font size set to ${size}px`, 'success');
}

function resetAllSettings() {
  if (confirm('Are you sure you want to reset all settings to default?')) {
    // Reset theme
    setTheme('light');
    document.querySelector('input[name="theme"][value="light"]').checked = true;
    
    // Reset fonts
    resetDashFont();
    
    // Reset background
    resetDashBg();
    
    // Reset notifications
    document.getElementById('emailNotifications').checked = true;
    document.getElementById('smsNotifications').checked = false;
    document.getElementById('pushNotifications').checked = true;
    document.getElementById('orderNotifications').checked = true;
    
    // Reset privacy settings
    document.getElementById('analyticsTracking').checked = true;
    document.getElementById('personalizedAds').checked = false;
    document.getElementById('twoFactorAuth').checked = false;
    document.getElementById('sessionTimeout').value = '30';
    
    // Reset font size
    document.documentElement.style.fontSize = '16px';
    localStorage.removeItem('fontSize');
    document.getElementById('fontSizeSlider').value = '16';
    
    showNotification('All settings reset to default', 'success');
  }
}

// Load saved settings on page load
document.addEventListener('DOMContentLoaded', function() {
  // Load font size
  const savedFontSize = localStorage.getItem('fontSize');
  if (savedFontSize) {
    document.documentElement.style.fontSize = `${savedFontSize}px`;
    document.getElementById('fontSizeSlider').value = savedFontSize;
  }
  
  // Load notifications settings
  const savedNotifications = localStorage.getItem('notifications');
  if (savedNotifications) {
    const notifications = JSON.parse(savedNotifications);
    document.getElementById('emailNotifications').checked = notifications.email;
    document.getElementById('smsNotifications').checked = notifications.sms;
    document.getElementById('pushNotifications').checked = notifications.push;
    document.getElementById('orderNotifications').checked = notifications.orders;
  }
  
  // Load privacy settings
  const savedPrivacy = localStorage.getItem('privacy');
  if (savedPrivacy) {
    const privacy = JSON.parse(savedPrivacy);
    document.getElementById('analyticsTracking').checked = privacy.analytics;
    document.getElementById('personalizedAds').checked = privacy.ads;
    document.getElementById('twoFactorAuth').checked = privacy.twoFactor;
    document.getElementById('sessionTimeout').value = privacy.sessionTimeout;
  }
});

// Save notifications settings
document.querySelectorAll('#emailNotifications, #smsNotifications, #pushNotifications, #orderNotifications').forEach(checkbox => {
  checkbox.addEventListener('change', function() {
    const notifications = {
      email: document.getElementById('emailNotifications').checked,
      sms: document.getElementById('smsNotifications').checked,
      push: document.getElementById('pushNotifications').checked,
      orders: document.getElementById('orderNotifications').checked
    };
    localStorage.setItem('notifications', JSON.stringify(notifications));
  });
});

// Save privacy settings
document.querySelectorAll('#analyticsTracking, #personalizedAds, #twoFactorAuth, #sessionTimeout').forEach(element => {
  element.addEventListener('change', function() {
    const privacy = {
      analytics: document.getElementById('analyticsTracking').checked,
      ads: document.getElementById('personalizedAds').checked,
      twoFactor: document.getElementById('twoFactorAuth').checked,
      sessionTimeout: document.getElementById('sessionTimeout').value
    };
    localStorage.setItem('privacy', JSON.stringify(privacy));
  });
});

// Add CSS for preview messages
const previewStyles = document.createElement('style');
previewStyles.textContent = `
  .preview-student-message {
    background: var(--student-chat-bg, #3b82f6) !important;
    color: var(--student-chat-text, #ffffff) !important;
    border-radius: var(--chat-border-radius, 1rem) !important;
    box-shadow: var(--chat-shadow, 0 2px 8px rgba(0,0,0,0.1)) !important;
    margin-left: auto;
    max-width: 70%;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
  }

  .preview-tutor-message {
    background: var(--tutor-chat-bg, #f3f4f6) !important;
    color: var(--tutor-chat-text, #1f2937) !important;
    border-radius: var(--chat-border-radius, 1rem) !important;
    box-shadow: var(--chat-shadow, 0 2px 8px rgba(0,0,0,0.1)) !important;
    margin-right: auto;
    max-width: 70%;
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
  }
`;
document.head.appendChild(previewStyles);
</script>

</body>
</html>
